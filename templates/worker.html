{% extends "base.html" %}
<!DOCTYPE html>
<html>
<head>
  <title>Trabajador</title>
  <link  href="/static/styles/output.css" rel="stylesheet">
  <style>
    /* Estilos para el popover superpuesto */
 

    /* Animaci√≥n de entrada */
    @keyframes popoverScaleIn {
      from {
        opacity: 0;
        transform: scale(0.9);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }

  </style>
</head>
<body>
  {% block content %}
  <!-- Overlay para cerrar el popover -->
  <div id="popover-overlay" class="popover-overlay hidden"></div>

  <div class="grilla-mesas">
    {% for m in mesas %}
      {% set estado_mesa = 'libre' %}
      {% if m.reservada and not m.is_occupied %}
        {% set estado_mesa = 'reservada' %}
      {% elif m.reservada and m.is_occupied %}
        {% set estado_mesa = 'reservada-ocupada' %}
      {% elif m.is_occupied and m.recien_asignada %}
        {% set estado_mesa = 'recien-asignada' %}
      {% elif m.is_occupied %}
        {% set estado_mesa = 'ocupada' %}
      {% endif %}

      <div class="mesa {{ estado_mesa }}" id="mesa-{{ m.id }}" data-mesa-id="{{ m.id }}" data-estado="{{ estado_mesa }}" data-reservada="{{ m.reservada|lower }}" data-capacidad="{{ m.capacidad }}">
        <div class="mesa-header">
          <div class="mesa-info">
            <div class="mesa-icon-container">
              {% if m.reservada and not m.is_occupied %}
                <i class="fas fa-calendar-check mesa-icon text-white"></i>
              {% elif m.reservada and m.is_occupied %}
                <i class="fas fa-calendar-times mesa-icon text-white"></i>
              {% elif m.is_occupied and m.recien_asignada %}
                <i class="fas fa-clock mesa-icon text-white"></i>
              {% elif m.is_occupied %}
                <i class="fas fa-user-clock mesa-icon text-white"></i>
              {% else %}
                <i class="fas fa-utensils mesa-icon text-white"></i>
              {% endif %}
            </div>
            <div>
              <h3 class="mesa-title">
                Mesa #{{ m.id }}
                <span class="capacidad-mobile cap-{{ m.capacidad }}">üë• {{ m.capacidad }}p</span>
              </h3>
              <p class="mesa-status">
                {% if m.reservada and not m.is_occupied %}
                  Reservada
                {% elif m.reservada and m.is_occupied %}
                  Reservada - Ocupada
                {% elif m.is_occupied and m.recien_asignada %}
                  Reci√©n asignada
                {% elif m.is_occupied %}
                  Ocupada
                {% else %}
                  Disponible
                {% endif %}
              </p>
            </div>
          </div>
        </div>

        <div class="mesa-content">
          {% if m.is_occupied %}
            <div class="mesa-info-row">
              <i class="fas fa-user mesa-info-icon"></i>
              <span>{{ m.cliente.nombre if m.cliente else 'Cliente sin nombre' }}</span>
            </div>
            <div class="mesa-info-row">
              <i class="fas fa-users mesa-info-icon"></i>
              <span>{{ m.cliente.cantidad_comensales if m.cliente else '0' }} comensales</span>
            </div>
            <div class="mesa-info-row">
              <i class="fas fa-stopwatch mesa-info-icon"></i>
              <span id="timer-{{ m.id }}" data-start-timestamp="{{ datetime_to_js_timestamp(m.start_time) if m.start_time else '' }}" class="font-semibold text-card_text">
                calculando...
              </span>
            </div>
            {% if m.reservada %}
            <div class="mesa-info-row">
              <i class="fas fa-bookmark mesa-info-icon"></i>
              <span style="color: #8B5CF6;">Mesa Reservada</span>
            </div>
            {% endif %}
          {% else %}
            <div class="mesa-info-row">
              <i class="fas fa-clock mesa-info-icon"></i>
              <span>{% if m.reservada %}Reservada - Lista{% else %}Lista para usar{% endif %}</span>
            </div>
            <div class="mesa-info-row">
              <i class="fas fa-users mesa-info-icon"></i>
              <span>Capacidad: {{ m.capacidad }} personas</span>
            </div>
            {% if m.reservada %}
            <div class="mesa-info-row">
              <i class="fas fa-bookmark mesa-info-icon"></i>
              <span style="color: #8B5CF6;">Mesa Reservada</span>
            </div>
            {% endif %}
          {% endif %}
        </div>
      </div>
    {% endfor %}
  </div>

  <h2>Estad√≠sticas</h2>
  <p id="promedio">Calculando...</p>
  {% endblock %}

    {% block scripts %}

  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <script>

    const socket = io();

    socket.on('actualizar_cola', () => {
      // Llamamos a la API para obtener la lista actualizada de clientes
      fetch('/clientes')
        .then(res => res.json())
        .then(data => {
          const ul = document.querySelector('#clientes-lista');
          ul.innerHTML = '';
          data.forEach(c => {
            const li = document.createElement('li');
            li.textContent = `Cliente #${c.id} (desde ${c.joined_at})`;
            ul.appendChild(li);
          });
        });
    });

    // Escuchar eventos de actualizaci√≥n de mesas
    socket.on('actualizar_mesas', () => {
      fetch(window.location.href)
        .then(response => response.text())
        .then(html => {
          const parser = new DOMParser();
          const doc = parser.parseFromString(html, 'text/html');
          const nuevaGrillaMesas = doc.querySelector('.grilla-mesas');
          const grillaActual = document.querySelector('.grilla-mesas');
          
          // Limpiar los temporizadores existentes
          document.querySelectorAll('[id^="timer-"]').forEach(timer => {
            const mesaId = timer.id.split('-')[1];
            clearInterval(window['timerInterval-' + mesaId]);
          });
          
          grillaActual.innerHTML = nuevaGrillaMesas.innerHTML;

          // Reinicializar los event listeners de las mesas
          inicializarMesas();

          // Reinicializar los temporizadores para las mesas ocupadas
          document.querySelectorAll('.mesa').forEach(mesa => {
            const mesaId = mesa.id.split('-')[1];
            const startTimestampElement = mesa.querySelector('[data-start-timestamp]');
            if (startTimestampElement && mesa.classList.contains('ocupada')) {
              iniciarTemporizador(mesaId, startTimestampElement.dataset.startTimestamp);
            }
          });
        });
    });

    // Escuchar evento de cliente que necesita m√∫ltiples mesas
    socket.on('cliente_necesita_multiples_mesas', (data) => {
      mostrarNotificacionMultiplesMesas(data);
    });


    function mostrarNotificacionMultiplesMesas(data) {
      // Crear una notificaci√≥n modal para m√∫ltiples mesas
      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.8);
        z-index: 9999;
        display: flex;
        align-items: center;
        justify-content: center;
      `;
      
      const contenido = document.createElement('div');
      contenido.style.cssText = `
        background: white;
        padding: 30px;
        border-radius: 15px;
        max-width: 500px;
        text-align: center;
        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      `;
      
      contenido.innerHTML = `
        <h3 style="color: #e74c3c; margin-bottom: 20px;">‚ö†Ô∏è Cliente Necesita M√∫ltiples Mesas</h3>
        <p style="margin-bottom: 15px;"><strong>Cliente:</strong> ${data.cliente_nombre}</p>
        <p style="margin-bottom: 15px;"><strong>Comensales:</strong> ${data.cantidad_comensales}</p>
        <p style="margin-bottom: 20px;"><strong>Mesas reservadas:</strong> ${data.mesas_reservadas.join(', ')}</p>
        <div style="display: flex; gap: 10px; justify-content: center;">
          <button onclick="asignarClienteMultiple(${data.cliente_id})" 
                  style="background: #27ae60; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
            ‚úÖ Asignar Mesas
          </button>
          <button onclick="cerrarModal()" 
                  style="background: #95a5a6; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
            ‚ùå Cancelar
          </button>
        </div>
      `;
      
      modal.appendChild(contenido);
      document.body.appendChild(modal);
      
      // Guardar referencia para poder cerrar
      window.modalActual = modal;
    }
    
    function cerrarModal() {
      if (window.modalActual) {
        document.body.removeChild(window.modalActual);
        window.modalActual = null;
      }
    }

    function cambiarCapacidad(mesaId) {
      const nuevaCapacidad = prompt("Ingresa la nueva capacidad para esta mesa (1-20 personas):");
      
      if (nuevaCapacidad === null) return; // Usuario cancel√≥
      
      const capacidad = parseInt(nuevaCapacidad);
      if (isNaN(capacidad) || capacidad < 1 || capacidad > 20) {
        alert("Por favor ingresa un n√∫mero v√°lido entre 1 y 20");
        return;
      }
      
      fetch(`/cambiar_capacidad/${mesaId}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ capacidad: capacidad })
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          // Cerrar el popover
          document.getElementById('popover-overlay').click();
        } else {
          alert(`Error: ${data.error}`);
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('Error al cambiar la capacidad');
      });
    }

    function mostrarOrden(mesaId) {
      // Obtener la orden actual de la mesa
      fetch(`/obtener_orden/${mesaId}`)
        .then(res => res.json())
        .then(data => {
          // Crear modal para mostrar/editar la orden
          const modal = document.createElement('div');
          modal.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
          `;
          
          const contenido = document.createElement('div');
          contenido.style.cssText = `
            background: white;
            padding: 24px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            max-height: 80%;
            overflow-y: auto;
          `;
          
          contenido.innerHTML = `
            <h3 style="margin-bottom: 16px; font-size: 18px; font-weight: bold; color: #333;">
              üìù Orden - Mesa #${mesaId}
            </h3>
            <textarea 
              id="orden-textarea" 
              placeholder="Escriba aqu√≠ la orden de los comensales..."
              style="
                width: 100%;
                height: 200px;
                padding: 12px;
                border: 2px solid #e5e7eb;
                border-radius: 8px;
                resize: vertical;
                font-family: Arial, sans-serif;
                font-size: 14px;
                line-height: 1.5;
              "
            >${data.orden || ''}</textarea>
            <div style="display: flex; gap: 8px; margin-top: 16px;">
              <button onclick="guardarOrden(${mesaId})" style="
                flex: 1;
                background: #10b981;
                color: white;
                border: none;
                padding: 12px;
                border-radius: 8px;
                font-weight: bold;
                cursor: pointer;
              ">
                üíæ Guardar
              </button>
              <button onclick="cerrarModal()" style="
                flex: 1;
                background: #6b7280;
                color: white;
                border: none;
                padding: 12px;
                border-radius: 8px;
                font-weight: bold;
                cursor: pointer;
              ">
                ‚ùå Cancelar
              </button>
            </div>
          `;
          
          modal.appendChild(contenido);
          document.body.appendChild(modal);
          
          // Guardar referencia del modal
          window.modalActual = modal;
          
          // Enfocar el textarea
          document.getElementById('orden-textarea').focus();
        })
        .catch(error => {
          console.error('Error:', error);
          alert('Error al cargar la orden');
        });
    }

    function guardarOrden(mesaId) {
      const orden = document.getElementById('orden-textarea').value;
      
      fetch(`/guardar_orden/${mesaId}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ orden: orden })
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          cerrarModal();
          alert('Orden guardada exitosamente');
        } else {
          alert(`Error: ${data.error}`);
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('Error al guardar la orden');
      });
    }

    function asignarClienteMultiple(clienteId) {
      fetch(`/asignar_cliente_multiple/${clienteId}`, { 
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        }
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          cerrarModal();
          // Mostrar confirmaci√≥n
          alert(`Cliente asignado exitosamente a las mesas: ${data.mesas_totales.join(', ')}`);
        } else {
          alert(`Error: ${data.error}`);
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('Error al asignar cliente');
      });
    }

    function accionMesa(mesaId, ocupada) {
      const mensaje = ocupada=="ocupada" ? 
        "¬øEst√°s seguro de que deseas desocupar esta mesa?" : 
        "¬øEst√°s seguro de que deseas ocupar esta mesa manualmente?";

      if (confirm(mensaje)) {
        if (ocupada=="ocupada") {
          fetch(`/liberar_mesa/${mesaId}`, { method: 'POST' })
            .then(res => res.json())
            .then(() => {
              location.reload();
            });
        } else {
          fetch(`/ocupar_mesa/${mesaId}`, { method: 'POST' })
            .then(res => res.json())
            .then(() => {
              location.reload();
            });
        }
      }
    }

    function llegoComensal(mesaId) {
        fetch(`/confirmar_llegada/${mesaId}`, { method: 'POST' })
          .then(res => res.json())
          .then(data => {
            if (data.success) {
              // Actualizar la mesa a "ocupada"
              const mesaElement = document.getElementById(`mesa-${mesaId}`);
              mesaElement.classList.remove('recien-asignada');
              mesaElement.classList.add('ocupada');
              mesaElement.dataset.estado = 'ocupada';
              
              // Actualizar el √≠cono
              const mesaIcon = mesaElement.querySelector('.mesa-icon');
              if (mesaIcon) {
                mesaIcon.classList.remove('fa-clock');
                mesaIcon.classList.add('fa-user-clock');
              }
              
              // Actualizar el texto de estado
              const statusText = mesaElement.querySelector('.mesa-status');
              if (statusText) {
                statusText.textContent = 'Ocupada';
              }

              // Cerrar el popover y overlay
              hidePopover();
            }
          });

    }
        function reservarMesa(mesaId) {
      fetch(`/reservar_mesa/${mesaId}`, { method: 'POST' })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            // Actualizar la mesa a "reservada"
            const mesaElement = document.getElementById(`mesa-${mesaId}`);
            mesaElement.classList.add('reservada');
            mesaElement.dataset.estado = 'reservada';
            
            // Actualizar el √≠cono
            const mesaIcon = mesaElement.querySelector('.mesa-icon');
            if (mesaIcon) {
              mesaIcon.classList.remove('fa-utensils');
              mesaIcon.classList.add('fa-calendar-check');
            }
            
            // Actualizar el texto de estado
            const statusText = mesaElement.querySelector('.mesa-status');
            if (statusText) {
              statusText.textContent = 'Reservada';
            }

            // Cerrar el popover y overlay
            hidePopover();
          }
        });
    }

    function cancelarReserva(mesaId) {
      fetch(`/cancelar_reserva/${mesaId}`, { method: 'POST' })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            // Actualizar la mesa a "libre"
            const mesaElement = document.getElementById(`mesa-${mesaId}`);
            mesaElement.classList.remove('reservada');
            mesaElement.classList.remove('ocupada');
            mesaElement.dataset.estado = 'libre';
            
            // Actualizar el √≠cono
            const mesaIcon = mesaElement.querySelector('.mesa-icon');
            if (mesaIcon) {
              mesaIcon.classList.remove('fa-calendar-check');
              mesaIcon.classList.add('fa-utensils');
            }
            
            // Actualizar el texto de estado
            const statusText = mesaElement.querySelector('.mesa-status');
            if (statusText) {
              statusText.textContent = 'Disponible';
            }

            // Cerrar el popover y overlay
            hidePopover();
          }
        });
    }

    document.querySelectorAll('.btn-accion').forEach(btn => {
      btn.addEventListener('click', () => {
        const id = btn.dataset.mesaId;
        const ocupada = btn.dataset.ocupada === 'true';
        accionMesa(id, ocupada);
      });
    });

    horas_minutos_segundos = (totalSegundos) => {
      // Convertir a minutos y segundos
      const minutos = Math.floor(totalSegundos / 60);
      const segundos = totalSegundos % 60;
      const horas = Math.floor(minutos / 60);

      if (horas > 0) {
        return `${horas} hr${horas > 1 ? 's' : ''} ${minutos % 60} min${minutos > 1 ? 's' : ''}`;
      }
      else if (minutos > 0) {
        return `${minutos} min${minutos > 1 ? 's' : ''} `;
      }
      else if(horas==0&&minutos==0){
        return `${totalSegundos} segundos`;
      }
      return '';}

    function actualizarEstadisticas() {
      fetch('/estadisticas')
        .then(res => res.json())
        .then(data => {
      const totalSegundos = Math.round(data.promedio_tiempo_uso);

      // Convertir a minutos y segundos
      const minutos = Math.floor(totalSegundos / 60);
      const segundos = totalSegundos % 60;
      const horas = Math.floor(minutos / 60);

      let texto = "Promedio tiempo de uso de mesas: ";
      if (horas > 0) {
        texto += `${horas} hora${horas > 1 ? 's' : ''} ${minutos % 60} minuto${minutos > 1 ? 's' : ''}`;
      }
      else if (minutos > 0) {
        texto += `${minutos} minuto${minutos > 1 ? 's' : ''} `;
      }
      else if(horas==0&&minutos==0){
        document.getElementById("promedio").innerText =segundos + " segundos";
      }
  
      document.getElementById("promedio").innerText = texto;
        });

    }

    function limpiarTemporizador(mesaId) {
      const intervalId = window['timerInterval-' + mesaId];
      if (intervalId) {
        clearInterval(intervalId);
        delete window['timerInterval-' + mesaId];
      }
    }

    function iniciarTemporizador(mesaId, startTimestamp) {
      if (!startTimestamp) return; // Si no hay timestamp de inicio, no iniciar el temporizador
      
      // Primero limpiar cualquier temporizador existente
      limpiarTemporizador(mesaId);
      
      const startTime = new Date(parseInt(startTimestamp)); // Convertir timestamp a Date
      const mesaElement = document.getElementById(`mesa-${mesaId}`);
      const timerElement = document.getElementById(`timer-${mesaId}`);
      
      if (!timerElement) return; // Si no existe el elemento del timer, no continuar
      
      // Debug: mostrar informaci√≥n en consola
      console.log(`Iniciando temporizador para mesa ${mesaId}:`, {
        timestamp: startTimestamp,
        startTime: startTime,
        now: new Date()
      });
      
      function actualizar() {
        const ahora = new Date();
        const segundos = Math.floor((ahora - startTime) / 1000);
        
        // Actualizar el temporizador del tiempo de uso
        if (timerElement) {
            timerElement.innerText = `${horas_minutos_segundos(segundos)}`;
        }
        
        // Si la mesa est√° reci√©n asignada, actualizar la cuenta regresiva
        if (mesaElement && mesaElement.classList.contains('recien-asignada')) {
          const countdownElement = document.getElementById(`countdown-${mesaId}`);
          if (countdownElement) {
            const segundosRestantes = 300 - segundos; // 5 minutos = 300 segundos
            if (segundosRestantes > 0) {
              const minutos = Math.floor(segundosRestantes / 60);
              const segs = segundosRestantes % 60;
              countdownElement.innerText = `${minutos}:${segs.toString().padStart(2, '0')}`;
            }
          }

            // Cambiar de reci√©n asignada a ocupada despu√©s de 5 minutos
            const tiempo_espera = 300;
          if (segundos >= tiempo_espera) {
            llegoComensal(mesaId);
          }
        }
      }
      
      // Guardar la referencia del intervalo para poder limpiarlo despu√©s
      window['timerInterval-' + mesaId] = setInterval(actualizar, 1000);
      actualizar();
    }

    {% for m in mesas %}
      {% if m.is_occupied and m.start_time %}
        iniciarTemporizador({{ m.id }}, "{{ datetime_to_js_timestamp(m.start_time) }}");
      {% endif %}
    {% endfor %}

    setInterval(actualizarEstadisticas, 5000);
    actualizarEstadisticas();

    // NUEVA IMPLEMENTACI√ìN DE POPOVER SUPERPUESTO
    let activePopover = null;

    function createPopover(mesaId, estado) {
      const popover = document.createElement('div');
      popover.className = 'mesa-popover';
      popover.id = `popover-${mesaId}`;
      
      let buttons = '';
      if (estado === 'libre') {
        buttons = `
          <button onclick="reservarMesa(${mesaId})" class="w-full bg-blue-50 hover:bg-blue-100 text-blue-700 rounded-lg transition-colors border border-blue-200">
            ‚úÖ Reservar
          </button>
          <button onclick="accionMesa(${mesaId}, '${estado}')" class="w-full bg-green-50 hover:bg-green-100 text-green-700 rounded-lg transition-colors border border-green-200">
            üë• Ocupar
          </button>
          <button onclick=\"ocuparDosOMas(${mesaId})\" class=\"w-full bg-teal-50 hover:bg-teal-100 text-teal-700 rounded-lg transition-colors border border-teal-200\">\n            üë• Ocupar 2+\n          </button>
          <button onclick="cambiarCapacidad(${mesaId})" class="w-full bg-purple-50 hover:bg-purple-100 text-purple-700 rounded-lg transition-colors border border-purple-200">
            üë• Cambiar Capacidad
          </button>
        `;
    } else if (estado === 'ocupada') {
        buttons = `
          <button onclick="mostrarOrden(${mesaId})" class="w-full bg-yellow-50 hover:bg-yellow-100 text-yellow-700 rounded-lg transition-colors border border-yellow-200">
            üìù Orden
          </button>
          <button onclick="accionMesa(${mesaId}, '${estado}')" class="w-full bg-orange-50 hover:bg-orange-100 text-orange-700 rounded-lg transition-colors border border-orange-200">
            ‚èØÔ∏è Desocupar
          </button>
      <button onclick="desocuparYReservar(${mesaId})" class="w-full bg-red-50 hover:bg-red-100 text-red-700 rounded-lg transition-colors border border-red-200">
            üîì Des. y Reservar
          </button>
        `;
      } else if (estado === 'recien-asignada') {
        buttons = `
          <button onclick="llegoComensal(${mesaId})" class="w-full bg-green-50 hover:bg-green-100 text-green-700 rounded-lg transition-colors border border-green-200">
            ‚ú® Lleg√≥
          </button>
        `;
      }  else if (estado === 'reservada') {
        buttons = `
          <button onclick="cancelarReserva(${mesaId})" class="w-full bg-red-50 hover:bg-red-100 text-red-700 rounded-lg transition-colors border border-red-200">
            ‚ùå Cancelar
          </button>
          <button onclick="accionMesa(${mesaId},'libre')" class="w-full bg-green-50 hover:bg-green-100 text-green-700 rounded-lg transition-colors border border-green-200">
            üë• Ocupar
          </button>
          <button onclick="cambiarCapacidad(${mesaId})" class="w-full bg-purple-50 hover:bg-purple-100 text-purple-700 rounded-lg transition-colors border border-purple-200">
            üë• Cambiar Capacidad
          </button>
        `;
      } else if (estado === 'reservada-ocupada') {
        buttons = `
          <button onclick="mostrarOrden(${mesaId})" class="w-full bg-yellow-50 hover:bg-yellow-100 text-yellow-700 rounded-lg transition-colors border border-yellow-200">
            üìù Orden
          </button>
          <button onclick="desocuparYCancelar(${mesaId})" class="w-full bg-red-50 hover:bg-red-100 text-red-700 rounded-lg transition-colors border border-red-200">
            ‚ùå Desocupar y Cancelar
          </button>
          <button onclick="accionMesa(${mesaId},'ocupada')" class="w-full bg-green-50 hover:bg-green-100 text-green-700 rounded-lg transition-colors border border-green-200">
            üë• Desocupar Mesa
          </button>
        `;
      }

      popover.innerHTML = buttons;
      return popover;
    }

    function positionPopover(popover, mesaElement) {
      const mesaRect = mesaElement.getBoundingClientRect();
      
      // Calcular el tama√±o del popover como porcentaje del elemento mesa
      const popoverWidth = mesaRect.width * 0.85;
      const popoverHeight = mesaRect.height * 0.7;
      
      // Establecer el tama√±o del popover
      popover.style.width = `${popoverWidth}px`;
      popover.style.height = `${popoverHeight}px`;
      
      // Centrar el popover sobre el elemento mesa
      const left = mesaRect.left + window.scrollX + (mesaRect.width - popoverWidth) / 2;
      const top = mesaRect.top + window.scrollY + (mesaRect.height - popoverHeight) / 2;
      
      popover.style.top = `${top}px`;
      popover.style.left = `${left}px`;
    }

    function showPopover(mesaId, estado, mesaElement) {
      const overlay = document.getElementById('popover-overlay');
      
      // Si ya hay un popover activo, cerrarlo
      if (activePopover) {
        hidePopover();
      }
      
      // Crear y mostrar el nuevo popover
      const popover = createPopover(mesaId, estado);
      document.body.appendChild(popover);
      
      // Posicionar el popover
      positionPopover(popover, mesaElement);
      
      // Mostrar overlay y popover
      overlay.classList.remove('hidden');
      
      // Usar requestAnimationFrame para asegurar que el DOM se actualice
      requestAnimationFrame(() => {
        popover.classList.add('show');
      });
      
      activePopover = popover;

      // Prevenir propagaci√≥n de clicks dentro del popover
      popover.addEventListener('click', (e) => {
        e.stopPropagation();
      });
    }

    function hidePopover() {
      if (activePopover) {
        const overlay = document.getElementById('popover-overlay');
        
        activePopover.classList.remove('show');
        overlay.classList.add('hidden');
        
        // Remover el popover despu√©s de la animaci√≥n
        setTimeout(() => {
          if (activePopover && activePopover.parentNode) {
            activePopover.parentNode.removeChild(activePopover);
          }
          activePopover = null;
        }, 300);
      }
    }

    // ---- Ocupaci√≥n de m√∫ltiples mesas desde estado libre ----
    function ocuparDosOMas(mesaPrincipalId) {
      // Construir una lista de mesas libres para seleccionar adicionales
      const todasMesas = Array.from(document.querySelectorAll('.mesa'));
      const libres = todasMesas.filter(m => m.dataset.estado === 'libre' && parseInt(m.dataset.mesaId) !== mesaPrincipalId);

      if (libres.length === 0) {
        // Nada para elegir, simplemente ocupar la mesa principal como fallback
        accionMesa(mesaPrincipalId, 'libre');
        return;
      }

      // Crear un modal simple de selecci√≥n
      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 10000;
        display: flex; align-items: center; justify-content: center;`;
      const box = document.createElement('div');
      box.style.cssText = `background: #fff; border-radius: 12px; width: 90%; max-width: 480px; padding: 16px;`;

      let opciones = libres.map(m => {
        const id = m.dataset.mesaId;
        const cap = m.getAttribute('data-capacidad');
        return `<label style="display:flex;align-items:center;gap:8px;margin:6px 0;">
                  <input type="checkbox" value="${id}" />
                  <span>Mesa #${id} (cap. ${cap})</span>
                </label>`;
      }).join('');

      box.innerHTML = `
        <h3 style="font-weight:700;margin-bottom:8px;">Selecciona mesas adicionales</h3>
        <div style="max-height:260px;overflow:auto; margin: 8px 0;">
          ${opciones}
        </div>
        <div style="display:flex; gap:8px; justify-content:flex-end; margin-top: 12px;">
          <button id="cancelar-ocupar-2" class="bg-gray-200 hover:bg-gray-300 text-gray-800 py-2 px-4 rounded-lg">Cancelar</button>
          <button id="confirmar-ocupar-2" class="bg-teal-600 hover:bg-teal-700 text-white py-2 px-4 rounded-lg">Confirmar</button>
        </div>`;

      modal.appendChild(box);
      document.body.appendChild(modal);

      document.getElementById('cancelar-ocupar-2').onclick = () => {
        document.body.removeChild(modal);
      };
      document.getElementById('confirmar-ocupar-2').onclick = () => {
        const seleccionadas = Array.from(box.querySelectorAll('input[type="checkbox"]:checked')).map(i => parseInt(i.value));
        // Hacer POST al backend
        fetch('/ocupar_multiples_mesas', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ mesa_principal: mesaPrincipalId, mesas_adicionales: seleccionadas })
        })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            // Cerrar todo y refrescar UI (socket actualizar√°)
            try { document.body.removeChild(modal); } catch {}
            hidePopover();
          } else {
            alert(data.error || 'No se pudo ocupar m√∫ltiples mesas');
          }
        })
        .catch(err => {
          console.error('Error ocupar_multiples_mesas:', err);
          alert('Error de red al ocupar m√∫ltiples mesas');
        });
      };
    }

    // Funci√≥n para inicializar los event listeners de las mesas
    function inicializarMesas() {
      document.querySelectorAll('.mesa').forEach(mesa => {
        mesa.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          
          const mesaId = mesa.dataset.mesaId;
          const estado = mesa.dataset.estado;
          showPopover(mesaId, estado, mesa);
        });
      });
    }

    // Inicializar los event listeners cuando se carga la p√°gina
    inicializarMesas();

    // Cerrar el popover cuando se hace clic en el overlay
    document.getElementById('popover-overlay').addEventListener('click', hidePopover);

    // Cerrar popover al cambiar orientaci√≥n (m√≥viles)
    window.addEventListener('orientationchange', () => {
      if (activePopover) {
        hidePopover();
      }
    });

    function desocuparMesa(mesaId) {
      fetch(`/liberar_mesa/${mesaId}`, { method: 'POST' })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            hidePopover();
          }
        });
    }

    function desocuparYCancelar(mesaId){
      fetch(`/desocupar_y_cancelar/${mesaId}`, { method: 'POST' })
        .then(res => res.json())
        .then(data => {
          if(data.success){
            limpiarTemporizador(mesaId);
            const mesaElement = document.getElementById(`mesa-${mesaId}`);
            if(mesaElement){
              // Si se reasign√≥ autom√°ticamente, el refresh por socket actualizar√°.
              if(!data.asignada){
                mesaElement.classList.remove('ocupada','reservada','reservada-ocupada','recien-asignada');
                mesaElement.dataset.estado = 'libre';
                const icon = mesaElement.querySelector('.mesa-icon');
                if(icon){
                  icon.classList.remove('fa-user-clock','fa-calendar-times','fa-calendar-check','fa-clock');
                  icon.classList.add('fa-utensils');
                }
                const statusText = mesaElement.querySelector('.mesa-status');
                if(statusText){ statusText.textContent = 'Disponible'; }
              }
            }
            hidePopover();
          } else {
            alert(`Error: ${data.error || 'No se pudo desocupar y cancelar'}`);
          }
        })
        .catch(err => {
          console.error('Error desocupar_y_cancelar:', err);
          alert('Error de red al desocupar y cancelar');
        });
    }

    function desocuparYReservar(mesaId){
      fetch(`/desocupar_y_reservar/${mesaId}`, { method: 'POST' })
        .then(res => res.json())
        .then(data => {
          if(data.success){
            // Limpiar temporizador si exist√≠a
            limpiarTemporizador(mesaId);
            // Actualizar UI localmente a 'reservada'
            const mesaElement = document.getElementById(`mesa-${mesaId}`);
            if(mesaElement){
              mesaElement.classList.remove('ocupada','recien-asignada');
              mesaElement.classList.add('reservada');
              mesaElement.dataset.estado = 'reservada';
              const icon = mesaElement.querySelector('.mesa-icon');
              if(icon){
                icon.classList.remove('fa-user-clock','fa-clock');
                icon.classList.add('fa-calendar-check');
              }
              const statusText = mesaElement.querySelector('.mesa-status');
              if(statusText){ statusText.textContent = 'Reservada'; }
            }
            hidePopover();
          } else {
            alert(`Error: ${data.error || 'No se pudo desocupar y reservar'}`);
          }
        })
        .catch(err => {
          console.error('Error desocupar_y_reservar:', err);
          alert('Error de red al desocupar y reservar');
        });
    }

  </script>
  {% endblock %}
  
</body>
</html>