{% extends "base.html" %}
<!DOCTYPE html>
<html>
<head>
  <title>Trabajador</title>
  <link  href="/static/styles/output.css" rel="stylesheet">
</head>
<body>
  {% block content %}
  <!-- Overlay para cerrar el popover -->
  <div id="popover-overlay" class="popover-overlay hidden"></div>

  <div class="grilla-mesas">
    {% for m in mesas %}
      {% set estado_mesa = 'libre' %}
      {% if m.reservada and not m.is_occupied %}
        {% set estado_mesa = 'reservada' %}
      {% elif m.reservada and m.is_occupied %}
        {% set estado_mesa = 'reservada-ocupada' %}
      {% elif m.is_occupied and m.recien_asignada %}
        {% set estado_mesa = 'recien-asignada' %}
      {% elif m.is_occupied %}
        {% set estado_mesa = 'ocupada' %}
      {% endif %}

      <div class="mesa {{ estado_mesa }}" id="mesa-{{ m.id }}" data-mesa-id="{{ m.id }}" data-estado="{{ estado_mesa }}" data-reservada="{{ m.reservada|lower }}">
        <div class="mesa-header">
          <div class="mesa-info">
            <div class="mesa-icon-container">
              {% if m.reservada and not m.is_occupied %}
                <i class="fas fa-calendar-check mesa-icon text-white"></i>
              {% elif m.reservada and m.is_occupied %}
                <i class="fas fa-calendar-times mesa-icon text-white"></i>
              {% elif m.is_occupied and m.recien_asignada %}
                <i class="fas fa-clock mesa-icon text-white"></i>
              {% elif m.is_occupied %}
                <i class="fas fa-user-clock mesa-icon text-white"></i>
              {% else %}
                <i class="fas fa-utensils mesa-icon text-white"></i>
              {% endif %}
            </div>
            <div>
              <h3 class="mesa-title">Mesa #{{ m.id }}</h3>
              <p class="mesa-status">
                {% if m.reservada and not m.is_occupied %}
                  Reservada
                {% elif m.reservada and m.is_occupied %}
                  Reservada - Ocupada
                {% elif m.is_occupied and m.recien_asignada %}
                  Recién asignada
                {% elif m.is_occupied %}
                  Ocupada
                {% else %}
                  Disponible
                {% endif %}
              </p>
            </div>
          </div>
          <div class="mesa-indicator"></div>
        </div>

        <div class="mesa-content">
          {% if m.is_occupied %}
            <div class="mesa-info-row">
              <i class="fas fa-user mesa-info-icon"></i>
              <span>{{ m.cliente.nombre if m.cliente else 'Cliente sin nombre' }}</span>
            </div>
            <div class="mesa-info-row">
              <i class="fas fa-users mesa-info-icon"></i>
              <span>{{ m.cliente.cantidad_comensales if m.cliente else '0' }} comensales</span>
            </div>
            <div class="mesa-info-row">
              <i class="fas fa-stopwatch mesa-info-icon"></i>
              <span>Tiempo: </span>
              <span id="timer-{{ m.id }}" data-start-time="{{ m.start_time.isoformat() if m.start_time else '' }}" class="font-semibold text-card_text">
                calculando...
              </span>
            </div>
            {% if m.reservada %}
            <div class="mesa-info-row">
              <i class="fas fa-bookmark mesa-info-icon"></i>
              <span style="color: #8B5CF6;">Mesa Reservada</span>
            </div>
            {% endif %}
          {% else %}
            <div class="mesa-info-row">
              <i class="fas fa-clock mesa-info-icon"></i>
              <span>{% if m.reservada %}Reservada - Lista{% else %}Lista para usar{% endif %}</span>
            </div>
            <div class="mesa-info-row">
              <i class="fas fa-users mesa-info-icon"></i>
              <span>Capacidad: 4 personas</span>
            </div>
            {% if m.reservada %}
            <div class="mesa-info-row">
              <i class="fas fa-bookmark mesa-info-icon"></i>
              <span style="color: #8B5CF6;">Reservada</span>
            </div>
            {% endif %}
          {% endif %}
        </div>
      </div>
    {% endfor %}
  </div>

  <h2>Estadísticas</h2>
  <p id="promedio">Calculando...</p>
  {% endblock %}

    {% block scripts %}


  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <script>

    const socket = io();

    socket.on('actualizar_cola', () => {
      // Llamamos a la API para obtener la lista actualizada de clientes
      fetch('/clientes')
        .then(res => res.json())
        .then(data => {
          const ul = document.querySelector('#clientes-lista');
          ul.innerHTML = '';
          data.forEach(c => {
            const li = document.createElement('li');
            li.textContent = `Cliente #${c.id} (desde ${c.joined_at})`;
            ul.appendChild(li);
          });
        });
    });

    // Escuchar eventos de actualización de mesas
    socket.on('actualizar_mesas', () => {
      fetch(window.location.href)
        .then(response => response.text())
        .then(html => {
          const parser = new DOMParser();
          const doc = parser.parseFromString(html, 'text/html');
          const nuevaGrillaMesas = doc.querySelector('.grilla-mesas');
          const grillaActual = document.querySelector('.grilla-mesas');
          
          // Limpiar los temporizadores existentes
          document.querySelectorAll('[id^="timer-"]').forEach(timer => {
            const mesaId = timer.id.split('-')[1];
            clearInterval(window['timerInterval-' + mesaId]);
          });
          
          grillaActual.innerHTML = nuevaGrillaMesas.innerHTML;

          // Reinicializar los event listeners de las mesas
          inicializarMesas();

          // Reinicializar los temporizadores para las mesas ocupadas
          document.querySelectorAll('.mesa').forEach(mesa => {
            const mesaId = mesa.id.split('-')[1];
            const startTimeElement = mesa.querySelector('[data-start-time]');
            if (startTimeElement && mesa.classList.contains('ocupada')) {
              iniciarTemporizador(mesaId, startTimeElement.dataset.startTime);
            }
          });
        });
    });


    function accionMesa(mesaId, ocupada) {
      const mensaje = ocupada=="ocupada" ? 
        "¿Estás seguro de que deseas desocupar esta mesa?" : 
        "¿Estás seguro de que deseas ocupar esta mesa manualmente?";

      if (confirm(mensaje)) {
        if (ocupada=="ocupada") {
          fetch(`/liberar_mesa/${mesaId}`, { method: 'POST' })
            .then(res => res.json())
            .then(() => {
              location.reload();
            });
        } else {
          fetch(`/ocupar_mesa/${mesaId}`, { method: 'POST' })
            .then(res => res.json())
            .then(() => {
              location.reload();
            });
        }
      }
    }

    function llegoComensal(mesaId) {
        fetch(`/confirmar_llegada/${mesaId}`, { method: 'POST' })
          .then(res => res.json())
          .then(data => {
            if (data.success) {
              // Actualizar la mesa a "ocupada"
              const mesaElement = document.getElementById(`mesa-${mesaId}`);
              mesaElement.classList.remove('recien-asignada');
              mesaElement.classList.add('ocupada');
              mesaElement.dataset.estado = 'ocupada';
              
              // Actualizar el ícono
              const mesaIcon = mesaElement.querySelector('.mesa-icon');
              if (mesaIcon) {
                mesaIcon.classList.remove('fa-clock');
                mesaIcon.classList.add('fa-user-clock');
              }
              
              // Actualizar el texto de estado
              const statusText = mesaElement.querySelector('.mesa-status');
              if (statusText) {
                statusText.textContent = 'Ocupada';
              }

              // Cerrar el popover y overlay
              document.getElementById('popover-overlay').click();
            }
          });

    }
        function reservarMesa(mesaId) {
      fetch(`/reservar_mesa/${mesaId}`, { method: 'POST' })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            // Actualizar la mesa a "reservada"
            const mesaElement = document.getElementById(`mesa-${mesaId}`);
            mesaElement.classList.add('reservada');
            mesaElement.dataset.estado = 'reservada';
            
            // Actualizar el ícono
            const mesaIcon = mesaElement.querySelector('.mesa-icon');
            if (mesaIcon) {
              mesaIcon.classList.remove('fa-utensils');
              mesaIcon.classList.add('fa-calendar-check');
            }
            
            // Actualizar el texto de estado
            const statusText = mesaElement.querySelector('.mesa-status');
            if (statusText) {
              statusText.textContent = 'Reservada';
            }

            // Cerrar el popover y overlay
            document.getElementById('popover-overlay').click();
          }
        });
    }

    function cancelarReserva(mesaId) {
      fetch(`/cancelar_reserva/${mesaId}`, { method: 'POST' })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            // Actualizar la mesa a "libre"
            const mesaElement = document.getElementById(`mesa-${mesaId}`);
            mesaElement.classList.remove('reservada');
            mesaElement.classList.remove('ocupada');
            mesaElement.dataset.estado = 'libre';
            
            // Actualizar el ícono
            const mesaIcon = mesaElement.querySelector('.mesa-icon');
            if (mesaIcon) {
              mesaIcon.classList.remove('fa-calendar-check');
              mesaIcon.classList.add('fa-utensils');
            }
            
            // Actualizar el texto de estado
            const statusText = mesaElement.querySelector('.mesa-status');
            if (statusText) {
              statusText.textContent = 'Disponible';
            }

            // Cerrar el popover y overlay
            document.getElementById('popover-overlay').click();
          }
        });
    }

    document.querySelectorAll('.btn-accion').forEach(btn => {
      btn.addEventListener('click', () => {
        const id = btn.dataset.mesaId;
        const ocupada = btn.dataset.ocupada === 'true';
        accionMesa(id, ocupada);
      });
    });

    horas_minutos_segundos = (totalSegundos) => {
      // Convertir a minutos y segundos
      const minutos = Math.floor(totalSegundos / 60);
      const segundos = totalSegundos % 60;
      const horas = Math.floor(minutos / 60);

      if (horas > 0) {
        return `${horas} hr${horas > 1 ? 's' : ''} ${minutos % 60} min${minutos > 1 ? 's' : ''}`;
      }
      else if (minutos > 0) {
        return `${minutos} min${minutos > 1 ? 's' : ''} `;
      }
      else if(horas==0&&minutos==0){
        return `${totalSegundos} segundos`;
      }
      return '';}

    function actualizarEstadisticas() {
      fetch('/estadisticas')
        .then(res => res.json())
        .then(data => {
      const totalSegundos = Math.round(data.promedio_tiempo_uso);

      // Convertir a minutos y segundos
      const minutos = Math.floor(totalSegundos / 60);
      const segundos = totalSegundos % 60;
      const horas = Math.floor(minutos / 60);

      let texto = "Promedio tiempo de uso de mesas: ";
      if (horas > 0) {
        texto += `${horas} hora${horas > 1 ? 's' : ''} ${minutos % 60} minuto${minutos > 1 ? 's' : ''}`;
      }
      else if (minutos > 0) {
        texto += `${minutos} minuto${minutos > 1 ? 's' : ''} `;
      }
      else if(horas==0&&minutos==0){
        document.getElementById("promedio").innerText =segundos + " segundos";
      }
  
      document.getElementById("promedio").innerText = texto;
        });

    }

    function limpiarTemporizador(mesaId) {
      const intervalId = window['timerInterval-' + mesaId];
      if (intervalId) {
        clearInterval(intervalId);
        delete window['timerInterval-' + mesaId];
      }
    }

    function iniciarTemporizador(mesaId, startTimeStr) {
      if (!startTimeStr) return; // Si no hay tiempo de inicio, no iniciar el temporizador
      
      // Primero limpiar cualquier temporizador existente
      limpiarTemporizador(mesaId);
      
      const startTime = new Date(startTimeStr);
      const mesaElement = document.getElementById(`mesa-${mesaId}`);
      const timerElement = document.getElementById(`timer-${mesaId}`);
      
      if (!timerElement) return; // Si no existe el elemento del timer, no continuar
      
      function actualizar() {
        const ahora = new Date();
        const segundos = Math.floor((ahora - startTime) / 1000);
        
        // Actualizar el temporizador del tiempo de uso
        if (timerElement) {
            timerElement.innerText = `${horas_minutos_segundos(segundos)}`;
        }
        
        // Si la mesa está recién asignada, actualizar la cuenta regresiva
        if (mesaElement && mesaElement.classList.contains('recien-asignada')) {
          const countdownElement = document.getElementById(`countdown-${mesaId}`);
          if (countdownElement) {
            const segundosRestantes = 300 - segundos; // 5 minutos = 300 segundos
            if (segundosRestantes > 0) {
              const minutos = Math.floor(segundosRestantes / 60);
              const segs = segundosRestantes % 60;
              countdownElement.innerText = `${minutos}:${segs.toString().padStart(2, '0')}`;
            }
          }

          // Cambiar de recién asignada a ocupada después de 5 minutos
          const tiempo_espera = 300;
          if (segundos >= tiempo_espera) {
            llegoComensal(mesaId);
          }
        }
      }
      
      // Guardar la referencia del intervalo para poder limpiarlo después
      window['timerInterval-' + mesaId] = setInterval(actualizar, 1000);
      actualizar();
    }

    {% for m in mesas %}
      {% if m.is_occupied and m.start_time %}
        iniciarTemporizador({{ m.id }}, "{{ m.start_time.isoformat() }}");
      {% endif %}
    {% endfor %}

    setInterval(actualizarEstadisticas, 5000);
    actualizarEstadisticas();

    // Código para el manejo del popover
    let activePopover = null;

    function createPopover(mesaId, estado) {
      const popover = document.createElement('div');
      popover.className = 'mesa-popover';
      popover.style.animation = 'popoverScaleIn 0.2s ease-out';
      popover.id = `popover-${mesaId}`;

      // Agregar estilos de animación
      const style = document.createElement('style');
      style.textContent = `
        @keyframes popoverScaleIn {
          from {
            opacity: 0;
            transform: scale(0.95);
          }
          to {
            opacity: 1;
            transform: scale(1);
          }
        }
      `;
      document.head.appendChild(style);
      
      let buttons = '';
      if (estado === 'libre') {
        buttons = `
          <button onclick="reservarMesa(${mesaId})" class="w-full px-2 py-2 bg-blue-50 hover:bg-blue-100 text-blue-700 text-xs sm:text-sm rounded-lg transition-colors border border-blue-200 mb-1">
            ✅ Reservar
          </button>
          <button onclick="accionMesa(${mesaId}, '${estado}')" class="btn-accion w-full px-2 py-2 bg-green-50 hover:bg-green-100 text-green-700 text-xs sm:text-sm rounded-lg transition-colors border border-green-200">
            👥 Asignar
          </button>
        `;
      } else if (estado === 'ocupada') {
        buttons = `
          <button onclick="accionMesa(${mesaId}, '${estado}')" class="w-full px-2 py-2 bg-orange-50 hover:bg-orange-100 text-orange-700 text-xs sm:text-sm rounded-lg transition-colors border border-orange-200 mb-1">
            ⏯️ Desocupar
          </button>
          <button class="w-full px-2 py-2 bg-red-50 hover:bg-red-100 text-red-700 text-xs sm:text-sm rounded-lg transition-colors border border-red-200">
            🔓 Des. y Reservar
          </button>
        `;
      } else if (estado === 'recien-asignada') {
        buttons = `
          <button onclick="llegoComensal(${mesaId})" class="w-full px-2 py-2 bg-green-50 hover:bg-green-100 text-green-700 text-xs sm:text-sm rounded-lg transition-colors border border-green-200">
            ✨ Llegó
          </button>
        `;
      }  else if (estado === 'reservada') {
        buttons = `
          <button onclick="cancelarReserva(${mesaId})" class="w-full px-2 py-2 bg-red-50 hover:bg-red-100 text-red-700 text-xs sm:text-sm rounded-lg transition-colors border border-red-200 mb-1">
            ❌ Cancelar
          </button>
          <button onclick="accionMesa(${mesaId},'libre')" class="w-full px-2 py-2 bg-green-50 hover:bg-green-100 text-green-700 text-xs sm:text-sm rounded-lg transition-colors border border-green-200">
            👥 Ocupar
        `;
      } else if (estado === 'reservada-ocupada') {
        buttons = `
          <button class="w-full px-4 py-3 bg-red-50 hover:bg-red-100 text-red-700 text-sm rounded-xl transition-colors border border-red-200">
            ❌ Desocupar y Cancelar reserva
          </button>
          <button onclick="accionMesa(${mesaId},'ocupada')" class="w-full px-4 py-3 bg-green-50 hover:bg-green-100 text-green-700 text-sm rounded-xl transition-colors border border-green-200">
            👥 Desocupar Mesa
          </button>
        `;
      }

      popover.innerHTML = `
        <div class="space-y-2 p-4">
          ${buttons}
        </div>
      `;

      return popover;
    }

    function mostrarPopover(mesaId, estado, mesaElement) {
      const overlay = document.getElementById('popover-overlay');
      const existingPopover = document.getElementById(`popover-${mesaId}`);
      
      if (existingPopover) {
        existingPopover.remove();
        overlay.classList.add('hidden');
        activePopover = null;
      } else {
        // Eliminar cualquier popover existente
        if (activePopover) {
          activePopover.remove();
        }
        
        const popover = createPopover(mesaId, estado);
        document.body.appendChild(popover);
        
        // Calcular la posición del popover
        const mesaRect = mesaElement.getBoundingClientRect();
        const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
        const viewportHeight = window.innerHeight;
        
        // Añadir el popover al DOM temporalmente para obtener sus dimensiones
        document.body.appendChild(popover);
        const popoverHeight = popover.offsetHeight;
        
        // Decidir si mostrar arriba o abajo
        const spaceAbove = mesaRect.top;
        const spaceBelow = viewportHeight - mesaRect.bottom;
        const showAbove = spaceAbove > spaceBelow && spaceAbove > popoverHeight;
        
        // Posicionar el popover
        popover.style.position = 'absolute';
        if (showAbove) {
            popover.classList.add('arriba');
            popover.classList.remove('abajo');
            popover.style.top = (mesaRect.top + scrollTop - popoverHeight) + 'px';
        } else {
            popover.classList.add('abajo');
            popover.classList.remove('arriba');
            popover.style.top = (mesaRect.bottom + scrollTop) + 'px';
        }
        
        // Centrar horizontalmente
        const left = mesaRect.left + (mesaRect.width - popover.offsetWidth) / 2;
        popover.style.left = Math.max(10, Math.min(document.documentElement.clientWidth - popover.offsetWidth - 10, left)) + 'px';
        
        overlay.classList.remove('hidden');
        activePopover = popover;

        // Detener la propagación del click en el popover
        popover.addEventListener('click', (e) => {
          e.stopPropagation();
        });
      }
    }

    // Función para inicializar los event listeners de las mesas
    function inicializarMesas() {
      document.querySelectorAll('.mesa').forEach(mesa => {
        mesa.addEventListener('click', () => {
          const mesaId = mesa.dataset.mesaId;
          const estado = mesa.dataset.estado;
          mostrarPopover(mesaId, estado, mesa);
        });
      });
    }

    // Inicializar los event listeners cuando se carga la página
    inicializarMesas();

 
    function desocuparMesa(mesaId) {
      fetch(`/liberar_mesa/${mesaId}`, { method: 'POST' })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            // Cerrar el popover y overlay
            document.getElementById('popover-overlay').click();
          }
        });
    }
    // Cerrar el popover cuando se hace clic en el overlay
    document.getElementById('popover-overlay').addEventListener('click', () => {
      if (activePopover) {
        activePopover.remove();
        activePopover = null;
        document.getElementById('popover-overlay').classList.add('hidden');
      }
    });

  </script>
  {% endblock %}
  
</body>
</html>


