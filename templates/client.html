<!DOCTYPE html>
<html>
<head><title>Cliente</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <link rel="stylesheet" href="/static/styles/output.css">
  <link href="https://fonts.googleapis.com/css2?family=Industry+Inc:wght@300;400;500;700&display=swap" rel="stylesheet">
  <style>
    @keyframes pulse {
      0%, 100% { 
        transform: scale(1); 
        opacity: 1; 
      }
      50% { 
        transform: scale(1.05); 
        opacity: 0.8; 
      }
    }
    
    @keyframes blink {
      0%, 50% { opacity: 1; }
      51%, 100% { opacity: 0.3; }
    }
    
    @keyframes slideDown {
      from { transform: translateX(-50%) translateY(-100%); }
      to { transform: translateX(-50%) translateY(0); }
    }
    
    .pulse-animation {
      animation: pulse 1s infinite;
    }
    
    .blink-animation {
      animation: blink 0.5s infinite;
    }
    
    /* Asegurar que el cronómetro sea visible */
    #cronometro-container {
      min-height: 60px !important;
      padding: 15px !important;
      background: linear-gradient(135deg, rgba(34, 197, 94, 0.1), rgba(59, 130, 246, 0.1)) !important;
      border: 2px solid rgba(34, 197, 94, 0.3) !important;
      border-radius: 12px !important;
      margin: 15px 0 !important;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1) !important;
    }
    
    #cronometro-display {
      font-family: 'Courier New', monospace !important;
      font-size: 2rem !important;
      font-weight: bold !important;
      text-align: center !important;
      display: block !important;
      visibility: visible !important;
      color: #22c55e !important;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.1) !important;
    }
    
    /* Cronómetro más grande para móviles con proporciones áureas */
    @media (max-width: 768px) {
      #cronometro-container {
  position: relative !important; /* deja fluir bajo el mensaje */
  top: auto !important;
  left: auto !important;
  transform: none !important;
  width: 92vw !important;
  height: auto !important;
  max-width: 480px !important;
  padding: 18px 16px !important;
  margin: 12px auto 40px auto !important; /* espacio bajo el mensaje */
  z-index: 5 !important;
  box-shadow: 0 12px 30px rgba(0,0,0,0.25) !important;
  border-radius: 18px !important;
  background: #ffffff !important;
  border: 2px solid #d9e2ec !important;
  display: flex !important;
  flex-direction: column !important;
  justify-content: center !important;
  align-items: center !important;
      }
      
      #cronometro-display {
  font-size: 3.6rem !important; /* reducido para no chocar */
  margin: 0.25rem 0 0.35rem 0 !important;
  line-height: 1 !important;
  font-weight: 800 !important;
  color: #1e3a8a !important;
  text-shadow: 1px 1px 3px rgba(0,0,0,0.08) !important;
  font-family: 'Courier New', 'SF Mono', monospace !important;
  letter-spacing: -1px !important;
      }
      
      .cronometro-title {
  font-size: 1.15rem !important;
  margin-bottom: 0.35rem !important;
  font-weight: 600 !important;
  color: #334155 !important;
  text-align: center !important;
      }
      
      .cronometro-message {
  font-size: 0.95rem !important;
  margin-top: 0.4rem !important;
  line-height: 1.25 !important;
  font-weight: 500 !important;
  color: #64748b !important;
  text-align: center !important;
  padding: 0 6px !important;
      }
    }
    
    /* Para móviles muy pequeños - ajustar para mantener proporciones */
    @media (max-width: 480px) {
      #cronometro-container {
  width: 94vw !important;
  height: auto !important;
  max-width: 440px !important;
  padding: 16px 14px !important;
  margin: 10px auto 34px auto !important;
      }
      
      #cronometro-display {
  font-size: 3.2rem !important;
  letter-spacing: -0.5px !important;
      }
      
      .cronometro-title {
  font-size: 1.05rem !important;
  margin-bottom: 0.3rem !important;
      }
      
      .cronometro-message {
  font-size: 0.85rem !important;
  margin-top: 0.3rem !important;
      }
    }
    
    /* Para móviles extra pequeños */
    @media (max-width: 320px) {
      #cronometro-container {
        width: 96vw !important;
        height: auto !important;
      }
      
      #cronometro-display {
        font-size: 2.9rem !important;
      }
      
      .cronometro-title {
        font-size: 0.95rem !important;
      }
      
      .cronometro-message {
        font-size: 0.8rem !important;
      }
    }

    /* Mensaje de turno separado y con espacio asegurado arriba */
    #estado.turno-activo-msg {
      margin-top: 6vh !important;
      margin-bottom: 4px !important;
      padding: 6px 8px !important;
      line-height: 1.25 !important;
      z-index: 10 !important;
      position: relative !important;
      text-align: center !important;
      display: block !important;
    }
    @media (max-width:768px){
      #estado.turno-activo-msg { font-size: 1.55rem !important; }
    }
    @media (max-width:480px){
      #estado.turno-activo-msg { font-size: 1.35rem !important; }
    }
    
    .cronometro-content {
      text-align: center !important;
    }
    
    .cronometro-title {
      font-size: 1.2rem !important;
      margin-bottom: 10px !important;
      color: #374151 !important;
    }
    
    .cronometro-message {
      font-size: 0.9rem !important;
      color: #6b7280 !important;
      margin-top: 10px !important;
    }
    
    /* Estilos para alerta de notificación */
    .notification-prompt {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #3b82f6;
      color: white;
      padding: 1rem 2rem;
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      z-index: 1000;
      animation: slideDown 0.3s ease-out;
    }
    
    /* Estilos para el botón de cancelar turno */
    .cancelar-turno-container {
      text-align: center;
      margin: 30px auto;
      padding: 20px;
      max-width: 300px;
    }
    
    .btn-cancelar-turno {
      background: linear-gradient(135deg, #ef4444, #dc2626);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
      width: 100%;
      max-width: 250px;
    }
    
    .btn-cancelar-turno:hover {
      background: linear-gradient(135deg, #dc2626, #b91c1c);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
    }
    
    .btn-cancelar-turno:active {
      transform: translateY(0);
      box-shadow: 0 2px 4px rgba(239, 68, 68, 0.3);
    }
    
    .cancelar-ayuda {
      font-size: 0.8rem;
      color: #6b7280;
      margin-top: 10px;
      line-height: 1.3;
    }
    
    /* Ocultar botón de cancelar cuando tiene mesa asignada */
    .tiene-mesa #cancelar-turno-container {
      display: none !important;
    }
    
    
    /* Forzar visibilidad del cronómetro */
    .cronometro-container:not(.hidden) {
      display: block !important;
      visibility: visible !important;
      opacity: 1 !important;
    }
    /* Asegurar que si tiene la clase hidden realmente no se muestre (refuerzo) */
    #cronometro-container.hidden {
      display: none !important;
      visibility: hidden !important;
      opacity: 0 !important;
    }
    
    /* Ajuste específico para dispositivos ~360x720 (Android comunes) */
    @media (max-width: 400px) and (min-height: 640px) {
      #cronometro-container {
        width: 92vw !important;
        /* altura mínima 30% pantalla */
        min-height: 30vh !important;
        height: auto !important;
        padding: 28px 18px !important;
        border-width: 3px !important;
      }
      #cronometro-display {
        font-size: 5.2rem !important;
        letter-spacing: -1px !important;
      }
      .cronometro-title { font-size: 1.25rem !important; }
      .cronometro-message { font-size: 1.05rem !important; }
    }

    /* Si la altura disponible es muy baja (teclado abierto / landscape) */
    @media (max-width: 400px) and (max-height: 540px) {
      #cronometro-container {
        position: fixed !important;
        top: 8vh !important;
        transform: translate(-50%, 0) !important;
        min-height: 32vh !important;
        width: 94vw !important;
      }
      #cronometro-display { font-size: 4.4rem !important; }
    }

    /* Forzar que siempre tenga >30% altura cuando esté visible */
    #cronometro-container:not(.hidden) {
      min-height: 30vh !important;
    }

    body.turno-activo #cronometro-container:not(.hidden){
      margin-top: 12px !important;
    }

    .turno-wrapper { display:flex; flex-direction:column; align-items:center; gap:1.2rem; width:100%; }
    .turno-mensaje { text-align:center; font-weight:700; font-size:2rem; line-height:1.15; }
    .turno-mesa { display:block; margin-top:0.35rem; font-size:1.15rem; font-weight:600; }
    @media (max-width:768px){
      .turno-mensaje { font-size:1.75rem; }
      .turno-mesa { font-size:1.1rem; }
    }
    /* Estado cuando se activa el turno: empujar cronómetro más abajo si no cabe */
    @media (max-width:768px){
      body.turno-activo #cronometro-container:not(.hidden){
        position:static !important; /* dejar que fluya debajo del texto */
        transform:none !important;
        width:100% !important;
        height:auto !important;
        margin-top:0.5rem !important;
      }
    }

    /* ---------------- Ajustes específicos para pantallas angostas (~360px) ---------------- */
    @media (max-width: 500px) {
      main { padding-top: 14vh !important; }
      .tiempo-espera-promedio { 
        padding: 0.85rem 0.9rem !important; 
        margin-left: 1rem !important;
        margin-right: 1rem !important;
      }
      .info-bienvenida {
        margin-left: 1rem !important;
        margin-right: 1rem !important;
      }
      .msj-bienvenida, .msj-actualmente, .msj-tu-numero, .msj-estado {
        font-size: 0.95rem !important;
        line-height: 1.3 !important; /* fix readability */
        white-space: normal !important;
        overflow-wrap: anywhere !important;
        word-break: break-word !important;
        margin-bottom: 0.55rem !important;
      }
      .msj-bienvenida { font-weight: 600 !important; }
      .msj-tu-numero strong, .msj-actualmente strong { font-size: 1.05rem !important; }
      /* Evitar que el cronómetro reserve espacio antes de mostrarse */
      #cronometro-container.hidden { min-height: 0 !important; margin:0 !important; padding:0 !important; border:0 !important; }
    }
    /* Corrección de typo en line-height (override) */
    @media (max-width: 400px) {
      .msj-bienvenida, .msj-actualmente, .msj-tu-numero, .msj-estado { line-height: 1.3 !important; }
    }

    /* Botón/enlace al Menú */
    .menu-link-wrap { display:flex; justify-content:center; margin-top: 10px; }
    .menu-link {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: linear-gradient(135deg, #1e3a8a, #2563eb);
      color: #ffffff;
      text-decoration: none;
      padding: 10px 16px;
      border-radius: 10px;
      font-weight: 700;
      box-shadow: 0 6px 16px rgba(37, 99, 235, 0.35);
      transition: transform 0.15s ease, box-shadow 0.2s ease;
    }
    .menu-link:hover { transform: translateY(-1px); box-shadow: 0 10px 22px rgba(37, 99, 235, 0.45); }
    .menu-link:active { transform: translateY(0); box-shadow: 0 4px 12px rgba(37, 99, 235, 0.35); }
    .menu-link .icon { font-size: 1.2rem; line-height: 1; }
    @media (max-width: 480px){ .menu-link { padding: 10px 14px; border-radius: 9px; } }
    
    /* 🎬 ANIMACIONES PARA MENSAJES DE RECONEXIÓN */
    @keyframes fadeOut {
      from { opacity: 1; transform: translateX(-50%) scale(1); }
      to { opacity: 0; transform: translateX(-50%) scale(0.9); }
    }
  </style>
</head>
<body>
  <!-- Header con logo -->
  <header class="top-header">
    <img class="logo-header" src="{{ url_for('static', filename='images/logo-alleria.png') }}" alt="logo-alleria" />
    <div></div> <!-- Espacio vacío para mantener el logo a la izquierda -->
  </header>

  <main class="main">
    <div class="info-bienvenida">
      <div class="tiempo-espera-promedio">
        <p class="msj-bienvenida" id="bienvenida">Bienvenid@ {% if nombre %}{{ nombre }}{% endif %}</p>
        <p class="msj-actualmente" id="actualmente">Actualmente atendiendo al número: <strong id="atendiendo"></strong></p>

        <p class="msj-tu-numero" id="tu-numero">Tu número en la fila es: <strong>{{ numero }}</strong></p>
        {% if llegada_cola %}
          <p class="msj-estado" id="llegada-cola">Hora de llegada:  <span id="hora-llegada"></span></p>
        {% endif %}
        
        <p class="msj-estado" id="estado" style="text-align:center;">Esperando tu turno...</p>


      </div>

      <div class="tiempo-espera-promedio" id="menu-card">
        <p class="msj-menu">Comienza tu experiencia con nosotros <span>
            <!-- Enlace al Menú -->
          <div class="menu-link-wrap">
            <a class="menu-link" href="https://menu.fu.do/alleria/qr-menu?fbclid=PAZnRzaAM1d1ABplYcM7ZWXntJRWEMG5HghxzkBkMSppj4jewlMbzTJ1gxsBBl-XyzjUz_tw" target="_blank" rel="noopener noreferrer">
              <span class="icon">🍽️</span>
              <span>Menu</span>
            </a>
          </div>
        </span></p>
      </div>
    </div>
    
    <!-- Botón para activar notificaciones (oculto por defecto) -->
    <div id="notification-prompt" class="notification-prompt hidden">
      <p class="notification-message">📱 Activa las notificaciones para saber cuando sea tu turno</p>
      <button onclick="solicitarPermisoNotificaciones()" class="notification-button">
        🔔 Activar Notificaciones
      </button>
    </div>
    
  <!-- Cronómetro de 5 minutos (oculto inicialmente) -->
    <div id="cronometro-container" class="cronometro-container hidden">
      <div class="cronometro-content">
        <h3 class="cronometro-title">⏰ Tiempo para llegar</h3>
        <div class="cronometro-display" id="cronometro-display">10:00</div>
  <p class="cronometro-message">¡Tienes 5 minutos para llegar a tu mesa!</p>
      </div>
    </div>
    
    <br>
    <div class="tiempo-espera-promedio" id="tiempo-espera-container">
      <p class="msj-tiempo-espera" id="tiempo-espera" onclick="toggleInfoPopover()" style="cursor: pointer;">
        ⏱️ Tiempo de espera estimado: <strong id="tiempo-promedio">Calculando...</strong>
        <span style="font-size: 0.8em; color: #6b7280; margin-left: 8px;">ℹ️</span>
      </p>
      
      <!-- Popover informativo -->
      <div id="info-popover" class="popover-info hidden">
        <div class="popover-content">
          <p><strong>ℹ️ Información sobre el tiempo de espera:</strong></p>
          <p>El tiempo de espera puede variar y este es solo una estimación. El tiempo se calcula en base al tiempo de espera de los últimos 6 comensales en la fila.</p>
          <button onclick="toggleInfoPopover()" class="popover-close">Entendido</button>
        </div>
      </div>
    </div>

    <!-- CTA: Avisar que viene en camino (aparece desde que falten 10 min) -->
    <div id="en-camino-container" class="tiempo-espera-promedio hidden" style="display:none;">
      <p class="msj-estado" style="text-align:center; margin-bottom:8px;">¿Llegaste?</p>
      <div style="display:flex; justify-content:center; gap:10px;">
        <button id="btn-en-camino" style="background:#2563eb; color:#fff; border:none; padding:10px 16px; border-radius:10px; font-weight:700;">
          ✅ Ya llegué
        </button>
        <span id="estado-en-camino" class="hidden" style="color:#16a34a; font-weight:700; align-self:center;">✔️ Ya llegué</span>
      </div>
    </div>
    
    <!-- Botón para cancelar turno (solo visible mientras espera) -->
    <div id="cancelar-turno-container" class="cancelar-turno-container">
      <button id="btn-cancelar-turno" onclick="confirmarCancelacion()" class="btn-cancelar-turno">
        ❌ Cancelar mi turno
      </button>
      <p class="cancelar-ayuda">Si tienes algún inconveniente, puedes cancelar tu lugar en la fila</p>
    </div>
  </main>

  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
  <script>
  const id = {{ numero|tojson }};
  const mesaAsignadaInicial = {{ mesa_asignada|tojson }};
  const mesaAsignadaAtInicial = {{ mesa_asignada_at|tojson }};
  const llegadaColaISO = {{ llegada_cola|tojson }};
  const cantidadComensales = {{ (cantidad_comensales or 1)|tojson }};
  const enCaminoInicial = {{ en_camino|tojson }};
  
  // 🔥 CONFIGURACIÓN ROBUSTA DE SOCKET.IO CLIENTE
  const socket = io({
    // 🔄 Reconexión automática habilitada
    reconnection: true,
    reconnectionAttempts: 10,        // 10 intentos de reconexión
    reconnectionDelay: 2000,         // 2 segundos entre intentos
    reconnectionDelayMax: 10000,     // Máximo 10 segundos entre intentos
    maxReconnectionAttempts: 10,     // Máximo 10 intentos
    
    // ⚡ Configuración de timeout
    timeout: 20000,                  // 20 segundos timeout
    
    // 🌐 Transporte
    transports: ['websocket', 'polling'], // Permitir WebSocket y polling como fallback
    forceNew: false,                 // Reutilizar conexión existente
    
    // 🏃‍♂️ Opciones de rendimiento
    upgrade: true,                   // Permitir upgrade de polling a websocket
    rememberUpgrade: true,           // Recordar el upgrade para próximas conexiones
    
    // 📊 Monitoreo
    autoConnect: true,               // Conectar automáticamente
  });
  
  let cronometroInterval = null;
  let cronometroAsignacion = null; // Date del momento de asignación para cálculo absoluto
  let enCaminoMarcado = !!enCaminoInicial;
  
  // 📊 Variables de tracking de conexión
  let isConnected = false;
  let lastKnownMesa = null;
  let notificationShown = false;
  let reconexionesCount = 0;
  let ultimoHeartbeat = null;
  let heartbeatInterval = null;
  
  // Si ya viene mesa asignada al cargar, ocultar menú
  (function ocultarMenuSiTieneMesaInicial(){
    try {
      if (mesaAsignadaInicial) {
        const menuCard = document.getElementById('menu-card');
        if (menuCard) menuCard.style.display = 'none';
      }
    } catch (e) { /* noop */ }
  })();
  
  // Mostrar solo la hora de llegada en formato HH:MM (sin día/mes)
  function mostrarHoraLlegada() {
    try {
      // Si ya hay mesa asignada, no mostrar la hora de llegada
      if (mesaAsignadaInicial) {
        const cont = document.getElementById('llegada-cola');
        if (cont) cont.style.display = 'none';
        return;
      }
      if (!llegadaColaISO) return;
      const d = new Date(llegadaColaISO);
      if (isNaN(d.getTime())) return;
      const hh = d.getHours().toString().padStart(2,'0');
      const mm = d.getMinutes().toString().padStart(2,'0');
      const el = document.getElementById('hora-llegada');
      if (el) el.textContent = `${hh}:${mm}`;
    } catch (e) {
      console.warn('No se pudo formatear hora de llegada:', e);
    }
  }

  function ocultarHoraLlegada() {
    const cont = document.getElementById('llegada-cola');
    if (cont) cont.style.display = 'none';
  }

  // ======== Cierre de sesión del cliente ========
  async function cerrarSesionCliente(motivo = '') {
    try {
      await fetch('/logout_cliente', { method: 'POST' });
    } catch (e) {
      console.warn('No se pudo cerrar sesión por fetch, redirigiendo igual:', e);
    } finally {
      // Garantizar que el teléfono pueda reutilizar el QR
      window.location.href = '/qr_landing';
    }
  }

    // ==================== SISTEMA DE NOTIFICACIONES PUSH ====================
    
    // Verificar soporte para notificaciones
    if ('serviceWorker' in navigator && 'PushManager' in window) {
      console.log('El navegador soporta notificaciones push');
    } else {
      console.log('El navegador NO soporta notificaciones push');
    }

    // Registrar Service Worker
    async function registrarServiceWorker() {
      try {
        const registration = await navigator.serviceWorker.register('/static/sw.js');
        console.log('Service Worker registrado:', registration);
        return registration;
      } catch (error) {
        console.error('Error registrando Service Worker:', error);
        return null;
      }
    }

    // Solicitar permisos de notificación
    async function solicitarPermisoNotificaciones() {
      try {
        const permission = await Notification.requestPermission();
        console.log('Permiso de notificaciones:', permission);
        
        if (permission === 'granted') {
          mostrarNotificacionBienvenida();
          // Ocultar el botón de solicitud de permisos
          document.getElementById('notification-prompt').classList.add('hidden');
          return true;
        } else {
          console.log('Permisos de notificación denegados');
          // Mostrar el botón para volver a solicitar permisos
          document.getElementById('notification-prompt').classList.remove('hidden');
          return false;
        }
      } catch (error) {
        console.error('Error solicitando permisos:', error);
        return false;
      }
    }

    // Mostrar notificación de bienvenida
    function mostrarNotificacionBienvenida() {
      if (Notification.permission === 'granted') {
        new Notification('🍽️ Restaurante Alleria', {
          body: 'Te notificaremos cuando sea tu turno. ¡Mantén las notificaciones activadas!',
          icon: '/static/images/logo-alleria.png',
          badge: '/static/images/logo-alleria.png'
        });
      }
    }

    // 🔔 FUNCIONES PARA NOTIFICACIONES PUSH REALES
    
    // Clave VAPID pública (necesaria para Web Push)
    const VAPID_PUBLIC_KEY = 'BKu0Dg213Uep-ADkCqf2mh5Zl4jJVQvYKSQkiellgpZRJUmaY1hfSeEpR-mRxx-81DL41_-MBDc7inLtW7sh7SU';
    
    // Convertir clave VAPID a formato UInt8Array
    function urlBase64ToUint8Array(base64String) {
      const padding = '='.repeat((4 - base64String.length % 4) % 4);
      const base64 = (base64String + padding)
        .replace(/\-/g, '+')
        .replace(/_/g, '/');
      
      const rawData = window.atob(base64);
      const outputArray = new Uint8Array(rawData.length);
      
      for (let i = 0; i < rawData.length; ++i) {
        outputArray[i] = rawData.charCodeAt(i);
      }
      return outputArray;
    }

    // Suscribir a notificaciones push
    async function suscribirsePush() {
      try {
        console.log('🔔 === INICIANDO SUSCRIPCIÓN PUSH ===');
        
        if (!('serviceWorker' in navigator) || !('PushManager' in window)) {
          console.log('❌ Push notifications no soportadas');
          return false;
        }

        // Esperar a que el service worker esté listo
        const registration = await navigator.serviceWorker.ready;
        console.log('✅ Service Worker listo:', registration);

        // Verificar permisos de notificación
        if (Notification.permission !== 'granted') {
          console.log('⚠️ Permisos de notificación no concedidos');
          const permission = await Notification.requestPermission();
          if (permission !== 'granted') {
            console.log('❌ Usuario denegó permisos de notificación');
            return false;
          }
        }

        // Verificar suscripción existente
        let subscription = await registration.pushManager.getSubscription();
        
        if (subscription) {
          console.log('✅ Ya existe suscripción push:', subscription.endpoint);
        } else {
          // Crear nueva suscripción
          console.log('🔄 Creando nueva suscripción push...');
          
          subscription = await registration.pushManager.subscribe({
            userVisibleOnly: true,
            applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC_KEY)
          });
          
          console.log('✅ Nueva suscripción creada:', subscription.endpoint);
        }

        // Enviar suscripción al servidor
        const response = await fetch('/api/push/subscribe', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            subscription: subscription,
            user_agent: navigator.userAgent
          })
        });

        const result = await response.json();
        
        if (result.success) {
          console.log('✅ Suscripción enviada al servidor exitosamente');
          return true;
        } else {
          console.error('❌ Error enviando suscripción al servidor:', result.error);
          return false;
        }

      } catch (error) {
        console.error('❌ Error en suscripción push:', error);
        return false;
      }
    }

    // Desuscribirse de push notifications
    async function desuscribirsePush() {
      try {
        const registration = await navigator.serviceWorker.ready;
        const subscription = await registration.pushManager.getSubscription();
        
        if (subscription) {
          await subscription.unsubscribe();
          console.log('✅ Desuscripción exitosa');
          
          // Notificar al servidor
          await fetch('/api/push/unsubscribe', { method: 'POST' });
        }
      } catch (error) {
        console.error('❌ Error desuscribiéndose:', error);
      }
    }

    // Verificar estado de la suscripción push
    async function verificarSuscripcionPush() {
      try {
        if (!('serviceWorker' in navigator) || !('PushManager' in window)) {
          return false;
        }

        const registration = await navigator.serviceWorker.ready;
        const subscription = await registration.pushManager.getSubscription();
        
        return subscription !== null;
      } catch (error) {
        console.error('❌ Error verificando suscripción:', error);
        return false;
      }
    }

    // 🚀 SISTEMA INTEGRADO DE NOTIFICACIONES (Socket.IO + Push + Service Worker + Visual)
    function mostrarNotificacionesIntegradas(mesa) {
      console.log('🔔 === SISTEMA INTEGRADO DE NOTIFICACIONES INICIADO ===');
      console.log('📱 Mesa asignada:', mesa);
      console.log('🔔 Permission:', Notification.permission);
      console.log('👁️ Visibility:', document.visibilityState);
      console.log('🌐 Online:', navigator.onLine);
      console.log('📳 Vibration API:', 'vibrate' in navigator);
      console.log('🔧 Service Worker:', 'serviceWorker' in navigator);
      
      // === MÉTODO 1: PUSH NOTIFICATION REAL (LA MÁS IMPORTANTE PARA VIBRACIÓN) ===
      if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
        try {
          console.log('🔔 Enviando push notification vía Service Worker...');
          navigator.serviceWorker.controller.postMessage({
            type: 'SHOW_NOTIFICATION_TURNO',
            title: '🎉 ¡ES TU TURNO!',
            body: `Tu mesa ${mesa} está lista. Tienes 5 minutos para llegar.`,
            mesa: mesa,
            vibrate: [800, 200, 800, 200, 800, 200, 800], // Vibración más fuerte
            requireInteraction: true,
            tag: 'turno-mesa-' + mesa,
            icon: '/static/images/logo-alleria.png',
            badge: '/static/images/logo-alleria.png',
            timestamp: Date.now()
          });
          console.log('✅ Push notification enviada al Service Worker');
        } catch (error) {
          console.error('❌ Error enviando push notification:', error);
        }
      } else {
        console.log('⚠️ Service Worker no disponible para push notifications');
      }
      
      // === MÉTODO 2: NOTIFICACIÓN WEB ESTÁNDAR (BACKUP) ===
      if (Notification.permission === 'granted') {
        try {
          console.log('🔔 Creando notificación web estándar...');
          const notificacion = new Notification('🎉 ¡ES TU TURNO!', {
            body: `Tu mesa ${mesa} está lista. Tienes 5 minutos para llegar.`,
            icon: '/static/images/logo-alleria.png',
            badge: '/static/images/logo-alleria.png',
            vibrate: [800, 200, 800, 200, 800, 200, 800], // Vibración más fuerte
            requireInteraction: true,
            tag: 'turno-mesa-' + mesa,
            renotify: true,
            silent: false,
            data: { mesa: mesa, timestamp: Date.now(), type: 'turno' }
          });

          notificacion.onclick = function() {
            window.focus();
            notificacion.close();
          };
          
          // Auto-cerrar después de 2 minutos
          setTimeout(() => notificacion.close(), 120000);
          
          console.log('✅ Notificación web estándar creada');
        } catch (error) {
          console.error('❌ Error creando notificación web:', error);
        }
      } else {
        console.log('⚠️ Permisos de notificación no concedidos');
      }
      
      // === MÉTODO 3: VIBRACIÓN DIRECTA (INMEDIATA) ===
      if (navigator.vibrate) {
        try {
          console.log('📳 Activando vibración directa...');
          // Vibración más intensa y larga para turno
          navigator.vibrate([1000, 300, 1000, 300, 1000, 300, 1000]);
          console.log('✅ Vibración directa activada');
        } catch (error) {
          console.error('❌ Error con vibración:', error);
        }
      }
      
      // === MÉTODO 4: ALERTAS VISUALES EN PANTALLA ===
      mostrarAlertaVisual(mesa);
      intentarDespertarDispositivo();
      crearAlertaSuperpuesta(mesa);
      
      console.log('🔔 === SISTEMA INTEGRADO COMPLETADO ===');
    }

    // Función anterior para compatibilidad (llama a la nueva)
    function mostrarNotificacionTurno(mesa) {
      console.log('⚠️ Función anterior llamada, redirigiendo al sistema integrado...');
      mostrarNotificacionesIntegradas(mesa);
    }
    
    // Nueva función: Alerta visual que siempre funciona
    function mostrarAlertaVisual(mesa) {
      // Cambiar el título de la página (se ve en la pestaña)
      document.title = `🎉 ¡Es tu turno! Mesa ${mesa}`;
      
      // Cambiar favicon para que parpadee
      let faviconLink = document.querySelector('link[rel="icon"]');
      if (!faviconLink) {
        faviconLink = document.createElement('link');
        faviconLink.rel = 'icon';
        document.head.appendChild(faviconLink);
      }
      
      // Alternar favicon cada 500ms durante 10 segundos
      let faviconToggle = 0;
      const faviconInterval = setInterval(() => {
        faviconLink.href = faviconToggle % 2 === 0 ? 
          '/static/images/logo-alleria.png' : 
          'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y=".9em" font-size="90">🎉</text></svg>';
        faviconToggle++;
      }, 500);
      
      // Parar el parpadeo después de 10 segundos
      setTimeout(() => {
        clearInterval(faviconInterval);
        faviconLink.href = '/static/images/logo-alleria.png';
        document.title = 'Cliente - Restaurante Alleria';
      }, 10000);
      
      console.log('✅ Alerta visual activada');
    }
    
    // Nueva función: Intentar despertar dispositivo
    function intentarDespertarDispositivo() {
      // Vibración si está disponible
      if (navigator.vibrate) {
        navigator.vibrate([500, 200, 500, 200, 500]);
        console.log('📳 Vibración activada');
      }
      
      // Reproducir sonido de notificación
      try {
        const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmUUBj2Z2u/JSSUK');
        audio.play().catch(e => console.log('❌ No se pudo reproducir sonido:', e));
        console.log('🔊 Intentando reproducir sonido');
      } catch (e) {
        console.log('❌ Error con audio:', e);
      }
      
      // Intentar forzar enfoque en la ventana
      if (window.focus) {
        window.focus();
      }
      
      // Intentar Wake Lock si está disponible
      if ('wakeLock' in navigator) {
        navigator.wakeLock.request('screen')
          .then(() => console.log('🔋 Wake Lock activado temporalmente'))
          .catch(e => console.log('❌ Wake Lock no disponible:', e));
      }
    }
    
    // Nueva función: Crear alerta visual superpuesta
    function crearAlertaSuperpuesta(mesa) {
      // Remover alerta anterior si existe
      const alertaAnterior = document.getElementById('alerta-turno');
      if (alertaAnterior) {
        alertaAnterior.remove();
      }
      
      // Crear overlay de alerta
      const overlay = document.createElement('div');
      overlay.id = 'alerta-turno';
      overlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.9);
        z-index: 10000;
        display: flex;
        align-items: center;
        justify-content: center;
        animation: pulse 1s infinite;
      `;
      
      // Crear contenido de la alerta
      overlay.innerHTML = `
        <div style="
          background: white;
          padding: 2rem;
          border-radius: 1rem;
          text-align: center;
          max-width: 90%;
          box-shadow: 0 20px 50px rgba(0,0,0,0.5);
          border: 3px solid #22c55e;
        ">
          <div style="font-size: 4rem; margin-bottom: 1rem;">🎉</div>
          <h2 style="font-size: 2rem; color: #22c55e; margin-bottom: 1rem; font-weight: bold;">
            ¡ES TU TURNO!
          </h2>
          <p style="font-size: 1.2rem; margin-bottom: 1rem; color: #333;">
            Tu mesa <strong>${mesa}</strong> está lista
          </p>
          <p style="color: #666; margin-bottom: 2rem;">
            Tienes 5 minutos para llegar
          </p>
          <button onclick="document.getElementById('alerta-turno').remove()" 
                  style="
                    background: #22c55e;
                    color: white;
                    padding: 1rem 2rem;
                    border: none;
                    border-radius: 0.5rem;
                    font-size: 1.1rem;
                    cursor: pointer;
                    font-weight: bold;
                  ">
            ¡Entendido!
          </button>
        </div>
      `;
      
      // Agregar al documento
      document.body.appendChild(overlay);
      
      // Auto-remover después de 30 segundos
      setTimeout(() => {
        if (document.getElementById('alerta-turno')) {
          document.getElementById('alerta-turno').remove();
        }
      }, 30000);
      
      console.log('✅ Alerta superpuesta creada');
    }

    // Inicializar notificaciones al cargar la página
    window.addEventListener('load', async () => {
      // Mostrar la hora de llegada de inmediato
      mostrarHoraLlegada();
      // Al cargar, intentamos obtener el tiempo para evaluar el pre-aviso temprano
      try { actualizarTiempoEsperaPromedio(); } catch(e) {}
      
      // 🔔 INICIALIZACIÓN DE NOTIFICACIONES PUSH
      if ('serviceWorker' in navigator && 'Notification' in window) {
        console.log('🚀 Iniciando sistema de notificaciones push...');
        
        // Registrar Service Worker
        await registrarServiceWorker();
        
        // Solicitar permisos automáticamente después de 2 segundos
        setTimeout(async () => {
          if (Notification.permission === 'default') {
            const permisosConcedidos = await solicitarPermisoNotificaciones();
            
            if (permisosConcedidos) {
              // Suscribirse a notificaciones push
              const suscripcionExitosa = await suscribirsePush();
              if (suscripcionExitosa) {
                console.log('🎉 Sistema de notificaciones push completamente configurado');
              }
            }
          } else if (Notification.permission === 'granted') {
            // Si ya hay permisos, intentar suscripción push
            const yaSuscrito = await verificarSuscripcionPush();
            if (!yaSuscrito) {
              await suscribirsePush();
            }
            console.log('✅ Notificaciones push ya configuradas');
          }
        }, 2000);
      } else {
        console.log('❌ Navegador no soporta Service Workers o Notificaciones');
      }
      
      // Intentar mantener la pantalla activa (Wake Lock API)
      if ('wakeLock' in navigator) {
        try {
          const wakeLock = await navigator.wakeLock.request('screen');
          console.log('🔋 Wake Lock activado - pantalla se mantendrá activa');
          
          // Manejar cuando el usuario cambia de pestaña
          document.addEventListener('visibilitychange', async () => {
            if (wakeLock !== null && document.visibilityState === 'visible') {
              const newWakeLock = await navigator.wakeLock.request('screen');
              console.log('🔋 Wake Lock reactivado');
            }
          });
        } catch (err) {
          console.log('❌ No se pudo activar Wake Lock:', err);
        }
      }
      
      // Registrar eventos para mantener conexión activa y detectar cambios de pestaña
      let lastVisibilityCheck = Date.now();
      let wasHidden = false;
      
      document.addEventListener('visibilitychange', () => {
        const now = Date.now();
        const timeSinceLastCheck = now - lastVisibilityCheck;
        
        console.log('👁️ Cambio de visibilidad detectado:', {
          estado: document.visibilityState,
          tiempoOculto: wasHidden ? timeSinceLastCheck : 0,
          socketConectado: socket.connected
        });
        
        if (document.visibilityState === 'visible') {
          console.log('✅ Página ahora visible - verificando estado...');
          
          // Si estuvo oculta por más de 1 segundo, forzar reconexión
          if (wasHidden && timeSinceLastCheck > 1000) {
            console.log('🔄 Reconectando después de estar oculta...');
            
            // Forzar reconexión del socket
            if (socket.connected) {
              socket.disconnect();
            }
            socket.connect();
            
            // Re-registrar cliente después de un momento
            setTimeout(() => {
              console.log('📝 Re-registrando cliente después de reconexión...');
              socket.emit("registrar_cliente", { id: id });
              
              // Verificar estado actual del cliente
              fetch(`/verificar_estado_cliente/${id}`)
                .then(response => response.json())
                .then(data => {
                  console.log('📊 Estado actual del cliente:', data);
                  
                  // Si ya tiene mesa asignada, mostrar notificación
                  if (data.mesa_asignada && !notificationShown) {
                    console.log('🎉 Cliente ya tenía mesa asignada:', data.mesa_asignada);
                    lastKnownMesa = data.mesa_asignada;
                    notificationShown = true;
                    
                    mostrarNotificacionTurno(data.mesa_asignada);
                    iniciarCronometro(data.mesa_asignada_at);
                    
                    // Actualizar interfaz
                    const estadoEl = document.getElementById("estado");
                    estadoEl.className = "font-bold text-green-600 turno-activo-msg";
                    estadoEl.innerHTML = `¡Es tu turno{% if nombre %} {{ nombre }}{% endif %}!<br><span style="font-weight:600;">Ve a la mesa <span style="color:#1e3a8a;">${data.mesa_asignada}</span></span>`;
                    document.getElementById("actualmente").style.display = "none";
                    document.getElementById("atendiendo").style.display = "none";
                    document.getElementById("tu-numero").style.display = "none";
                    document.getElementById("bienvenida").style.display = "none";
                    document.getElementById("tiempo-espera-container").style.display = "none";
                    const llegadaCont = document.getElementById("llegada-cola");
                    if (llegadaCont) llegadaCont.style.display = 'none';
                  }
                })
                .catch(error => {
                  console.error('❌ Error verificando estado del cliente:', error);
                });
            }, 1000);
          } else if (!socket.connected) {
            console.log('🔌 Socket desconectado, reconectando...');
            socket.connect();
          }
          
          wasHidden = false;
        } else {
          console.log('👻 Página ahora oculta');
          wasHidden = true;
        }
        
        lastVisibilityCheck = now;
      });
      
      // También escuchar eventos de enfoque/desenfoque de la ventana
      window.addEventListener('focus', () => {
        console.log('🎯 Ventana enfocada - verificando conexión...');
        if (!socket.connected) {
          socket.connect();
        }
      });
      
      window.addEventListener('blur', () => {
        console.log('💭 Ventana desenfocada');
      });

      // Restaurar estado si ya había mesa asignada (evita re-creación tras refresh)
      try {
        if (mesaAsignadaInicial && mesaAsignadaAtInicial) {
          console.log('♻️ Restaurando estado de turno tras recarga:', mesaAsignadaInicial, mesaAsignadaAtInicial);
          // Actualizar interfaz a estado de turno activo
          const estadoEl = document.getElementById("estado");
          estadoEl.className = "font-bold text-green-600 turno-activo-msg";
          estadoEl.innerHTML = `¡Es tu turno{% if nombre %} {{ nombre }}{% endif %}!<br><span style="font-weight:600;">Ve a la mesa <span style="color:#1e3a8a;">${mesaAsignadaInicial}</span></span>`;
          document.getElementById("actualmente").style.display = "none";
          document.getElementById("atendiendo").style.display = "none";
          document.getElementById("tu-numero").style.display = "none";
          document.getElementById("bienvenida").style.display = "none";
          document.getElementById("tiempo-espera-container").style.display = "none";
          const llegadaCont2 = document.getElementById('llegada-cola');
          if (llegadaCont2) llegadaCont2.style.display = 'none';

          // Ocultar botón de cancelar turno cuando ya tiene mesa asignada
          const cancelarContainer = document.getElementById('cancelar-turno-container');
          if (cancelarContainer) {
            cancelarContainer.style.display = 'none';
          }

          // Mostrar CTA "En camino" si aún no se ha marcado, incluso con mesa asignada
          const enCaminoCta = document.getElementById('en-camino-container');
          if (enCaminoCta && !enCaminoMarcado) {
            mostrarCTAEnCamino();
          }
          
          // Agregar clase para indicar que tiene mesa
          document.body.classList.add('tiene-mesa');

          // Iniciar cronómetro desde timestamp absoluto proporcionado por el backend
          iniciarCronometro(mesaAsignadaAtInicial);
        }
      } catch (e) {
        console.error('Error restaurando estado tras refresh:', e);
      }

      // Si no hay mesa asignada al cargar, resetear estado de pre-avisos en esta sesión
      if (!mesaAsignadaInicial) {
        pre10Shown = false;
        pre5Shown = false;
        entryInitialRemainingSec = null;
        entryUnder10 = false;
        entryUnder5 = false;
        entryEvaluated = false;
      }
    });

    // ==================== FIN SISTEMA DE NOTIFICACIONES ====================

    // Función para mostrar/ocultar el popover
    function toggleInfoPopover() {
      const popover = document.getElementById("info-popover");
      popover.classList.toggle("hidden");
    }

    // Cerrar popover al hacer clic fuera de él
    document.addEventListener('click', function(event) {
      const popover = document.getElementById('info-popover');
      const tiempoEspera = document.getElementById('tiempo-espera');
      if (popover && !popover.contains(event.target) && tiempoEspera && !tiempoEspera.contains(event.target)) {
        popover.classList.add('hidden');
      }
    });

    // ==================== CANCELAR TURNO ====================
    
    function confirmarCancelacion() {
      const confirmar = confirm(
        "¿Estás seguro de que quieres cancelar tu lugar en la fila?\n\n" +
        "Esta acción no se puede deshacer y tendrás que volver a hacer fila si cambias de opinión."
      );
      
      if (confirmar) {
        cancelarTurno();
      }
    }
    
    async function cancelarTurno() {
      try {
        // Deshabilitar el botón para evitar clics múltiples
        const btnCancelar = document.getElementById('btn-cancelar-turno');
        btnCancelar.disabled = true;
        btnCancelar.textContent = '⏳ Cancelando...';
        
        const response = await fetch(`/cancelar_turno/${id}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          }
        });
        
        const data = await response.json();
        
        if (data.success) {
          // Mostrar mensaje de confirmación
          alert('✅ Tu lugar en la fila ha sido cancelado exitosamente.\n\nGracias por visitarnos. ¡Esperamos verte pronto!');
          
          // Redirigir al landing page
          window.location.href = '/qr_landing';
        } else {
          // Mostrar error
          alert(`❌ Error al cancelar: ${data.error}`);
          
          // Restaurar el botón
          btnCancelar.disabled = false;
          btnCancelar.textContent = '❌ Cancelar mi turno';
        }
      } catch (error) {
        console.error('Error al cancelar turno:', error);
        alert('❌ Error de conexión. Por favor, intenta de nuevo.');
        
        // Restaurar el botón
        const btnCancelar = document.getElementById('btn-cancelar-turno');
        btnCancelar.disabled = false;
        btnCancelar.textContent = '❌ Cancelar mi turno';
      }
    }

    // ==================== FIN CANCELAR TURNO ====================

    // Cronómetro robusto (cálculo absoluto) similar a lógica de workers
    function iniciarCronometro(asignada_at = null){
      console.log('🕐 [CRONOMETRO] init con asignada_at=', asignada_at);
      if(!asignada_at){
        console.warn('⛔ [CRONOMETRO] sin timestamp, no se inicia');
        return;
      }
      const ts = new Date(asignada_at);
      if(isNaN(ts.getTime())){ console.error('❌ [CRONOMETRO] timestamp inválido'); return; }
      cronometroAsignacion = ts; // guardar referencia absoluta
      const cont = document.getElementById('cronometro-container');
      const disp = document.getElementById('cronometro-display');
      if(!cont || !disp){ console.error('❌ [CRONOMETRO] elementos no encontrados'); return; }
      cont.classList.remove('hidden');
      cont.style.display='block';
      cont.style.visibility='visible';
      // limpiar intervalo anterior
      if(window.cronometroInterval){ clearInterval(window.cronometroInterval); }
  const TOTAL = 300; // 5 min
      function tick(){
        if(!cronometroAsignacion){ clearInterval(window.cronometroInterval); return; }
        const ahora = new Date();
        const trans = Math.floor((ahora - cronometroAsignacion)/1000);
        const restante = Math.max(0, TOTAL - trans);
        const m = Math.floor(restante/60);
        const s = restante % 60;
        disp.textContent = `${m}:${s.toString().padStart(2,'0')}`;
        if(restante <= 120){
          disp.style.color = '#ef4444';
          disp.style.animation = 'pulse 1s infinite';
          disp.style.fontWeight = 'bold';
        } else if(restante <= 300){
          disp.style.color = '#f59e0b';
          disp.style.animation = '';
        } else {
          disp.style.color = '#22c55e';
          disp.style.animation = '';
        }
        if(restante % 5 === 0 || restante <= 10){
          document.title = `⏰ ${m}:${s.toString().padStart(2,'0')} - Restaurante Alleria`;
        }
        if(restante === 0){
          disp.textContent = '¡Tiempo agotado!';
          document.title = '⏰ ¡Tiempo agotado! - Restaurante Alleria';
          clearInterval(window.cronometroInterval);
          // Al expirar el tiempo, cerrar la sesión del cliente para permitir reutilizar el QR
          cerrarSesionCliente('timeout');
        }
      }
      tick();
      window.cronometroInterval = setInterval(tick,1000);
      console.log('✅ [CRONOMETRO] iniciado');
    }

    // Función para obtener y actualizar el tiempo de espera promedio
    function actualizarTiempoEsperaPromedio() {
      fetch('/tiempo_espera_promedio')
        .then(response => response.json())
        .then(data => {
          const minutos = data.promedio_minutos;
          const segundos = data.promedio_segundos;
          const elemento = document.getElementById("tiempo-promedio");
          
          if (minutos <= 5) {
            elemento.textContent = `${minutos} minutos ⚡`;
            elemento.style.color = "#22c55e"; // Verde
          } else if (minutos <= 15) {
            elemento.textContent = `${minutos} minutos ⏰`;
            elemento.style.color = "#f59e0b"; // Amarillo/Naranja
          } else {
            elemento.textContent = `${minutos} minutos ⏳`;
            elemento.style.color = "#ef4444"; // Rojo
          }

          // Evaluar pre-aviso con el valor en segundos
          evaluarPreAviso(segundos);
        })
        .catch(error => {
          console.error('Error obteniendo tiempo de espera:', error);
          document.getElementById("tiempo-promedio").textContent = "No disponible";
        });
    }

    // 🔗 EVENTOS ROBUSTOS DE SOCKET.IO
    
    socket.on("connect", () => {
      const transport = socket.io.engine.transport.name; // 'polling' o 'websocket'
      reconexionesCount++;
      
      console.log('🔌 === SOCKET CONECTADO ===');
      console.log(`  🆔 Socket ID: ${socket.id}`);
      console.log(`  🚀 Transporte: ${transport}`);
      console.log(`  🔄 Reconexiones: ${reconexionesCount}`);
      console.log(`  📄 Datos cliente:`, { id, mesaAsignadaInicial });
      
      isConnected = true;
      ultimoHeartbeat = new Date();
      
      // 📝 Registrar cliente en servidor
      socket.emit("registrar_cliente", { 
        id: id,
        timestamp: Date.now(),
        transport: transport,
        reconexion_num: reconexionesCount
      });
      
      // 📊 Obtener datos iniciales
      actualizarTiempoEsperaPromedio();
      mostrarHoraLlegada();
      
      // 💓 Iniciar heartbeat
      iniciarHeartbeat();
      
      // 🔄 Monitorear cambios de transporte
      socket.io.engine.on('upgrade', () => {
        const newTransport = socket.io.engine.transport.name;
        console.log(`⬆️ Transporte actualizado: ${transport} -> ${newTransport}`);
      });
      
      console.log('✅ Conexión completa');
    });

    socket.on("disconnect", (reason) => {
      console.log('❌ === SOCKET DESCONECTADO ===');
      console.log(`  🔴 Razón: ${reason}`);
      console.log(`  ⏱️ Duración conexión: ${ultimoHeartbeat ? new Date() - ultimoHeartbeat : 'unknown'}ms`);
      console.log(`  🔄 Total reconexiones: ${reconexionesCount}`);
      
      isConnected = false;
      
      // 🚫 Detener heartbeat
      if (heartbeatInterval) {
        clearInterval(heartbeatInterval);
        heartbeatInterval = null;
      }
      
      // 🔄 Estrategia de reconexión según la razón
      if (reason === 'io server disconnect') {
        // Servidor desconectó intencionalmente - reconectar inmediatamente
        console.log('🔄 Servidor desconectó - reconectando inmediatamente...');
        setTimeout(() => {
          if (!socket.connected) {
            socket.connect();
          }
        }, 1000);
      } else if (reason === 'ping timeout' || reason === 'transport close') {
        // Problemas de red - reconectar con delay
        console.log('🌐 Problema de red - reconectando en 3 segundos...');
        setTimeout(() => {
          if (!socket.connected) {
            socket.connect();
          }
        }, 3000);
      } else if (reason !== 'io client disconnect') {
        // Otras desconexiones - reconectar con delay
        console.log('🔄 Reconectando en 2 segundos...');
        setTimeout(() => {
          if (!socket.connected) {
            socket.connect();
          }
        }, 2000);
      }
    });

    socket.on("connect_error", (error) => {
      console.error('❌ === ERROR DE CONEXIÓN ===');
      console.error(`  🔴 Error: ${error.message}`);
      console.error(`  🔄 Reconexiones: ${reconexionesCount}`);
      console.error(`  ⏱️ Timestamp: ${new Date().toISOString()}`);
      
      isConnected = false;
      
      // 🚨 Mostrar mensaje al usuario después de varios intentos fallidos
      if (reconexionesCount > 5) {
        mostrarMensajeReconexion('Problemas de conexión. Reintentando...');
      }
    });

    socket.on("reconnect", (attemptNumber) => {
      console.log(`✨ === RECONECTADO EXITOSAMENTE ===`);
      console.log(`  🔄 Intento número: ${attemptNumber}`);
      console.log(`  🆔 Nuevo Socket ID: ${socket.id}`);
      
      ocultarMensajeReconexion();
    });

    socket.on("reconnect_error", (error) => {
      console.error(`❌ Error en reconexion: ${error.message}`);
    });

    socket.on("reconnect_failed", () => {
      console.error('❌ === RECONEXION FALLIDA ===');
      console.error('  Se agotaron todos los intentos de reconexión');
      
      mostrarMensajeReconexion(
        'No se pudo reconectar. Por favor, recarga la página.',
        true // mostrar botón de recarga
      );
    });
    
    // 💓 Respuesta del servidor al heartbeat
    socket.on("heartbeat_ack", (data) => {
      console.log(`💚 Heartbeat OK - Server time: ${data.server_time}`);
      ultimoHeartbeat = new Date();
    });
    
    // ❌ Manejo de errores del servidor
    socket.on("error", (error) => {
      console.error('❌ Error del servidor:', error);
      
      if (error.message === 'No autorizado' || error.message === 'Cliente no válido') {
        console.log('🔒 Error de autorización - redirigiendo...');
        cerrarSesionCliente('error_autorizacion');
      }
    });
    
    // 🔄 Notificación de conexión expirada
    socket.on("connection_expired", (data) => {
      console.log('⏰ Conexión expirada:', data.message);
      
      // Intentar reconectar inmediatamente
      if (!socket.connected) {
        socket.connect();
      }
    });
    
    // ✅ Confirmación de registro
    socket.on("registro_confirmado", (data) => {
      console.log('✅ Registro confirmado:', data);
    });

    // El mesero confirmó 'Llegó': cerrar la sesión del cliente de este dispositivo
    socket.on('cerrar_sesion_cliente', (data) => {
      console.log('🔒 Solicitud de cierre de sesión recibida del servidor:', data);
      cerrarSesionCliente(data && data.motivo ? data.motivo : 'llego');
    });

    // Actualizar tiempo de espera cada 30 segundos
    setInterval(actualizarTiempoEsperaPromedio, 30000);

    // 🚨 FUNCIONES DE UI PARA MENSAJES DE RECONEXIÓN
    
    function mostrarMensajeReconexion(mensaje, mostrarRecarga = false) {
      // Remover mensaje anterior si existe
      const anterior = document.getElementById('mensaje-reconexion');
      if (anterior) {
        anterior.remove();
      }
      
      // Crear nuevo mensaje
      const div = document.createElement('div');
      div.id = 'mensaje-reconexion';
      div.style.cssText = `
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: #ef4444;
        color: white;
        padding: 1rem 2rem;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        z-index: 10001;
        font-weight: bold;
        text-align: center;
        animation: slideDown 0.3s ease-out;
      `;
      
      div.innerHTML = `
        <div style="margin-bottom: ${mostrarRecarga ? '10px' : '0'};">
          🌐 ${mensaje}
        </div>
        ${mostrarRecarga ? '<button onclick="window.location.reload()" style="background: white; color: #ef4444; border: none; padding: 5px 15px; border-radius: 4px; cursor: pointer; font-weight: bold;">↻ Recargar página</button>' : ''}
      `;
      
      document.body.appendChild(div);
    }
    
    function ocultarMensajeReconexion() {
      const mensaje = document.getElementById('mensaje-reconexion');
      if (mensaje) {
        mensaje.style.animation = 'fadeOut 0.3s ease-out';
        setTimeout(() => {
          mensaje.remove();
        }, 300);
      }
    }

    // 💓 SISTEMA ROBUSTO DE HEARTBEAT
    
    // 💓 SISTEMA ROBUSTO DE HEARTBEAT
    
    function iniciarHeartbeat() {
      // Limpiar heartbeat anterior si existe
      if (heartbeatInterval) {
        clearInterval(heartbeatInterval);
        heartbeatInterval = null;
      }
      
      console.log('💓 Iniciando heartbeat robusto...');
      
      heartbeatInterval = setInterval(() => {
        if (!socket.connected) {
          console.log('🚫 Heartbeat cancelado - socket desconectado');
          return;
        }
        
        const ahora = new Date();
        const pageVisible = document.visibilityState === 'visible';
        
        console.log(`💓 Enviando heartbeat... (visible: ${pageVisible})`);
        
        socket.emit('heartbeat', { 
          cliente_id: id, 
          timestamp: ahora.getTime(),
          page_visible: pageVisible,
          user_agent: navigator.userAgent.substring(0, 100),
          url: window.location.href
        });
        
        // 🔍 Detectar si no recibimos heartbeat_ack en 10 segundos
        const timeoutId = setTimeout(() => {
          if (socket.connected) {
            console.log('⚠️ Heartbeat sin respuesta - posible problema de conexión');
            // No reconectar automáticamente aquí, dejar que Socket.IO maneje timeouts
          }
        }, 10000);
        
        // Limpiar timeout si recibimos respuesta
        const originalHandler = socket.off('heartbeat_ack');
        socket.once('heartbeat_ack', () => {
          clearTimeout(timeoutId);
        });
        
      }, 15000); // Cada 15 segundos (más frecuente que el servidor)
    }
    
    function detenerHeartbeat() {
      if (heartbeatInterval) {
        clearInterval(heartbeatInterval);
        heartbeatInterval = null;
        console.log('🚫 Heartbeat detenido');
      }
    }
    
    // Iniciar heartbeat cuando se conecte
    socket.on("connect", () => {
      iniciarHeartbeat();
    });
    
    // Detener heartbeat cuando se desconecte
    socket.on("disconnect", () => {
      if (heartbeatInterval) {
        clearInterval(heartbeatInterval);
      }
    });

  // Pre-avisos: manejar 10 y 5 minutos de forma independiente y según condición de entrada
  let pre10Shown = false;
  let pre5Shown = false;
  let entryInitialRemainingSec = null; // restante al momento de la primera evaluación
  let entryUnder10 = false; // si al entrar ya quedaban <= 10 min
  let entryUnder5 = false;  // si al entrar ya quedaban <= 5 min
  let entryEvaluated = false; // se fijó el valor inicial
    
    socket.on("es_tu_turno", (data) => {
      console.log('🎉 === EVENTO ES_TU_TURNO RECIBIDO ===');
      console.log('📦 Data recibida:', data);
      console.log('🌐 Ubicación:', window.location.href);
      console.log('📱 Plataforma:', navigator.platform);
      console.log('👁️ Documento visible:', document.visibilityState);
      console.log('🔌 Socket conectado:', socket.connected);
      
      // Evitar procesar el mismo evento múltiples veces
      if (lastKnownMesa === data.mesa && notificationShown) {
        console.log('⚠️ Evento duplicado ignorado para mesa', data.mesa);
        return;
      }
      
      lastKnownMesa = data.mesa;
      notificationShown = true;
      
      try {
        // Actualizar elementos de la interfaz
        const estadoElement = document.getElementById("estado");
        const actualmenteElement = document.getElementById("actualmente");
        const atendiendoElement = document.getElementById("atendiendo");
        const tuNumeroElement = document.getElementById("tu-numero");
        const bienvenidaElement = document.getElementById("bienvenida");
        const tiempoEsperaElement = document.getElementById("tiempo-espera-container");
  const llegadaElement = document.getElementById("llegada-cola");
        
        console.log('🔍 Elementos encontrados:', {
          estado: !!estadoElement,
          actualmente: !!actualmenteElement,
          atendiendo: !!atendiendoElement,
          tuNumero: !!tuNumeroElement,
          bienvenida: !!bienvenidaElement,
          tiempoEspera: !!tiempoEsperaElement
        });
        
        if (estadoElement) {
          estadoElement.className = "font-bold text-green-600 turno-activo-msg";
          estadoElement.innerHTML = `¡Es tu turno{% if nombre %} {{ nombre }}{% endif %}!<br><span style="font-weight:600;">Ve a la mesa <span style=\"color:#1e3a8a;\">${data.mesa}</span></span>`;
          console.log('✅ Estado actualizado');
        }
        
        // Ocultar elementos no necesarios, incluyendo la card del menú
        const menuCard = document.getElementById('menu-card');
        const enCaminoCta = document.getElementById('en-camino-container');
        [actualmenteElement, atendiendoElement, tuNumeroElement, bienvenidaElement, tiempoEsperaElement, llegadaElement, menuCard].forEach((el, index) => {
          if (el) {
            el.style.display = "none";
            console.log(`✅ Elemento ${index + 1} ocultado`);
          }
        });

        // Mostrar opción de "En camino" incluso después de asignar mesa, si aún no se marcó
        try {
          if (enCaminoCta && !enCaminoMarcado) {
            mostrarCTAEnCamino();
          }
        } catch (e) { /* noop */ }

        // Ocultar botón de cancelar turno cuando se asigna mesa
        const cancelarContainer = document.getElementById('cancelar-turno-container');
        if (cancelarContainer) {
          cancelarContainer.style.display = 'none';
          console.log('✅ Botón de cancelar turno ocultado');
        }
        
  // Agregar clase para indicar que tiene mesa
        document.body.classList.add('tiene-mesa');
        
        // Mostrar notificaciones combinadas (Socket.IO + Push + Service Worker)
        console.log('🔔 === INICIANDO SISTEMA INTEGRADO DE NOTIFICACIONES ===');
        mostrarNotificacionesIntegradas(data.mesa);
        
        // Iniciar cronómetro con timestamp de asignación
        console.log('⏰ Iniciando proceso de cronómetro...');
        iniciarCronometro(data.asignada_at);
        
        console.log('✅ Proceso de turno completado exitosamente');
        
      } catch (error) {
        console.error('❌ Error procesando evento es_tu_turno:', error);
        console.error('📋 Stack trace:', error.stack);
      }
      
      console.log('🎉 === FIN EVENTO ES_TU_TURNO ===');
    });
    
    socket.on("actualizar_posicion",(data)=>{
      document.getElementById("atendiendo").innerText = Number(data.primero)-1;
    });

    // Actualizar tiempo de espera cuando hay cambios en la cola
    socket.on("actualizar_cola", () => {
      actualizarTiempoEsperaPromedio();
    });

    function mostrarTurnoEnPantalla(nombreCliente, mesa){
      const estado = document.getElementById('estado');
      if(!estado) return;
      document.body.classList.add('turno-activo');
      estado.innerHTML = `<span class="turno-mensaje">¡Es tu turno ${nombreCliente || ''}!<br><span class="turno-mesa">Ve a la mesa ${mesa}</span></span>`;
    }

    // ==================== PRE-AVISO: Faltan <=10 minutos ====================
    function mostrarNotificacionPreAviso(minsRestantesAprox){
      // Notificación web estándar
      if (typeof Notification !== 'undefined' && Notification.permission === 'granted') {
        try {
          const noti = new Notification('⏳ Tu turno se acerca', {
            body: `Faltan ~${minsRestantesAprox} minutos para tu turno. Te sugerimos comenzar a caminar hacia el restaurante.`,
            icon: '/static/images/logo-alleria.png',
            badge: '/static/images/logo-alleria.png',
            vibrate: [300, 150, 300],
            tag: 'preaviso-turno',
            renotify: false,
            requireInteraction: false,
            data: { tipo: 'preaviso', timestamp: Date.now() }
          });
          setTimeout(() => noti.close(), 20000);
        } catch (e) { console.warn('No se pudo crear notificación de preaviso:', e); }
      }

      // Notificación via Service Worker (si está activo)
      if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
        try {
          navigator.serviceWorker.controller.postMessage({
            type: 'SHOW_NOTIFICATION',
            title: '⏳ Tu turno se acerca',
            body: `Faltan ~${minsRestantesAprox} minutos para tu turno. Te sugerimos comenzar a caminar hacia el restaurante.`
          });
        } catch (e) { console.warn('SW preaviso no disponible:', e); }
      }

      // Alerta visual superpuesta (mismo estilo que turno)
      crearAlertaPreAviso(minsRestantesAprox);
    }

    function crearAlertaPreAviso(minsRestantesAprox){
      // Remover si ya existe
      const anterior = document.getElementById('alerta-preaviso');
      if (anterior) anterior.remove();

      const overlay = document.createElement('div');
      overlay.id = 'alerta-preaviso';
      overlay.style.cssText = `
        position: fixed;
        top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0, 0, 0, 0.85);
        z-index: 9999;
        display: flex; align-items: center; justify-content: center; animation: pulse 1s infinite;`;

      overlay.innerHTML = `
        <div style="
          background: white; padding: 1.75rem; border-radius: 1rem;
          text-align: center; max-width: 92%; box-shadow: 0 20px 50px rgba(0,0,0,0.45);
          border: 3px solid #2563eb;">
          <div style="font-size: 3rem; margin-bottom: 0.75rem;">⏳</div>
          <h2 style="font-size: 1.6rem; color: #1e3a8a; margin-bottom: 0.5rem; font-weight: 800;">
            ¡Tu turno se acerca!
          </h2>
          <p style="font-size: 1.05rem; margin-bottom: 0.75rem; color: #111827;">
            Faltan aproximadamente <strong>${minsRestantesAprox} minutos</strong> para tu turno.
          </p>
          <p style="color: #374151; margin-bottom: 1.25rem;">
            Te sugerimos comenzar a caminar hacia el restaurante.
          </p>
          <button onclick="document.getElementById('alerta-preaviso').remove()"
            style="background:#2563eb; color:#fff; padding:0.8rem 1.3rem; border:none; border-radius:0.5rem; font-weight:700; cursor:pointer;">
            Entendido
          </button>
        </div>`;
      document.body.appendChild(overlay);
      setTimeout(() => { if (document.getElementById('alerta-preaviso')) document.getElementById('alerta-preaviso').remove(); }, 20000);
    }

    function evaluarPreAviso(promedioSegundos){
      try {
        if (notificationShown) return; // ya le tocó
        if (mesaAsignadaInicial) return; // ya venía con mesa
        if (!llegadaColaISO) return; // sin hora de llegada

        const llegada = new Date(llegadaColaISO);
        if (isNaN(llegada.getTime())) return;
        const ahora = new Date();
        const estimadoTurno = new Date(llegada.getTime() + (Number(promedioSegundos) || 0) * 1000);
        const diffSec = Math.floor((estimadoTurno - ahora) / 1000);

        // Fijar condición de entrada una única vez (primera evaluación válida)
        if (!entryEvaluated) {
          entryInitialRemainingSec = diffSec;
          entryUnder10 = entryInitialRemainingSec <= 600;
          entryUnder5 = entryInitialRemainingSec <= 300;
          entryEvaluated = true;
        }

        // Si al entrar quedaban <=5 min: no mostrar ningún pre-aviso (ni 10 ni 5)
        if (entryUnder5) return;

        // Aviso de 10 min: solo si al entrar quedaban >10 min
        if (!entryUnder10 && !pre10Shown && diffSec > 0 && diffSec <= 600) {
          const minsAprox10 = Math.max(1, Math.ceil(diffSec / 60));
          mostrarNotificacionPreAviso(minsAprox10);
          pre10Shown = true;
          // Mostrar CTA de 'en camino' desde este momento
          mostrarCTAEnCamino();
        }

        // Aviso de 5 min: solo si al entrar quedaban >5 min
        if (!pre5Shown && diffSec > 0 && diffSec <= 300) {
          const minsAprox5 = Math.max(1, Math.ceil(diffSec / 60));
          mostrarNotificacionPreAviso(minsAprox5);
          pre5Shown = true;
        }

        // Si ya pasamos el umbral de 10 min y al entrar quedaban >10 min, asegurar CTA visible
        if (!entryUnder10 && diffSec > 0 && diffSec <= 600) {
          mostrarCTAEnCamino();
        }
      } catch (e) {
        console.warn('No se pudo evaluar pre-aviso:', e);
      }
    }

    function mostrarCTAEnCamino(){
      try {
        const cont = document.getElementById('en-camino-container');
        const btn = document.getElementById('btn-en-camino');
        const est = document.getElementById('estado-en-camino');
        if (!cont || !btn || !est) return;
        cont.classList.remove('hidden');
        cont.style.display = 'block';
        if (enCaminoMarcado) {
          btn.disabled = true;
          btn.style.opacity = '0.6';
          est.classList.remove('hidden');
        }
      } catch(e) { /* noop */ }
    }

    // Click en "Ya voy en camino"
    (function bindEnCamino(){
      const btn = document.getElementById('btn-en-camino');
      if (!btn) return;
      btn.addEventListener('click', async () => {
        try {
          btn.disabled = true;
          btn.textContent = '⏳ Marcando...';
          const resp = await fetch('/marcar_en_camino', { method: 'POST' });
          const data = await resp.json();
          if (data && data.success) {
            enCaminoMarcado = true;
            const est = document.getElementById('estado-en-camino');
            if (est) est.classList.remove('hidden');
            btn.textContent = '✔️ En camino';
            btn.style.opacity = '0.6';
          } else {
            btn.disabled = false;
            btn.textContent = '🚶 Ya voy en camino';
            alert((data && data.error) || 'No se pudo marcar en camino');
          }
        } catch (e) {
          btn.disabled = false;
          btn.textContent = '🚶 Ya voy en camino';
          alert('Error de red');
        }
      });
    })();
  </script>
</body>
</html>
