<!DOCTYPE html>
<html>
<head><title>Cliente</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <link rel="stylesheet" href="/static/styles/output.css">
  <link href="https://fonts.googleapis.com/css2?family=Industry+Inc:wght@300;400;500;700&display=swap" rel="stylesheet">
  <style>
    @keyframes pulse {
      0%, 100% { 
        transform: scale(1); 
        opacity: 1; 
      }
      50% { 
        transform: scale(1.05); 
        opacity: 0.8; 
      }
    }
    
    @keyframes blink {
      0%, 50% { opacity: 1; }
      51%, 100% { opacity: 0.3; }
    }
    
    @keyframes slideDown {
      from { transform: translateX(-50%) translateY(-100%); }
      to { transform: translateX(-50%) translateY(0); }
    }
    
    .pulse-animation {
      animation: pulse 1s infinite;
    }
    
    .blink-animation {
      animation: blink 0.5s infinite;
    }
    
    /* Asegurar que el cron√≥metro sea visible */
    #cronometro-container {
      min-height: 60px !important;
      padding: 15px !important;
      background: linear-gradient(135deg, rgba(34, 197, 94, 0.1), rgba(59, 130, 246, 0.1)) !important;
      border: 2px solid rgba(34, 197, 94, 0.3) !important;
      border-radius: 12px !important;
      margin: 15px 0 !important;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1) !important;
    }
    
    #cronometro-display {
      font-family: 'Courier New', monospace !important;
      font-size: 2rem !important;
      font-weight: bold !important;
      text-align: center !important;
      display: block !important;
      visibility: visible !important;
      color: #22c55e !important;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.1) !important;
    }
    
    /* Cron√≥metro m√°s grande para m√≥viles con proporciones √°ureas */
    @media (max-width: 768px) {
      #cronometro-container {
  position: relative !important; /* deja fluir bajo el mensaje */
  top: auto !important;
  left: auto !important;
  transform: none !important;
  width: 92vw !important;
  height: auto !important;
  max-width: 480px !important;
  padding: 18px 16px !important;
  margin: 12px auto 40px auto !important; /* espacio bajo el mensaje */
  z-index: 5 !important;
  box-shadow: 0 12px 30px rgba(0,0,0,0.25) !important;
  border-radius: 18px !important;
  background: #ffffff !important;
  border: 2px solid #d9e2ec !important;
  display: flex !important;
  flex-direction: column !important;
  justify-content: center !important;
  align-items: center !important;
      }
      
      #cronometro-display {
  font-size: 3.6rem !important; /* reducido para no chocar */
  margin: 0.25rem 0 0.35rem 0 !important;
  line-height: 1 !important;
  font-weight: 800 !important;
  color: #1e3a8a !important;
  text-shadow: 1px 1px 3px rgba(0,0,0,0.08) !important;
  font-family: 'Courier New', 'SF Mono', monospace !important;
  letter-spacing: -1px !important;
      }
      
      .cronometro-title {
  font-size: 1.15rem !important;
  margin-bottom: 0.35rem !important;
  font-weight: 600 !important;
  color: #334155 !important;
  text-align: center !important;
      }
      
      .cronometro-message {
  font-size: 0.95rem !important;
  margin-top: 0.4rem !important;
  line-height: 1.25 !important;
  font-weight: 500 !important;
  color: #64748b !important;
  text-align: center !important;
  padding: 0 6px !important;
      }
    }
    
    /* Para m√≥viles muy peque√±os - ajustar para mantener proporciones */
    @media (max-width: 480px) {
      #cronometro-container {
  width: 94vw !important;
  height: auto !important;
  max-width: 440px !important;
  padding: 16px 14px !important;
  margin: 10px auto 34px auto !important;
      }
      
      #cronometro-display {
  font-size: 3.2rem !important;
  letter-spacing: -0.5px !important;
      }
      
      .cronometro-title {
  font-size: 1.05rem !important;
  margin-bottom: 0.3rem !important;
      }
      
      .cronometro-message {
  font-size: 0.85rem !important;
  margin-top: 0.3rem !important;
      }
    }
    
    /* Para m√≥viles extra peque√±os */
    @media (max-width: 320px) {
      #cronometro-container {
        width: 96vw !important;
        height: auto !important;
      }
      
      #cronometro-display {
        font-size: 2.9rem !important;
      }
      
      .cronometro-title {
        font-size: 0.95rem !important;
      }
      
      .cronometro-message {
        font-size: 0.8rem !important;
      }
    }

    /* Mensaje de turno separado y con espacio asegurado arriba */
    #estado.turno-activo-msg {
      margin-top: 6vh !important;
      margin-bottom: 4px !important;
      padding: 6px 8px !important;
      line-height: 1.25 !important;
      z-index: 10 !important;
      position: relative !important;
      text-align: center !important;
      display: block !important;
    }
    @media (max-width:768px){
      #estado.turno-activo-msg { font-size: 1.55rem !important; }
    }
    @media (max-width:480px){
      #estado.turno-activo-msg { font-size: 1.35rem !important; }
    }
    
    .cronometro-content {
      text-align: center !important;
    }
    
    .cronometro-title {
      font-size: 1.2rem !important;
      margin-bottom: 10px !important;
      color: #374151 !important;
    }
    
    .cronometro-message {
      font-size: 0.9rem !important;
      color: #6b7280 !important;
      margin-top: 10px !important;
    }
    
    /* Estilos para alerta de notificaci√≥n */
    .notification-prompt {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #3b82f6;
      color: white;
      padding: 1rem 2rem;
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      z-index: 1000;
      animation: slideDown 0.3s ease-out;
    }
    
    /* Estilos para el bot√≥n de cancelar turno */
    .cancelar-turno-container {
      text-align: center;
      margin: 30px auto;
      padding: 20px;
      max-width: 300px;
    }
    
    .btn-cancelar-turno {
      background: linear-gradient(135deg, #ef4444, #dc2626);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
      width: 100%;
      max-width: 250px;
    }
    
    .btn-cancelar-turno:hover {
      background: linear-gradient(135deg, #dc2626, #b91c1c);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
    }
    
    .btn-cancelar-turno:active {
      transform: translateY(0);
      box-shadow: 0 2px 4px rgba(239, 68, 68, 0.3);
    }
    
    .cancelar-ayuda {
      font-size: 0.8rem;
      color: #6b7280;
      margin-top: 10px;
      line-height: 1.3;
    }
    
    /* Ocultar bot√≥n de cancelar cuando tiene mesa asignada */
    .tiene-mesa #cancelar-turno-container {
      display: none !important;
    }
    
    
    /* Forzar visibilidad del cron√≥metro */
    .cronometro-container:not(.hidden) {
      display: block !important;
      visibility: visible !important;
      opacity: 1 !important;
    }
    /* Asegurar que si tiene la clase hidden realmente no se muestre (refuerzo) */
    #cronometro-container.hidden {
      display: none !important;
      visibility: hidden !important;
      opacity: 0 !important;
    }
    
    /* Ajuste espec√≠fico para dispositivos ~360x720 (Android comunes) */
    @media (max-width: 400px) and (min-height: 640px) {
      #cronometro-container {
        width: 92vw !important;
        /* altura m√≠nima 30% pantalla */
        min-height: 30vh !important;
        height: auto !important;
        padding: 28px 18px !important;
        border-width: 3px !important;
      }
      #cronometro-display {
        font-size: 5.2rem !important;
        letter-spacing: -1px !important;
      }
      .cronometro-title { font-size: 1.25rem !important; }
      .cronometro-message { font-size: 1.05rem !important; }
    }

    /* Si la altura disponible es muy baja (teclado abierto / landscape) */
    @media (max-width: 400px) and (max-height: 540px) {
      #cronometro-container {
        position: fixed !important;
        top: 8vh !important;
        transform: translate(-50%, 0) !important;
        min-height: 32vh !important;
        width: 94vw !important;
      }
      #cronometro-display { font-size: 4.4rem !important; }
    }

    /* Forzar que siempre tenga >30% altura cuando est√© visible */
    #cronometro-container:not(.hidden) {
      min-height: 30vh !important;
    }

    body.turno-activo #cronometro-container:not(.hidden){
      margin-top: 12px !important;
    }

    .turno-wrapper { display:flex; flex-direction:column; align-items:center; gap:1.2rem; width:100%; }
    .turno-mensaje { text-align:center; font-weight:700; font-size:2rem; line-height:1.15; }
    .turno-mesa { display:block; margin-top:0.35rem; font-size:1.15rem; font-weight:600; }
    @media (max-width:768px){
      .turno-mensaje { font-size:1.75rem; }
      .turno-mesa { font-size:1.1rem; }
    }
    /* Estado cuando se activa el turno: empujar cron√≥metro m√°s abajo si no cabe */
    @media (max-width:768px){
      body.turno-activo #cronometro-container:not(.hidden){
        position:static !important; /* dejar que fluya debajo del texto */
        transform:none !important;
        width:100% !important;
        height:auto !important;
        margin-top:0.5rem !important;
      }
    }

    /* ---------------- Ajustes espec√≠ficos para pantallas angostas (~360px) ---------------- */
    @media (max-width: 500px) {
      main { padding-top: 14vh !important; }
      .tiempo-espera-promedio { padding: 0.85rem 0.9rem !important; }
      .msj-bienvenida, .msj-actualmente, .msj-tu-numero, .msj-estado {
        font-size: 0.95rem !important;
        line-height: 1.3 !important; /* fix readability */
        white-space: normal !important;
        overflow-wrap: anywhere !important;
        word-break: break-word !important;
        margin-bottom: 0.55rem !important;
      }
      .msj-bienvenida { font-weight: 600 !important; }
      .msj-tu-numero strong, .msj-actualmente strong { font-size: 1.05rem !important; }
      /* Evitar que el cron√≥metro reserve espacio antes de mostrarse */
      #cronometro-container.hidden { min-height: 0 !important; margin:0 !important; padding:0 !important; border:0 !important; }
    }
    /* Correcci√≥n de typo en line-height (override) */
    @media (max-width: 400px) {
      .msj-bienvenida, .msj-actualmente, .msj-tu-numero, .msj-estado { line-height: 1.3 !important; }
    }

    /* Bot√≥n/enlace al Men√∫ */
    .menu-link-wrap { display:flex; justify-content:center; margin-top: 10px; }
    .menu-link {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: linear-gradient(135deg, #1e3a8a, #2563eb);
      color: #ffffff;
      text-decoration: none;
      padding: 10px 16px;
      border-radius: 10px;
      font-weight: 700;
      box-shadow: 0 6px 16px rgba(37, 99, 235, 0.35);
      transition: transform 0.15s ease, box-shadow 0.2s ease;
    }
    .menu-link:hover { transform: translateY(-1px); box-shadow: 0 10px 22px rgba(37, 99, 235, 0.45); }
    .menu-link:active { transform: translateY(0); box-shadow: 0 4px 12px rgba(37, 99, 235, 0.35); }
    .menu-link .icon { font-size: 1.2rem; line-height: 1; }
    @media (max-width: 480px){ .menu-link { padding: 10px 14px; border-radius: 9px; } }
  </style>
</head>
<body>
  <!-- Header con logo -->
  <header class="top-header">
    <img class="logo-header" src="{{ url_for('static', filename='images/logo-alleria.png') }}" alt="logo-alleria" />
    <div></div> <!-- Espacio vac√≠o para mantener el logo a la izquierda -->
  </header>

  <main class="main">
    <div class="info-bienvenida">
      <div class="tiempo-espera-promedio">
        <p class="msj-bienvenida" id="bienvenida">Bienvenid@ {% if nombre %}{{ nombre }}{% endif %}</p>
        <p class="msj-actualmente" id="actualmente">Actualmente atendiendo al n√∫mero: <strong id="atendiendo"></strong></p>

        <p class="msj-tu-numero" id="tu-numero">Tu n√∫mero en la fila es: <strong>{{ numero }}</strong></p>
        {% if llegada_cola %}
          <p class="msj-estado" id="llegada-cola">Hora de llegada:  <span id="hora-llegada"></span></p>
        {% endif %}
        
        <p class="msj-estado" id="estado" style="text-align:center;">Esperando tu turno...</p>


      </div>

      <div class="tiempo-espera-promedio" id="menu-card">
        <p class="msj-menu">Comienza tu experiencia con nosotros <span>
            <!-- Enlace al Men√∫ -->
          <div class="menu-link-wrap">
            <a class="menu-link" href="https://menu.fu.do/alleria/qr-menu?fbclid=PAZnRzaAM1d1ABplYcM7ZWXntJRWEMG5HghxzkBkMSppj4jewlMbzTJ1gxsBBl-XyzjUz_tw" target="_blank" rel="noopener noreferrer">
              <span class="icon">üçΩÔ∏è</span>
              <span>Menu</span>
            </a>
            <button id="btn-ordenar" class="menu-link" style="margin-left:10px; background: linear-gradient(135deg,#047857,#059669);">
              <span class="icon">üìù</span>
              <span>Ordenar ahora</span>
            </button>
            <!-- Icono de informaci√≥n sobre ordenar -->
            <button type="button" onclick="toggleMenuInfoPopover()" aria-label="Informaci√≥n sobre ordenar"
                    style="margin-left:10px; background:none; border:none; cursor:pointer; color:#6b7280; font-size:1.1rem;">
              ‚ÑπÔ∏è
            </button>
          </div>
        </span></p>
        <!-- Popover informativo del men√∫/orden -->
        <div id="menu-info-popover" class="popover-info hidden">
          <div class="popover-content">
            <p><strong>‚ÑπÔ∏è Ordenar por adelantado</strong></p>
            <p>Si anotas tu pedido con anticipaci√≥n y a√∫n no has llegado cuando sea tu turno, podremos empezar a prepararlo. Al llegar al restaurante, te pediremos confirmarlo para que tengas la opci√≥n de hacer cualquier ajuste que desees..</p>
            <button onclick="toggleMenuInfoPopover()" class="popover-close">Entendido</button>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Bot√≥n para activar notificaciones (oculto por defecto) -->
    <div id="notification-prompt" class="notification-prompt hidden">
      <p class="notification-message">üì± Activa las notificaciones para saber cuando sea tu turno</p>
      <button onclick="solicitarPermisoNotificaciones()" class="notification-button">
        üîî Activar Notificaciones
      </button>
    </div>
    
  <!-- Cron√≥metro de 5 minutos (oculto inicialmente) -->
    <div id="cronometro-container" class="cronometro-container hidden">
      <div class="cronometro-content">
        <h3 class="cronometro-title">‚è∞ Tiempo para llegar</h3>
        <div class="cronometro-display" id="cronometro-display">10:00</div>
  <p class="cronometro-message">¬°Tienes 5 minutos para llegar a tu mesa!</p>
      </div>
    </div>
    
    <br>
    <div class="tiempo-espera-promedio" id="tiempo-espera-container">
      <p class="msj-tiempo-espera" id="tiempo-espera" onclick="toggleInfoPopover()" style="cursor: pointer;">
        ‚è±Ô∏è Tiempo de espera estimado: <strong id="tiempo-promedio">Calculando...</strong>
        <span style="font-size: 0.8em; color: #6b7280; margin-left: 8px;">‚ÑπÔ∏è</span>
      </p>
      
      <!-- Popover informativo -->
      <div id="info-popover" class="popover-info hidden">
        <div class="popover-content">
          <p><strong>‚ÑπÔ∏è Informaci√≥n sobre el tiempo de espera:</strong></p>
          <p>El tiempo de espera puede variar y este es solo una estimaci√≥n. El tiempo se calcula en base al tiempo de espera de los √∫ltimos 6 comensales en la fila.</p>
          <button onclick="toggleInfoPopover()" class="popover-close">Entendido</button>
        </div>
      </div>
    </div>

    <!-- CTA: Avisar que viene en camino (aparece desde que falten 10 min) -->
    <div id="en-camino-container" class="tiempo-espera-promedio hidden" style="display:none;">
      <p class="msj-estado" style="text-align:center; margin-bottom:8px;">¬øVienes en camino?</p>
      <div style="display:flex; justify-content:center; gap:10px;">
        <button id="btn-en-camino" style="background:#2563eb; color:#fff; border:none; padding:10px 16px; border-radius:10px; font-weight:700;">
          üö∂ Ya voy en camino
        </button>
        <span id="estado-en-camino" class="hidden" style="color:#16a34a; font-weight:700; align-self:center;">‚úîÔ∏è En camino</span>
      </div>
    </div>
    
    <!-- Bot√≥n para cancelar turno (solo visible mientras espera) -->
    <div id="cancelar-turno-container" class="cancelar-turno-container">
      <button id="btn-cancelar-turno" onclick="confirmarCancelacion()" class="btn-cancelar-turno">
        ‚ùå Cancelar mi turno
      </button>
      <p class="cancelar-ayuda">Si tienes alg√∫n inconveniente, puedes cancelar tu lugar en la fila</p>
    </div>
  </main>

  <!-- Modal Orden Previa -->
  <div id="modal-orden" class="hidden" style="position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:9999; align-items:center; justify-content:center; display:none;">
    <div style="background:white; width:92%; max-width:560px; border-radius:12px; padding:18px; max-height:85vh; overflow:auto;">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
        <h3 style="font-size:1.2rem; font-weight:700;">üìù Tu orden previa</h3>
        <button id="cerrar-modal-orden" style="background:#ef4444; color:white; border:none; padding:6px 10px; border-radius:8px;">Cerrar</button>
      </div>
      <p style="color:#475569; font-size:0.95rem; margin-bottom:12px;">Completa lo que quiere cada persona. Esto nos ayuda a agilizar cuando llegues a tu mesa.</p>
      <form id="form-orden">
        <div id="personas-container" style="display:flex; flex-direction:column; gap:12px;"></div>
        <div style="display:flex; gap:10px; margin-top:14px;">
          <button type="submit" style="flex:1; background:#2563eb; color:white; border:none; padding:12px; border-radius:10px; font-weight:700;">Guardar orden</button>
          <button type="button" id="limpiar-orden" style="background:#94a3b8; color:white; border:none; padding:12px; border-radius:10px;">Limpiar</button>
        </div>
        <p id="estado-orden" style="margin-top:10px; font-size:0.9rem; color:#16a34a; display:none;">Orden guardada ‚úÖ</p>
      </form>
    </div>
  </div>

  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
  <script>
  const id = {{ numero|tojson }};
  const mesaAsignadaInicial = {{ mesa_asignada|tojson }};
  const mesaAsignadaAtInicial = {{ mesa_asignada_at|tojson }};
  const llegadaColaISO = {{ llegada_cola|tojson }};
  const cantidadComensales = {{ (cantidad_comensales or 1)|tojson }};
  const ordenPreviaInicial = {{ (orden_previa_json or None)|tojson }};
  const enCaminoInicial = {{ en_camino|tojson }};
  const socket = io();
  let cronometroInterval = null;
  let cronometroAsignacion = null; // Date del momento de asignaci√≥n para c√°lculo absoluto
  let enCaminoMarcado = !!enCaminoInicial;
  
  // Si ya viene mesa asignada al cargar, ocultar men√∫ y bot√≥n de ordenar
  (function ocultarMenuSiTieneMesaInicial(){
    try {
      if (mesaAsignadaInicial) {
        const menuCard = document.getElementById('menu-card');
        if (menuCard) menuCard.style.display = 'none';
        const modal = document.getElementById('modal-orden');
        if (modal) { modal.classList.add('hidden'); modal.style.display = 'none'; }
      }
    } catch (e) { /* noop */ }
  })();
  
  // Mostrar solo la hora de llegada en formato HH:MM (sin d√≠a/mes)
  function mostrarHoraLlegada() {
    try {
      // Si ya hay mesa asignada, no mostrar la hora de llegada
      if (mesaAsignadaInicial) {
        const cont = document.getElementById('llegada-cola');
        if (cont) cont.style.display = 'none';
        return;
      }
      if (!llegadaColaISO) return;
      const d = new Date(llegadaColaISO);
      if (isNaN(d.getTime())) return;
      const hh = d.getHours().toString().padStart(2,'0');
      const mm = d.getMinutes().toString().padStart(2,'0');
      const el = document.getElementById('hora-llegada');
      if (el) el.textContent = `${hh}:${mm}`;
    } catch (e) {
      console.warn('No se pudo formatear hora de llegada:', e);
    }
  }

  function ocultarHoraLlegada() {
    const cont = document.getElementById('llegada-cola');
    if (cont) cont.style.display = 'none';
  }

  // ======== Cierre de sesi√≥n del cliente ========
  async function cerrarSesionCliente(motivo = '') {
    try {
      await fetch('/logout_cliente', { method: 'POST' });
    } catch (e) {
      console.warn('No se pudo cerrar sesi√≥n por fetch, redirigiendo igual:', e);
    } finally {
      // Garantizar que el tel√©fono pueda reutilizar el QR
      window.location.href = '/qr_landing';
    }
  }

    // ==================== SISTEMA DE NOTIFICACIONES PUSH ====================
    
    // Verificar soporte para notificaciones
    if ('serviceWorker' in navigator && 'PushManager' in window) {
      console.log('El navegador soporta notificaciones push');
    } else {
      console.log('El navegador NO soporta notificaciones push');
    }

    // Registrar Service Worker
    async function registrarServiceWorker() {
      try {
        const registration = await navigator.serviceWorker.register('/static/sw.js');
        console.log('Service Worker registrado:', registration);
        return registration;
      } catch (error) {
        console.error('Error registrando Service Worker:', error);
        return null;
      }
    }

    // Solicitar permisos de notificaci√≥n
    async function solicitarPermisoNotificaciones() {
      try {
        const permission = await Notification.requestPermission();
        console.log('Permiso de notificaciones:', permission);
        
        if (permission === 'granted') {
          mostrarNotificacionBienvenida();
          // Ocultar el bot√≥n de solicitud de permisos
          document.getElementById('notification-prompt').classList.add('hidden');
          return true;
        } else {
          console.log('Permisos de notificaci√≥n denegados');
          // Mostrar el bot√≥n para volver a solicitar permisos
          document.getElementById('notification-prompt').classList.remove('hidden');
          return false;
        }
      } catch (error) {
        console.error('Error solicitando permisos:', error);
        return false;
      }
    }

    // Mostrar notificaci√≥n de bienvenida
    function mostrarNotificacionBienvenida() {
      if (Notification.permission === 'granted') {
        new Notification('üçΩÔ∏è Restaurante Alleria', {
          body: 'Te notificaremos cuando sea tu turno. ¬°Mant√©n las notificaciones activadas!',
          icon: '/static/images/logo-alleria.png',
          badge: '/static/images/logo-alleria.png'
        });
      }
    }

    // Mostrar notificaci√≥n cuando sea el turno
    function mostrarNotificacionTurno(mesa) {
      console.log('üîî === INICIO NOTIFICACI√ìN TURNO ===');
      console.log('üì± Mesa asignada:', mesa);
      console.log('üîî Permission:', Notification.permission);
      console.log('üëÅÔ∏è Visibility:', document.visibilityState);
      console.log('üåê Online:', navigator.onLine);
      
      // M√©todo 1: Notificaci√≥n web est√°ndar
      if (Notification.permission === 'granted') {
        try {
          const notificacion = new Notification('üéâ ¬°Es tu turno!', {
            body: `Tu mesa ${mesa} est√° lista. Tienes 5 minutos para llegar.`,
            icon: '/static/images/logo-alleria.png',
            badge: '/static/images/logo-alleria.png',
            vibrate: [500, 200, 500, 200, 500, 200, 500], // Vibraci√≥n m√°s intensa y larga
            requireInteraction: true, // Mantiene la notificaci√≥n hasta que el usuario interact√∫e
            tag: 'turno-mesa', // Evita notificaciones duplicadas
            renotify: true,
            silent: false, // Asegurar que no sea silenciosa
            data: { mesa: mesa, timestamp: Date.now() }
          });

          // Cerrar autom√°ticamente despu√©s de 60 segundos
          setTimeout(() => {
            notificacion.close();
          }, 60000);

          // Manejar clic en la notificaci√≥n
          notificacion.onclick = function() {
            window.focus();
            notificacion.close();
          };
          
          console.log('‚úÖ Notificaci√≥n web creada exitosamente');
        } catch (error) {
          console.error('‚ùå Error creando notificaci√≥n web:', error);
        }
      } else {
        console.log('‚ùå Permisos de notificaci√≥n no concedidos');
      }
      
      // M√©todo 2: Service Worker (para notificaciones en segundo plano)
      if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
        try {
          navigator.serviceWorker.controller.postMessage({
            type: 'SHOW_NOTIFICATION',
            title: 'üéâ ¬°Es tu turno!',
            body: `Tu mesa ${mesa} est√° lista. Tienes 5 minutos para llegar.`,
            mesa: mesa
          });
          console.log('‚úÖ Mensaje enviado al Service Worker');
        } catch (error) {
          console.error('‚ùå Error enviando mensaje al SW:', error);
        }
      }
      
      // M√©todo 3: Alerta visual en la p√°gina (siempre funciona)
      mostrarAlertaVisual(mesa);
      
      // M√©todo 4: Intentar despertar la p√°gina con vibraci√≥n y sonido
      intentarDespertarDispositivo();
      
      // M√©todo 5: Crear alerta visual superpuesta
      crearAlertaSuperpuesta(mesa);
      
      console.log('üîî === FIN NOTIFICACI√ìN TURNO ===');
    }
    
    // Nueva funci√≥n: Alerta visual que siempre funciona
    function mostrarAlertaVisual(mesa) {
      // Cambiar el t√≠tulo de la p√°gina (se ve en la pesta√±a)
      document.title = `üéâ ¬°Es tu turno! Mesa ${mesa}`;
      
      // Cambiar favicon para que parpadee
      let faviconLink = document.querySelector('link[rel="icon"]');
      if (!faviconLink) {
        faviconLink = document.createElement('link');
        faviconLink.rel = 'icon';
        document.head.appendChild(faviconLink);
      }
      
      // Alternar favicon cada 500ms durante 10 segundos
      let faviconToggle = 0;
      const faviconInterval = setInterval(() => {
        faviconLink.href = faviconToggle % 2 === 0 ? 
          '/static/images/logo-alleria.png' : 
          'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y=".9em" font-size="90">üéâ</text></svg>';
        faviconToggle++;
      }, 500);
      
      // Parar el parpadeo despu√©s de 10 segundos
      setTimeout(() => {
        clearInterval(faviconInterval);
        faviconLink.href = '/static/images/logo-alleria.png';
        document.title = 'Cliente - Restaurante Alleria';
      }, 10000);
      
      console.log('‚úÖ Alerta visual activada');
    }
    
    // Nueva funci√≥n: Intentar despertar dispositivo
    function intentarDespertarDispositivo() {
      // Vibraci√≥n si est√° disponible
      if (navigator.vibrate) {
        navigator.vibrate([500, 200, 500, 200, 500]);
        console.log('üì≥ Vibraci√≥n activada');
      }
      
      // Reproducir sonido de notificaci√≥n
      try {
        const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmUUBj2Z2u/JSSUK');
        audio.play().catch(e => console.log('‚ùå No se pudo reproducir sonido:', e));
        console.log('üîä Intentando reproducir sonido');
      } catch (e) {
        console.log('‚ùå Error con audio:', e);
      }
      
      // Intentar forzar enfoque en la ventana
      if (window.focus) {
        window.focus();
      }
      
      // Intentar Wake Lock si est√° disponible
      if ('wakeLock' in navigator) {
        navigator.wakeLock.request('screen')
          .then(() => console.log('üîã Wake Lock activado temporalmente'))
          .catch(e => console.log('‚ùå Wake Lock no disponible:', e));
      }
    }
    
    // Nueva funci√≥n: Crear alerta visual superpuesta
    function crearAlertaSuperpuesta(mesa) {
      // Remover alerta anterior si existe
      const alertaAnterior = document.getElementById('alerta-turno');
      if (alertaAnterior) {
        alertaAnterior.remove();
      }
      
      // Crear overlay de alerta
      const overlay = document.createElement('div');
      overlay.id = 'alerta-turno';
      overlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.9);
        z-index: 10000;
        display: flex;
        align-items: center;
        justify-content: center;
        animation: pulse 1s infinite;
      `;
      
      // Crear contenido de la alerta
      overlay.innerHTML = `
        <div style="
          background: white;
          padding: 2rem;
          border-radius: 1rem;
          text-align: center;
          max-width: 90%;
          box-shadow: 0 20px 50px rgba(0,0,0,0.5);
          border: 3px solid #22c55e;
        ">
          <div style="font-size: 4rem; margin-bottom: 1rem;">üéâ</div>
          <h2 style="font-size: 2rem; color: #22c55e; margin-bottom: 1rem; font-weight: bold;">
            ¬°ES TU TURNO!
          </h2>
          <p style="font-size: 1.2rem; margin-bottom: 1rem; color: #333;">
            Tu mesa <strong>${mesa}</strong> est√° lista
          </p>
          <p style="color: #666; margin-bottom: 2rem;">
            Tienes 5 minutos para llegar
          </p>
          <button onclick="document.getElementById('alerta-turno').remove()" 
                  style="
                    background: #22c55e;
                    color: white;
                    padding: 1rem 2rem;
                    border: none;
                    border-radius: 0.5rem;
                    font-size: 1.1rem;
                    cursor: pointer;
                    font-weight: bold;
                  ">
            ¬°Entendido!
          </button>
        </div>
      `;
      
      // Agregar al documento
      document.body.appendChild(overlay);
      
      // Auto-remover despu√©s de 30 segundos
      setTimeout(() => {
        if (document.getElementById('alerta-turno')) {
          document.getElementById('alerta-turno').remove();
        }
      }, 30000);
      
      console.log('‚úÖ Alerta superpuesta creada');
    }

    // Inicializar notificaciones al cargar la p√°gina
    window.addEventListener('load', async () => {
      // Mostrar la hora de llegada de inmediato
      mostrarHoraLlegada();
      // Al cargar, intentamos obtener el tiempo para evaluar el pre-aviso temprano
      try { actualizarTiempoEsperaPromedio(); } catch(e) {}
      if ('serviceWorker' in navigator && 'Notification' in window) {
        await registrarServiceWorker();
        
        // Solicitar permisos autom√°ticamente despu√©s de 2 segundos
        setTimeout(async () => {
          if (Notification.permission === 'default') {
            await solicitarPermisoNotificaciones();
          }
        }, 2000);
      }
      
      // Intentar mantener la pantalla activa (Wake Lock API)
      if ('wakeLock' in navigator) {
        try {
          const wakeLock = await navigator.wakeLock.request('screen');
          console.log('üîã Wake Lock activado - pantalla se mantendr√° activa');
          
          // Manejar cuando el usuario cambia de pesta√±a
          document.addEventListener('visibilitychange', async () => {
            if (wakeLock !== null && document.visibilityState === 'visible') {
              const newWakeLock = await navigator.wakeLock.request('screen');
              console.log('üîã Wake Lock reactivado');
            }
          });
        } catch (err) {
          console.log('‚ùå No se pudo activar Wake Lock:', err);
        }
      }
      
      // Registrar eventos para mantener conexi√≥n activa y detectar cambios de pesta√±a
      let lastVisibilityCheck = Date.now();
      let wasHidden = false;
      
      document.addEventListener('visibilitychange', () => {
        const now = Date.now();
        const timeSinceLastCheck = now - lastVisibilityCheck;
        
        console.log('üëÅÔ∏è Cambio de visibilidad detectado:', {
          estado: document.visibilityState,
          tiempoOculto: wasHidden ? timeSinceLastCheck : 0,
          socketConectado: socket.connected
        });
        
        if (document.visibilityState === 'visible') {
          console.log('‚úÖ P√°gina ahora visible - verificando estado...');
          
          // Si estuvo oculta por m√°s de 1 segundo, forzar reconexi√≥n
          if (wasHidden && timeSinceLastCheck > 1000) {
            console.log('üîÑ Reconectando despu√©s de estar oculta...');
            
            // Forzar reconexi√≥n del socket
            if (socket.connected) {
              socket.disconnect();
            }
            socket.connect();
            
            // Re-registrar cliente despu√©s de un momento
            setTimeout(() => {
              console.log('üìù Re-registrando cliente despu√©s de reconexi√≥n...');
              socket.emit("registrar_cliente", { id: id });
              
              // Verificar estado actual del cliente
              fetch(`/verificar_estado_cliente/${id}`)
                .then(response => response.json())
                .then(data => {
                  console.log('üìä Estado actual del cliente:', data);
                  
                  // Si ya tiene mesa asignada, mostrar notificaci√≥n
                  if (data.mesa_asignada && !notificationShown) {
                    console.log('üéâ Cliente ya ten√≠a mesa asignada:', data.mesa_asignada);
                    lastKnownMesa = data.mesa_asignada;
                    notificationShown = true;
                    
                    mostrarNotificacionTurno(data.mesa_asignada);
                    iniciarCronometro(data.mesa_asignada_at);
                    
                    // Actualizar interfaz
                    const estadoEl = document.getElementById("estado");
                    estadoEl.className = "font-bold text-green-600 turno-activo-msg";
                    estadoEl.innerHTML = `¬°Es tu turno{% if nombre %} {{ nombre }}{% endif %}!<br><span style="font-weight:600;">Ve a la mesa <span style="color:#1e3a8a;">${data.mesa_asignada}</span></span>`;
                    document.getElementById("actualmente").style.display = "none";
                    document.getElementById("atendiendo").style.display = "none";
                    document.getElementById("tu-numero").style.display = "none";
                    document.getElementById("bienvenida").style.display = "none";
                    document.getElementById("tiempo-espera-container").style.display = "none";
                    const llegadaCont = document.getElementById("llegada-cola");
                    if (llegadaCont) llegadaCont.style.display = 'none';
                  }
                })
                .catch(error => {
                  console.error('‚ùå Error verificando estado del cliente:', error);
                });
            }, 1000);
          } else if (!socket.connected) {
            console.log('üîå Socket desconectado, reconectando...');
            socket.connect();
          }
          
          wasHidden = false;
        } else {
          console.log('üëª P√°gina ahora oculta');
          wasHidden = true;
        }
        
        lastVisibilityCheck = now;
      });
      
      // Tambi√©n escuchar eventos de enfoque/desenfoque de la ventana
      window.addEventListener('focus', () => {
        console.log('üéØ Ventana enfocada - verificando conexi√≥n...');
        if (!socket.connected) {
          socket.connect();
        }
      });
      
      window.addEventListener('blur', () => {
        console.log('üí≠ Ventana desenfocada');
      });

      // Restaurar estado si ya hab√≠a mesa asignada (evita re-creaci√≥n tras refresh)
      try {
        if (mesaAsignadaInicial && mesaAsignadaAtInicial) {
          console.log('‚ôªÔ∏è Restaurando estado de turno tras recarga:', mesaAsignadaInicial, mesaAsignadaAtInicial);
          // Actualizar interfaz a estado de turno activo
          const estadoEl = document.getElementById("estado");
          estadoEl.className = "font-bold text-green-600 turno-activo-msg";
          estadoEl.innerHTML = `¬°Es tu turno{% if nombre %} {{ nombre }}{% endif %}!<br><span style="font-weight:600;">Ve a la mesa <span style="color:#1e3a8a;">${mesaAsignadaInicial}</span></span>`;
          document.getElementById("actualmente").style.display = "none";
          document.getElementById("atendiendo").style.display = "none";
          document.getElementById("tu-numero").style.display = "none";
          document.getElementById("bienvenida").style.display = "none";
          document.getElementById("tiempo-espera-container").style.display = "none";
          const llegadaCont2 = document.getElementById('llegada-cola');
          if (llegadaCont2) llegadaCont2.style.display = 'none';

          // Ocultar bot√≥n de cancelar turno cuando ya tiene mesa asignada
          const cancelarContainer = document.getElementById('cancelar-turno-container');
          if (cancelarContainer) {
            cancelarContainer.style.display = 'none';
          }
          
          // Agregar clase para indicar que tiene mesa
          document.body.classList.add('tiene-mesa');

          // Iniciar cron√≥metro desde timestamp absoluto proporcionado por el backend
          iniciarCronometro(mesaAsignadaAtInicial);
        }
      } catch (e) {
        console.error('Error restaurando estado tras refresh:', e);
      }

      // Si no hay mesa asignada al cargar, resetear estado de pre-avisos en esta sesi√≥n
      if (!mesaAsignadaInicial) {
        pre10Shown = false;
        pre5Shown = false;
        entryInitialRemainingSec = null;
        entryUnder10 = false;
        entryUnder5 = false;
        entryEvaluated = false;
      }
    });

    // ========= ORDEN PREVIA (Cliente) =========
    function abrirModalOrden() {
      const modal = document.getElementById('modal-orden');
      modal.classList.remove('hidden');
      modal.style.display = 'flex';
    }
    function cerrarModalOrden() {
      const modal = document.getElementById('modal-orden');
      modal.classList.add('hidden');
      modal.style.display = 'none';
    }
    document.getElementById('btn-ordenar').addEventListener('click', abrirModalOrden);
    document.getElementById('cerrar-modal-orden').addEventListener('click', cerrarModalOrden);
    document.getElementById('limpiar-orden').addEventListener('click', () => {
      document.querySelectorAll('.inp-comida, .inp-bebida, .inp-notas').forEach(i => i.value = '');
      document.getElementById('estado-orden').style.display = 'none';
    });

  function renderOrdenForm() {
      const cont = document.getElementById('personas-container');
      cont.innerHTML = '';
      let base = null;
      try {
        if (ordenPreviaInicial) {
          const parsed = JSON.parse(ordenPreviaInicial);
          if (parsed && Array.isArray(parsed.personas)) base = parsed.personas;
        }
      } catch(e) { base = null; }
      const n = Math.max(1, Number(cantidadComensales) || 1);
      for (let i=0; i<n; i++) {
        const p = base && base[i] ? base[i] : { comida:'', bebida:'', notas:'' };
        const bloque = document.createElement('div');
        bloque.style.cssText = 'border:1px solid #e2e8f0; border-radius:10px; padding:10px;';
        bloque.innerHTML = `
          <div style="font-weight:700; margin-bottom:6px; color:#0f172a;">Persona ${i+1}</div>
          <input class="inp-comida" placeholder="¬øQu√© quiere comer?" value="${(p.comida||'').replace(/"/g,'&quot;')}" style="width:100%; padding:10px; border:1px solid #cbd5e1; border-radius:8px; margin-bottom:6px;"/>
          <input class="inp-bebida" placeholder="¬øQu√© quiere tomar?" value="${(p.bebida||'').replace(/"/g,'&quot;')}" style="width:100%; padding:10px; border:1px solid #cbd5e1; border-radius:8px; margin-bottom:6px;"/>
          <input class="inp-notas" placeholder="Notas o preferencias (opcional)" value="${(p.notas||'').replace(/"/g,'&quot;')}" style="width:100%; padding:10px; border:1px solid #cbd5e1; border-radius:8px;"/>
        `;
        cont.appendChild(bloque);
      }
    }
  // Solo preparar el formulario; NO abrir el modal autom√°ticamente.
  renderOrdenForm();

    document.getElementById('form-orden').addEventListener('submit', async (e) => {
      e.preventDefault();
      const personas = [];
      const comidas = Array.from(document.querySelectorAll('.inp-comida'));
      const bebidas = Array.from(document.querySelectorAll('.inp-bebida'));
      const notas = Array.from(document.querySelectorAll('.inp-notas'));
      for (let i=0; i<comidas.length; i++) {
        personas.push({
          comida: comidas[i].value.trim(),
          bebida: bebidas[i].value.trim(),
          notas: notas[i].value.trim()
        });
      }
      try {
        const resp = await fetch('/guardar_orden_previa', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ personas })
        });
        const data = await resp.json();
        if (data.success) {
          const est = document.getElementById('estado-orden');
          est.textContent = 'Orden guardada ‚úÖ';
          est.style.display = 'block';
          // Cerrar inmediatamente tras guardar
          cerrarModalOrden();
        } else {
          alert('No se pudo guardar la orden: ' + (data.error || 'Error'));
        }
      } catch(err) {
        alert('Error de red al guardar la orden');
      }
    });
    // ========= FIN ORDEN PREVIA =========

    // ==================== FIN SISTEMA DE NOTIFICACIONES ====================

    // Funci√≥n para mostrar/ocultar el popover
    function toggleInfoPopover() {
      const popover = document.getElementById("info-popover");
      popover.classList.toggle("hidden");
    }

    // Popover de informaci√≥n del men√∫/orden
    function toggleMenuInfoPopover() {
      const pop = document.getElementById('menu-info-popover');
      if (pop) pop.classList.toggle('hidden');
    }

    // Cerrar popover al hacer clic fuera de √©l
    document.addEventListener('click', function(event) {
      const popover = document.getElementById('info-popover');
      const tiempoEspera = document.getElementById('tiempo-espera');
      if (popover && !popover.contains(event.target) && tiempoEspera && !tiempoEspera.contains(event.target)) {
        popover.classList.add('hidden');
      }

      const menuPop = document.getElementById('menu-info-popover');
      const menuCard = document.getElementById('menu-card');
      if (menuPop && !menuPop.contains(event.target) && menuCard && !menuCard.contains(event.target)) {
        menuPop.classList.add('hidden');
      }
    });

    // ==================== CANCELAR TURNO ====================
    
    function confirmarCancelacion() {
      const confirmar = confirm(
        "¬øEst√°s seguro de que quieres cancelar tu lugar en la fila?\n\n" +
        "Esta acci√≥n no se puede deshacer y tendr√°s que volver a hacer fila si cambias de opini√≥n."
      );
      
      if (confirmar) {
        cancelarTurno();
      }
    }
    
    async function cancelarTurno() {
      try {
        // Deshabilitar el bot√≥n para evitar clics m√∫ltiples
        const btnCancelar = document.getElementById('btn-cancelar-turno');
        btnCancelar.disabled = true;
        btnCancelar.textContent = '‚è≥ Cancelando...';
        
        const response = await fetch(`/cancelar_turno/${id}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          }
        });
        
        const data = await response.json();
        
        if (data.success) {
          // Mostrar mensaje de confirmaci√≥n
          alert('‚úÖ Tu lugar en la fila ha sido cancelado exitosamente.\n\nGracias por visitarnos. ¬°Esperamos verte pronto!');
          
          // Redirigir al landing page
          window.location.href = '/qr_landing';
        } else {
          // Mostrar error
          alert(`‚ùå Error al cancelar: ${data.error}`);
          
          // Restaurar el bot√≥n
          btnCancelar.disabled = false;
          btnCancelar.textContent = '‚ùå Cancelar mi turno';
        }
      } catch (error) {
        console.error('Error al cancelar turno:', error);
        alert('‚ùå Error de conexi√≥n. Por favor, intenta de nuevo.');
        
        // Restaurar el bot√≥n
        const btnCancelar = document.getElementById('btn-cancelar-turno');
        btnCancelar.disabled = false;
        btnCancelar.textContent = '‚ùå Cancelar mi turno';
      }
    }

    // ==================== FIN CANCELAR TURNO ====================

    // Cron√≥metro robusto (c√°lculo absoluto) similar a l√≥gica de workers
    function iniciarCronometro(asignada_at = null){
      console.log('üïê [CRONOMETRO] init con asignada_at=', asignada_at);
      if(!asignada_at){
        console.warn('‚õî [CRONOMETRO] sin timestamp, no se inicia');
        return;
      }
      const ts = new Date(asignada_at);
      if(isNaN(ts.getTime())){ console.error('‚ùå [CRONOMETRO] timestamp inv√°lido'); return; }
      cronometroAsignacion = ts; // guardar referencia absoluta
      const cont = document.getElementById('cronometro-container');
      const disp = document.getElementById('cronometro-display');
      if(!cont || !disp){ console.error('‚ùå [CRONOMETRO] elementos no encontrados'); return; }
      cont.classList.remove('hidden');
      cont.style.display='block';
      cont.style.visibility='visible';
      // limpiar intervalo anterior
      if(window.cronometroInterval){ clearInterval(window.cronometroInterval); }
  const TOTAL = 300; // 5 min
      function tick(){
        if(!cronometroAsignacion){ clearInterval(window.cronometroInterval); return; }
        const ahora = new Date();
        const trans = Math.floor((ahora - cronometroAsignacion)/1000);
        const restante = Math.max(0, TOTAL - trans);
        const m = Math.floor(restante/60);
        const s = restante % 60;
        disp.textContent = `${m}:${s.toString().padStart(2,'0')}`;
        if(restante <= 120){
          disp.style.color = '#ef4444';
          disp.style.animation = 'pulse 1s infinite';
          disp.style.fontWeight = 'bold';
        } else if(restante <= 300){
          disp.style.color = '#f59e0b';
          disp.style.animation = '';
        } else {
          disp.style.color = '#22c55e';
          disp.style.animation = '';
        }
        if(restante % 5 === 0 || restante <= 10){
          document.title = `‚è∞ ${m}:${s.toString().padStart(2,'0')} - Restaurante Alleria`;
        }
        if(restante === 0){
          disp.textContent = '¬°Tiempo agotado!';
          document.title = '‚è∞ ¬°Tiempo agotado! - Restaurante Alleria';
          clearInterval(window.cronometroInterval);
          // Al expirar el tiempo, cerrar la sesi√≥n del cliente para permitir reutilizar el QR
          cerrarSesionCliente('timeout');
        }
      }
      tick();
      window.cronometroInterval = setInterval(tick,1000);
      console.log('‚úÖ [CRONOMETRO] iniciado');
    }

    // Funci√≥n para obtener y actualizar el tiempo de espera promedio
    function actualizarTiempoEsperaPromedio() {
      fetch('/tiempo_espera_promedio')
        .then(response => response.json())
        .then(data => {
          const minutos = data.promedio_minutos;
          const segundos = data.promedio_segundos;
          const elemento = document.getElementById("tiempo-promedio");
          
          if (minutos <= 5) {
            elemento.textContent = `${minutos} minutos ‚ö°`;
            elemento.style.color = "#22c55e"; // Verde
          } else if (minutos <= 15) {
            elemento.textContent = `${minutos} minutos ‚è∞`;
            elemento.style.color = "#f59e0b"; // Amarillo/Naranja
          } else {
            elemento.textContent = `${minutos} minutos ‚è≥`;
            elemento.style.color = "#ef4444"; // Rojo
          }

          // Evaluar pre-aviso con el valor en segundos
          evaluarPreAviso(segundos);
        })
        .catch(error => {
          console.error('Error obteniendo tiempo de espera:', error);
          document.getElementById("tiempo-promedio").textContent = "No disponible";
        });
    }

    socket.on("connect", () => {
      console.log('üîå Socket conectado exitosamente');
      isConnected = true;
      socket.emit("registrar_cliente", { id: id });
      // Obtener tiempo de espera promedio al conectarse
      actualizarTiempoEsperaPromedio();
      // Mostrar hora de llegada en HH:MM
      mostrarHoraLlegada();
    });

    socket.on("disconnect", (reason) => {
      console.log('‚ùå Socket desconectado:', reason);
      isConnected = false;
      
      // Si la desconexi√≥n no fue intencional, intentar reconectar
      if (reason !== 'io client disconnect') {
        console.log('üîÑ Intentando reconectar en 2 segundos...');
        setTimeout(() => {
          if (!socket.connected) {
            socket.connect();
          }
        }, 2000);
      }
    });

    socket.on("connect_error", (error) => {
      console.error('‚ùå Error de conexi√≥n del socket:', error);
      isConnected = false;
    });

    // El mesero confirm√≥ 'Lleg√≥': cerrar la sesi√≥n del cliente de este dispositivo
    socket.on('cerrar_sesion_cliente', (data) => {
      console.log('üîí Solicitud de cierre de sesi√≥n recibida del servidor:', data);
      cerrarSesionCliente(data && data.motivo ? data.motivo : 'llego');
    });

    // Actualizar tiempo de espera cada 30 segundos
    setInterval(actualizarTiempoEsperaPromedio, 30000);

    // Sistema de heartbeat simplificado para mantener conexi√≥n activa
    let heartbeatInterval;
    
    function iniciarHeartbeat() {
      if (heartbeatInterval) {
        clearInterval(heartbeatInterval);
      }
      
      heartbeatInterval = setInterval(() => {
        if (socket.connected && document.visibilityState === 'visible') {
          console.log('üíì Enviando heartbeat...');
          socket.emit('heartbeat', { 
            cliente_id: id, 
            timestamp: Date.now(),
            page_visible: true
          });
        } else if (!socket.connected) {
          console.log('üíî Socket desconectado durante heartbeat, reconectando...');
          socket.connect();
        }
      }, 30000); // Cada 30 segundos (reducido de 15)
    }
    
    // Iniciar heartbeat cuando se conecte
    socket.on("connect", () => {
      iniciarHeartbeat();
    });
    
    // Detener heartbeat cuando se desconecte
    socket.on("disconnect", () => {
      if (heartbeatInterval) {
        clearInterval(heartbeatInterval);
      }
    });

  let isConnected = false;
  let lastKnownMesa = null;
  let notificationShown = false;
  // Pre-avisos: manejar 10 y 5 minutos de forma independiente y seg√∫n condici√≥n de entrada
  let pre10Shown = false;
  let pre5Shown = false;
  let entryInitialRemainingSec = null; // restante al momento de la primera evaluaci√≥n
  let entryUnder10 = false; // si al entrar ya quedaban <= 10 min
  let entryUnder5 = false;  // si al entrar ya quedaban <= 5 min
  let entryEvaluated = false; // se fij√≥ el valor inicial
    
    socket.on("es_tu_turno", (data) => {
      console.log('üéâ === EVENTO ES_TU_TURNO RECIBIDO ===');
      console.log('üì¶ Data recibida:', data);
      console.log('üåê Ubicaci√≥n:', window.location.href);
      console.log('üì± Plataforma:', navigator.platform);
      console.log('üëÅÔ∏è Documento visible:', document.visibilityState);
      console.log('üîå Socket conectado:', socket.connected);
      
      // Evitar procesar el mismo evento m√∫ltiples veces
      if (lastKnownMesa === data.mesa && notificationShown) {
        console.log('‚ö†Ô∏è Evento duplicado ignorado para mesa', data.mesa);
        return;
      }
      
      lastKnownMesa = data.mesa;
      notificationShown = true;
      
      try {
        // Actualizar elementos de la interfaz
        const estadoElement = document.getElementById("estado");
        const actualmenteElement = document.getElementById("actualmente");
        const atendiendoElement = document.getElementById("atendiendo");
        const tuNumeroElement = document.getElementById("tu-numero");
        const bienvenidaElement = document.getElementById("bienvenida");
        const tiempoEsperaElement = document.getElementById("tiempo-espera-container");
  const llegadaElement = document.getElementById("llegada-cola");
        
        console.log('üîç Elementos encontrados:', {
          estado: !!estadoElement,
          actualmente: !!actualmenteElement,
          atendiendo: !!atendiendoElement,
          tuNumero: !!tuNumeroElement,
          bienvenida: !!bienvenidaElement,
          tiempoEspera: !!tiempoEsperaElement
        });
        
        if (estadoElement) {
          estadoElement.className = "font-bold text-green-600 turno-activo-msg";
          estadoElement.innerHTML = `¬°Es tu turno{% if nombre %} {{ nombre }}{% endif %}!<br><span style="font-weight:600;">Ve a la mesa <span style=\"color:#1e3a8a;\">${data.mesa}</span></span>`;
          console.log('‚úÖ Estado actualizado');
        }
        
        // Ocultar elementos no necesarios, incluyendo la card del men√∫
        const menuCard = document.getElementById('menu-card');
        const enCaminoCta = document.getElementById('en-camino-container');
        [actualmenteElement, atendiendoElement, tuNumeroElement, bienvenidaElement, tiempoEsperaElement, llegadaElement, menuCard, enCaminoCta].forEach((el, index) => {
          if (el) {
            el.style.display = "none";
            console.log(`‚úÖ Elemento ${index + 1} ocultado`);
          }
        });

        // Cerrar el modal de orden si estuviera abierto
        try {
          const modal = document.getElementById('modal-orden');
          if (modal) { modal.classList.add('hidden'); modal.style.display = 'none'; }
        } catch (e) {}
        
        // Ocultar bot√≥n de cancelar turno cuando se asigna mesa
        const cancelarContainer = document.getElementById('cancelar-turno-container');
        if (cancelarContainer) {
          cancelarContainer.style.display = 'none';
          console.log('‚úÖ Bot√≥n de cancelar turno ocultado');
        }
        
        // Agregar clase para indicar que tiene mesa
        document.body.classList.add('tiene-mesa');
        
        // Mostrar notificaci√≥n push con debugging
        console.log('üîî Iniciando proceso de notificaci√≥n...');
        mostrarNotificacionTurno(data.mesa);
        
        // Iniciar cron√≥metro con timestamp de asignaci√≥n
        console.log('‚è∞ Iniciando proceso de cron√≥metro...');
        iniciarCronometro(data.asignada_at);
        
        console.log('‚úÖ Proceso de turno completado exitosamente');
        
      } catch (error) {
        console.error('‚ùå Error procesando evento es_tu_turno:', error);
        console.error('üìã Stack trace:', error.stack);
      }
      
      console.log('üéâ === FIN EVENTO ES_TU_TURNO ===');
    });
    
    socket.on("actualizar_posicion",(data)=>{
      document.getElementById("atendiendo").innerText = Number(data.primero)-1;
    });

    // Actualizar tiempo de espera cuando hay cambios en la cola
    socket.on("actualizar_cola", () => {
      actualizarTiempoEsperaPromedio();
    });

    function mostrarTurnoEnPantalla(nombreCliente, mesa){
      const estado = document.getElementById('estado');
      if(!estado) return;
      document.body.classList.add('turno-activo');
      estado.innerHTML = `<span class="turno-mensaje">¬°Es tu turno ${nombreCliente || ''}!<br><span class="turno-mesa">Ve a la mesa ${mesa}</span></span>`;
    }

    // ==================== PRE-AVISO: Faltan <=10 minutos ====================
    function mostrarNotificacionPreAviso(minsRestantesAprox){
      // Notificaci√≥n web est√°ndar
      if (typeof Notification !== 'undefined' && Notification.permission === 'granted') {
        try {
          const noti = new Notification('‚è≥ Tu turno se acerca', {
            body: `Faltan ~${minsRestantesAprox} minutos para tu turno. Te sugerimos comenzar a caminar hacia el restaurante.`,
            icon: '/static/images/logo-alleria.png',
            badge: '/static/images/logo-alleria.png',
            vibrate: [300, 150, 300],
            tag: 'preaviso-turno',
            renotify: false,
            requireInteraction: false,
            data: { tipo: 'preaviso', timestamp: Date.now() }
          });
          setTimeout(() => noti.close(), 20000);
        } catch (e) { console.warn('No se pudo crear notificaci√≥n de preaviso:', e); }
      }

      // Notificaci√≥n via Service Worker (si est√° activo)
      if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
        try {
          navigator.serviceWorker.controller.postMessage({
            type: 'SHOW_NOTIFICATION',
            title: '‚è≥ Tu turno se acerca',
            body: `Faltan ~${minsRestantesAprox} minutos para tu turno. Te sugerimos comenzar a caminar hacia el restaurante.`
          });
        } catch (e) { console.warn('SW preaviso no disponible:', e); }
      }

      // Alerta visual superpuesta (mismo estilo que turno)
      crearAlertaPreAviso(minsRestantesAprox);
    }

    function crearAlertaPreAviso(minsRestantesAprox){
      // Remover si ya existe
      const anterior = document.getElementById('alerta-preaviso');
      if (anterior) anterior.remove();

      const overlay = document.createElement('div');
      overlay.id = 'alerta-preaviso';
      overlay.style.cssText = `
        position: fixed;
        top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0, 0, 0, 0.85);
        z-index: 9999;
        display: flex; align-items: center; justify-content: center; animation: pulse 1s infinite;`;

      overlay.innerHTML = `
        <div style="
          background: white; padding: 1.75rem; border-radius: 1rem;
          text-align: center; max-width: 92%; box-shadow: 0 20px 50px rgba(0,0,0,0.45);
          border: 3px solid #2563eb;">
          <div style="font-size: 3rem; margin-bottom: 0.75rem;">‚è≥</div>
          <h2 style="font-size: 1.6rem; color: #1e3a8a; margin-bottom: 0.5rem; font-weight: 800;">
            ¬°Tu turno se acerca!
          </h2>
          <p style="font-size: 1.05rem; margin-bottom: 0.75rem; color: #111827;">
            Faltan aproximadamente <strong>${minsRestantesAprox} minutos</strong> para tu turno.
          </p>
          <p style="color: #374151; margin-bottom: 1.25rem;">
            Te sugerimos comenzar a caminar hacia el restaurante.
          </p>
          <button onclick="document.getElementById('alerta-preaviso').remove()"
            style="background:#2563eb; color:#fff; padding:0.8rem 1.3rem; border:none; border-radius:0.5rem; font-weight:700; cursor:pointer;">
            Entendido
          </button>
        </div>`;
      document.body.appendChild(overlay);
      setTimeout(() => { if (document.getElementById('alerta-preaviso')) document.getElementById('alerta-preaviso').remove(); }, 20000);
    }

    function evaluarPreAviso(promedioSegundos){
      try {
        if (notificationShown) return; // ya le toc√≥
        if (mesaAsignadaInicial) return; // ya ven√≠a con mesa
        if (!llegadaColaISO) return; // sin hora de llegada

        const llegada = new Date(llegadaColaISO);
        if (isNaN(llegada.getTime())) return;
        const ahora = new Date();
        const estimadoTurno = new Date(llegada.getTime() + (Number(promedioSegundos) || 0) * 1000);
        const diffSec = Math.floor((estimadoTurno - ahora) / 1000);

        // Fijar condici√≥n de entrada una √∫nica vez (primera evaluaci√≥n v√°lida)
        if (!entryEvaluated) {
          entryInitialRemainingSec = diffSec;
          entryUnder10 = entryInitialRemainingSec <= 600;
          entryUnder5 = entryInitialRemainingSec <= 300;
          entryEvaluated = true;
        }

        // Si al entrar quedaban <=5 min: no mostrar ning√∫n pre-aviso (ni 10 ni 5)
        if (entryUnder5) return;

        // Aviso de 10 min: solo si al entrar quedaban >10 min
        if (!entryUnder10 && !pre10Shown && diffSec > 0 && diffSec <= 600) {
          const minsAprox10 = Math.max(1, Math.ceil(diffSec / 60));
          mostrarNotificacionPreAviso(minsAprox10);
          pre10Shown = true;
          // Mostrar CTA de 'en camino' desde este momento
          mostrarCTAEnCamino();
        }

        // Aviso de 5 min: solo si al entrar quedaban >5 min
        if (!pre5Shown && diffSec > 0 && diffSec <= 300) {
          const minsAprox5 = Math.max(1, Math.ceil(diffSec / 60));
          mostrarNotificacionPreAviso(minsAprox5);
          pre5Shown = true;
        }

        // Si ya pasamos el umbral de 10 min y al entrar quedaban >10 min, asegurar CTA visible
        if (!entryUnder10 && diffSec > 0 && diffSec <= 600) {
          mostrarCTAEnCamino();
        }
      } catch (e) {
        console.warn('No se pudo evaluar pre-aviso:', e);
      }
    }

    function mostrarCTAEnCamino(){
      try {
        const cont = document.getElementById('en-camino-container');
        const btn = document.getElementById('btn-en-camino');
        const est = document.getElementById('estado-en-camino');
        if (!cont || !btn || !est) return;
        cont.classList.remove('hidden');
        cont.style.display = 'block';
        if (enCaminoMarcado) {
          btn.disabled = true;
          btn.style.opacity = '0.6';
          est.classList.remove('hidden');
        }
      } catch(e) { /* noop */ }
    }

    // Click en "Ya voy en camino"
    (function bindEnCamino(){
      const btn = document.getElementById('btn-en-camino');
      if (!btn) return;
      btn.addEventListener('click', async () => {
        try {
          btn.disabled = true;
          btn.textContent = '‚è≥ Marcando...';
          const resp = await fetch('/marcar_en_camino', { method: 'POST' });
          const data = await resp.json();
          if (data && data.success) {
            enCaminoMarcado = true;
            const est = document.getElementById('estado-en-camino');
            if (est) est.classList.remove('hidden');
            btn.textContent = '‚úîÔ∏è En camino';
            btn.style.opacity = '0.6';
          } else {
            btn.disabled = false;
            btn.textContent = 'üö∂ Ya voy en camino';
            alert((data && data.error) || 'No se pudo marcar en camino');
          }
        } catch (e) {
          btn.disabled = false;
          btn.textContent = 'üö∂ Ya voy en camino';
          alert('Error de red');
        }
      });
    })();
  </script>
</body>
</html>
