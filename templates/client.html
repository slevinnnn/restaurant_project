<!DOCTYPE html>
<html>
<head><title>Cliente</title>
  <link rel="stylesheet" href="/static/styles/output.css">
  <link href="https://fonts.googleapis.com/css2?family=Industry+Inc:wght@300;400;500;700&display=swap" rel="stylesheet">
  <style>
    @keyframes pulse {
      0%, 100% { 
        transform: scale(1); 
        opacity: 1; 
      }
      50% { 
        transform: scale(1.05); 
        opacity: 0.8; 
      }
    }
    
    @keyframes blink {
      0%, 50% { opacity: 1; }
      51%, 100% { opacity: 0.3; }
    }
    
    @keyframes slideDown {
      from { transform: translateX(-50%) translateY(-100%); }
      to { transform: translateX(-50%) translateY(0); }
    }
    
    .pulse-animation {
      animation: pulse 1s infinite;
    }
    
    .blink-animation {
      animation: blink 0.5s infinite;
    }
    
    /* Asegurar que el cron√≥metro sea visible */
    #cronometro-container {
      min-height: 60px !important;
      padding: 15px !important;
      background: linear-gradient(135deg, rgba(34, 197, 94, 0.1), rgba(59, 130, 246, 0.1)) !important;
      border: 2px solid rgba(34, 197, 94, 0.3) !important;
      border-radius: 12px !important;
      margin: 15px 0 !important;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1) !important;
    }
    
    #cronometro-display {
      font-family: 'Courier New', monospace !important;
      font-size: 2rem !important;
      font-weight: bold !important;
      text-align: center !important;
      display: block !important;
      visibility: visible !important;
      color: #22c55e !important;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.1) !important;
    }
    
    .cronometro-content {
      text-align: center !important;
    }
    
    .cronometro-title {
      font-size: 1.2rem !important;
      margin-bottom: 10px !important;
      color: #374151 !important;
    }
    
    .cronometro-message {
      font-size: 0.9rem !important;
      color: #6b7280 !important;
      margin-top: 10px !important;
    }
    
    /* Estilos para alerta de notificaci√≥n */
    .notification-prompt {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #3b82f6;
      color: white;
      padding: 1rem 2rem;
      border-radius: 0.5rem;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      z-index: 1000;
      animation: slideDown 0.3s ease-out;
    }
    
    /* Forzar visibilidad del cron√≥metro */
    .cronometro-container:not(.hidden) {
      display: block !important;
      visibility: visible !important;
      opacity: 1 !important;
    }
  </style>
</head>
<body>
  <!-- Header con logo -->
  <header class="top-header">
    <img class="logo-header" src="{{ url_for('static', filename='images/logo-alleria.png') }}" alt="logo-alleria" />
    <div></div> <!-- Espacio vac√≠o para mantener el logo a la izquierda -->
  </header>

  <main style="padding-top: 12vh;">
    <p class="msj-bienvenida" id="bienvenida">Bienvenid@ {% if nombre %}{{ nombre }}{% endif %}</p>
    <p class="msj-actualmente" id="actualmente">Actualmente atendiendo al n√∫mero: <strong id="atendiendo"></strong></p>
    <p class="msj-tu-numero" id="tu-numero">Tu n√∫mero en la fila es: <strong>{{ numero }}</strong></p>
    
    <p class="msj-estado" id="estado">Esperando tu turno...</p>
    
    <!-- Bot√≥n para activar notificaciones (oculto por defecto) -->
    <div id="notification-prompt" class="notification-prompt hidden">
      <p class="notification-message">üì± Activa las notificaciones para saber cuando sea tu turno</p>
      <button onclick="solicitarPermisoNotificaciones()" class="notification-button">
        üîî Activar Notificaciones
      </button>
    </div>
    
    <!-- Cron√≥metro de 10 minutos (oculto inicialmente) -->
    <div id="cronometro-container" class="cronometro-container hidden">
      <div class="cronometro-content">
        <h3 class="cronometro-title">‚è∞ Tiempo para llegar</h3>
        <div class="cronometro-display" id="cronometro-display">10:00</div>
        <p class="cronometro-message">¬°Tienes 10 minutos para llegar a tu mesa!</p>
      </div>
    </div>
    
    <br>
    <div class="tiempo-espera-promedio" id="tiempo-espera-container">
      <p class="msj-tiempo-espera" id="tiempo-espera" onclick="toggleInfoPopover()" style="cursor: pointer;">
        ‚è±Ô∏è Tiempo de espera estimado: <strong id="tiempo-promedio">Calculando...</strong>
        <span style="font-size: 0.8em; color: #6b7280; margin-left: 8px;">‚ÑπÔ∏è</span>
      </p>
      
      <!-- Popover informativo -->
      <div id="info-popover" class="popover-info hidden">
        <div class="popover-content">
          <p><strong>‚ÑπÔ∏è Informaci√≥n sobre el tiempo de espera:</strong></p>
          <p>El tiempo de espera puede variar y este es solo una estimaci√≥n. El tiempo se calcula en base al tiempo de espera de los √∫ltimos 6 comensales en la fila.</p>
          <button onclick="toggleInfoPopover()" class="popover-close">Entendido</button>
        </div>
      </div>
    </div>
  </main>

  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
  <script>
    const id = {{ numero }};
    const socket = io();
    let cronometroInterval = null;

    // ==================== SISTEMA DE NOTIFICACIONES PUSH ====================
    
    // Verificar soporte para notificaciones
    if ('serviceWorker' in navigator && 'PushManager' in window) {
      console.log('El navegador soporta notificaciones push');
    } else {
      console.log('El navegador NO soporta notificaciones push');
    }

    // Registrar Service Worker
    async function registrarServiceWorker() {
      try {
        const registration = await navigator.serviceWorker.register('/static/sw.js');
        console.log('Service Worker registrado:', registration);
        return registration;
      } catch (error) {
        console.error('Error registrando Service Worker:', error);
        return null;
      }
    }

    // Solicitar permisos de notificaci√≥n
    async function solicitarPermisoNotificaciones() {
      try {
        const permission = await Notification.requestPermission();
        console.log('Permiso de notificaciones:', permission);
        
        if (permission === 'granted') {
          mostrarNotificacionBienvenida();
          // Ocultar el bot√≥n de solicitud de permisos
          document.getElementById('notification-prompt').classList.add('hidden');
          return true;
        } else {
          console.log('Permisos de notificaci√≥n denegados');
          // Mostrar el bot√≥n para volver a solicitar permisos
          document.getElementById('notification-prompt').classList.remove('hidden');
          return false;
        }
      } catch (error) {
        console.error('Error solicitando permisos:', error);
        return false;
      }
    }

    // Mostrar notificaci√≥n de bienvenida
    function mostrarNotificacionBienvenida() {
      if (Notification.permission === 'granted') {
        new Notification('üçΩÔ∏è Restaurante Alleria', {
          body: 'Te notificaremos cuando sea tu turno. ¬°Mant√©n las notificaciones activadas!',
          icon: '/static/images/logo-alleria.png',
          badge: '/static/images/logo-alleria.png'
        });
      }
    }

    // Mostrar notificaci√≥n cuando sea el turno
    function mostrarNotificacionTurno(mesa) {
      console.log('üîî === INICIO NOTIFICACI√ìN TURNO ===');
      console.log('üì± Mesa asignada:', mesa);
      console.log('üîî Permission:', Notification.permission);
      console.log('üëÅÔ∏è Visibility:', document.visibilityState);
      console.log('üåê Online:', navigator.onLine);
      
      // M√©todo 1: Notificaci√≥n web est√°ndar
      if (Notification.permission === 'granted') {
        try {
          const notificacion = new Notification('üéâ ¬°Es tu turno!', {
            body: `Tu mesa ${mesa} est√° lista. Tienes 10 minutos para llegar.`,
            icon: '/static/images/logo-alleria.png',
            badge: '/static/images/logo-alleria.png',
            vibrate: [500, 200, 500, 200, 500, 200, 500], // Vibraci√≥n m√°s intensa y larga
            requireInteraction: true, // Mantiene la notificaci√≥n hasta que el usuario interact√∫e
            tag: 'turno-mesa', // Evita notificaciones duplicadas
            renotify: true,
            silent: false, // Asegurar que no sea silenciosa
            data: { mesa: mesa, timestamp: Date.now() }
          });

          // Cerrar autom√°ticamente despu√©s de 60 segundos
          setTimeout(() => {
            notificacion.close();
          }, 60000);

          // Manejar clic en la notificaci√≥n
          notificacion.onclick = function() {
            window.focus();
            notificacion.close();
          };
          
          console.log('‚úÖ Notificaci√≥n web creada exitosamente');
        } catch (error) {
          console.error('‚ùå Error creando notificaci√≥n web:', error);
        }
      } else {
        console.log('‚ùå Permisos de notificaci√≥n no concedidos');
      }
      
      // M√©todo 2: Service Worker (para notificaciones en segundo plano)
      if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
        try {
          navigator.serviceWorker.controller.postMessage({
            type: 'SHOW_NOTIFICATION',
            title: 'üéâ ¬°Es tu turno!',
            body: `Tu mesa ${mesa} est√° lista. Tienes 10 minutos para llegar.`,
            mesa: mesa
          });
          console.log('‚úÖ Mensaje enviado al Service Worker');
        } catch (error) {
          console.error('‚ùå Error enviando mensaje al SW:', error);
        }
      }
      
      // M√©todo 3: Alerta visual en la p√°gina (siempre funciona)
      mostrarAlertaVisual(mesa);
      
      // M√©todo 4: Intentar despertar la p√°gina con vibraci√≥n y sonido
      intentarDespertarDispositivo();
      
      // M√©todo 5: Crear alerta visual superpuesta
      crearAlertaSuperpuesta(mesa);
      
      console.log('üîî === FIN NOTIFICACI√ìN TURNO ===');
    }
    
    // Nueva funci√≥n: Alerta visual que siempre funciona
    function mostrarAlertaVisual(mesa) {
      // Cambiar el t√≠tulo de la p√°gina (se ve en la pesta√±a)
      document.title = `üéâ ¬°Es tu turno! Mesa ${mesa}`;
      
      // Cambiar favicon para que parpadee
      let faviconLink = document.querySelector('link[rel="icon"]');
      if (!faviconLink) {
        faviconLink = document.createElement('link');
        faviconLink.rel = 'icon';
        document.head.appendChild(faviconLink);
      }
      
      // Alternar favicon cada 500ms durante 10 segundos
      let faviconToggle = 0;
      const faviconInterval = setInterval(() => {
        faviconLink.href = faviconToggle % 2 === 0 ? 
          '/static/images/logo-alleria.png' : 
          'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y=".9em" font-size="90">üéâ</text></svg>';
        faviconToggle++;
      }, 500);
      
      // Parar el parpadeo despu√©s de 10 segundos
      setTimeout(() => {
        clearInterval(faviconInterval);
        faviconLink.href = '/static/images/logo-alleria.png';
        document.title = 'Cliente - Restaurante Alleria';
      }, 10000);
      
      console.log('‚úÖ Alerta visual activada');
    }
    
    // Nueva funci√≥n: Intentar despertar dispositivo
    function intentarDespertarDispositivo() {
      // Vibraci√≥n si est√° disponible
      if (navigator.vibrate) {
        navigator.vibrate([500, 200, 500, 200, 500]);
        console.log('üì≥ Vibraci√≥n activada');
      }
      
      // Reproducir sonido de notificaci√≥n
      try {
        const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmUUBj2Z2u/JSSUK');
        audio.play().catch(e => console.log('‚ùå No se pudo reproducir sonido:', e));
        console.log('üîä Intentando reproducir sonido');
      } catch (e) {
        console.log('‚ùå Error con audio:', e);
      }
      
      // Intentar forzar enfoque en la ventana
      if (window.focus) {
        window.focus();
      }
      
      // Intentar Wake Lock si est√° disponible
      if ('wakeLock' in navigator) {
        navigator.wakeLock.request('screen')
          .then(() => console.log('üîã Wake Lock activado temporalmente'))
          .catch(e => console.log('‚ùå Wake Lock no disponible:', e));
      }
    }
    
    // Nueva funci√≥n: Crear alerta visual superpuesta
    function crearAlertaSuperpuesta(mesa) {
      // Remover alerta anterior si existe
      const alertaAnterior = document.getElementById('alerta-turno');
      if (alertaAnterior) {
        alertaAnterior.remove();
      }
      
      // Crear overlay de alerta
      const overlay = document.createElement('div');
      overlay.id = 'alerta-turno';
      overlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.9);
        z-index: 10000;
        display: flex;
        align-items: center;
        justify-content: center;
        animation: pulse 1s infinite;
      `;
      
      // Crear contenido de la alerta
      overlay.innerHTML = `
        <div style="
          background: white;
          padding: 2rem;
          border-radius: 1rem;
          text-align: center;
          max-width: 90%;
          box-shadow: 0 20px 50px rgba(0,0,0,0.5);
          border: 3px solid #22c55e;
        ">
          <div style="font-size: 4rem; margin-bottom: 1rem;">üéâ</div>
          <h2 style="font-size: 2rem; color: #22c55e; margin-bottom: 1rem; font-weight: bold;">
            ¬°ES TU TURNO!
          </h2>
          <p style="font-size: 1.2rem; margin-bottom: 1rem; color: #333;">
            Tu mesa <strong>${mesa}</strong> est√° lista
          </p>
          <p style="color: #666; margin-bottom: 2rem;">
            Tienes 10 minutos para llegar
          </p>
          <button onclick="document.getElementById('alerta-turno').remove()" 
                  style="
                    background: #22c55e;
                    color: white;
                    padding: 1rem 2rem;
                    border: none;
                    border-radius: 0.5rem;
                    font-size: 1.1rem;
                    cursor: pointer;
                    font-weight: bold;
                  ">
            ¬°Entendido!
          </button>
        </div>
      `;
      
      // Agregar al documento
      document.body.appendChild(overlay);
      
      // Auto-remover despu√©s de 30 segundos
      setTimeout(() => {
        if (document.getElementById('alerta-turno')) {
          document.getElementById('alerta-turno').remove();
        }
      }, 30000);
      
      console.log('‚úÖ Alerta superpuesta creada');
    }

    // Inicializar notificaciones al cargar la p√°gina
    window.addEventListener('load', async () => {
      if ('serviceWorker' in navigator && 'Notification' in window) {
        await registrarServiceWorker();
        
        // Solicitar permisos autom√°ticamente despu√©s de 2 segundos
        setTimeout(async () => {
          if (Notification.permission === 'default') {
            await solicitarPermisoNotificaciones();
          }
        }, 2000);
      }
      
      // Intentar mantener la pantalla activa (Wake Lock API)
      if ('wakeLock' in navigator) {
        try {
          const wakeLock = await navigator.wakeLock.request('screen');
          console.log('üîã Wake Lock activado - pantalla se mantendr√° activa');
          
          // Manejar cuando el usuario cambia de pesta√±a
          document.addEventListener('visibilitychange', async () => {
            if (wakeLock !== null && document.visibilityState === 'visible') {
              const newWakeLock = await navigator.wakeLock.request('screen');
              console.log('üîã Wake Lock reactivado');
            }
          });
        } catch (err) {
          console.log('‚ùå No se pudo activar Wake Lock:', err);
        }
      }
      
      // Registrar eventos para mantener conexi√≥n activa y detectar cambios de pesta√±a
      let lastVisibilityCheck = Date.now();
      let wasHidden = false;
      
      document.addEventListener('visibilitychange', () => {
        const now = Date.now();
        const timeSinceLastCheck = now - lastVisibilityCheck;
        
        console.log('üëÅÔ∏è Cambio de visibilidad detectado:', {
          estado: document.visibilityState,
          tiempoOculto: wasHidden ? timeSinceLastCheck : 0,
          socketConectado: socket.connected
        });
        
        if (document.visibilityState === 'visible') {
          console.log('‚úÖ P√°gina ahora visible - verificando estado...');
          
          // Si estuvo oculta por m√°s de 1 segundo, forzar reconexi√≥n
          if (wasHidden && timeSinceLastCheck > 1000) {
            console.log('üîÑ Reconectando despu√©s de estar oculta...');
            
            // Forzar reconexi√≥n del socket
            if (socket.connected) {
              socket.disconnect();
            }
            socket.connect();
            
            // Re-registrar cliente despu√©s de un momento
            setTimeout(() => {
              console.log('üìù Re-registrando cliente despu√©s de reconexi√≥n...');
              socket.emit("registrar_cliente", { id: id });
              
              // Verificar estado actual del cliente
              fetch(`/verificar_estado_cliente/${id}`)
                .then(response => response.json())
                .then(data => {
                  console.log('üìä Estado actual del cliente:', data);
                  
                  // Si ya tiene mesa asignada, mostrar notificaci√≥n
                  if (data.mesa_asignada && !notificationShown) {
                    console.log('üéâ Cliente ya ten√≠a mesa asignada:', data.mesa_asignada);
                    lastKnownMesa = data.mesa_asignada;
                    notificationShown = true;
                    
                    mostrarNotificacionTurno(data.mesa_asignada);
                    iniciarCronometro();
                    
                    // Actualizar interfaz
                    document.getElementById("estado").className = "font-bold text-6xl text-green-600";
                    document.getElementById("estado").innerText = "¬°Es tu turno! Ve a la mesa " + data.mesa_asignada;
                    document.getElementById("actualmente").style.display = "none";
                    document.getElementById("atendiendo").style.display = "none";
                    document.getElementById("tu-numero").style.display = "none";
                    document.getElementById("bienvenida").style.display = "none";
                    document.getElementById("tiempo-espera-container").style.display = "none";
                  }
                })
                .catch(error => {
                  console.error('‚ùå Error verificando estado del cliente:', error);
                });
            }, 1000);
          } else if (!socket.connected) {
            console.log('üîå Socket desconectado, reconectando...');
            socket.connect();
          }
          
          wasHidden = false;
        } else {
          console.log('üëª P√°gina ahora oculta');
          wasHidden = true;
        }
        
        lastVisibilityCheck = now;
      });
      
      // Tambi√©n escuchar eventos de enfoque/desenfoque de la ventana
      window.addEventListener('focus', () => {
        console.log('üéØ Ventana enfocada - verificando conexi√≥n...');
        if (!socket.connected) {
          socket.connect();
        }
      });
      
      window.addEventListener('blur', () => {
        console.log('üí≠ Ventana desenfocada');
      });
    });

    // ==================== FIN SISTEMA DE NOTIFICACIONES ====================

    // Funci√≥n para mostrar/ocultar el popover
    function toggleInfoPopover() {
      const popover = document.getElementById("info-popover");
      popover.classList.toggle("hidden");
    }

    // Cerrar popover al hacer clic fuera de √©l
    document.addEventListener('click', function(event) {
      const popover = document.getElementById("info-popover");
      const tiempoEspera = document.getElementById("tiempo-espera");
      
      if (!popover.contains(event.target) && !tiempoEspera.contains(event.target)) {
        popover.classList.add("hidden");
      }
    });

    // Funci√≥n para iniciar cron√≥metro de 10 minutos
    function iniciarCronometro() {
      console.log('üïê === INICIANDO CRON√ìMETRO ===');
      console.log('üåê URL actual:', window.location.href);
      console.log('üì± User Agent:', navigator.userAgent.substring(0, 100));
      console.log('üëÅÔ∏è Visibilidad p√°gina:', document.visibilityState);
      
      let tiempoRestante = 10 * 60; // 10 minutos en segundos
      const cronometroDisplay = document.getElementById("cronometro-display");
      const cronometroContainer = document.getElementById("cronometro-container");
      
      // Verificar que los elementos existen con m√°s detalle
      console.log('üîç Verificando elementos del DOM:');
      console.log('  - cronometro-display:', !!cronometroDisplay, cronometroDisplay);
      console.log('  - cronometro-container:', !!cronometroContainer, cronometroContainer);
      console.log('  - body:', !!document.body);
      console.log('  - head:', !!document.head);
      
      if (!cronometroDisplay || !cronometroContainer) {
        console.error('‚ùå Elementos del cron√≥metro no encontrados');
        console.log('üìã Todos los elementos con ID:');
        Array.from(document.querySelectorAll('[id]')).forEach(el => {
          console.log(`  - ${el.id}: ${el.tagName}`);
        });
        return;
      }
      
      // Mostrar el cron√≥metro con logging detallado
      console.log('üîß Estado antes de mostrar:', {
        containerDisplay: cronometroContainer.style.display,
        containerClasses: cronometroContainer.className,
        displayText: cronometroDisplay.textContent
      });
      
      cronometroContainer.classList.remove("hidden");
      cronometroContainer.style.display = "block";
      cronometroContainer.style.visibility = "visible";
      
      console.log('üîß Estado despu√©s de mostrar:', {
        containerDisplay: cronometroContainer.style.display,
        containerClasses: cronometroContainer.className,
        isVisible: cronometroContainer.offsetHeight > 0
      });
      
      function actualizarCronometro() {
        // Verificar que el elemento a√∫n existe
        const displayActual = document.getElementById("cronometro-display");
        if (!displayActual) {
          console.error('‚ùå Elemento cronometro-display desapareci√≥');
          clearInterval(cronometroInterval);
          return;
        }
        
        const minutos = Math.floor(tiempoRestante / 60);
        const segundos = tiempoRestante % 60;
        
        const tiempoTexto = `${minutos}:${segundos.toString().padStart(2, '0')}`;
        displayActual.textContent = tiempoTexto;
        
        // Forzar actualizaci√≥n visual
        displayActual.style.display = "block";
        displayActual.style.visibility = "visible";
        
        // Log detallado cada 30 segundos
        if (tiempoRestante % 30 === 0) {
          console.log(`‚è∞ Cron√≥metro actualizado: ${tiempoTexto}`);
          console.log('üìä Estado del elemento:', {
            texto: displayActual.textContent,
            visible: displayActual.offsetHeight > 0,
            estilos: {
              display: displayActual.style.display,
              visibility: displayActual.style.visibility,
              color: displayActual.style.color
            }
          });
        }
        
        // Cambiar color seg√∫n el tiempo restante
        if (tiempoRestante <= 120) { // √öltimos 2 minutos
          displayActual.style.color = "#ef4444"; // Rojo
          displayActual.style.animation = "pulse 1s infinite";
          displayActual.style.fontWeight = "bold";
        } else if (tiempoRestante <= 300) { // √öltimos 5 minutos
          displayActual.style.color = "#f59e0b"; // Amarillo
        } else {
          displayActual.style.color = "#22c55e"; // Verde
        }
        
        // Actualizar t√≠tulo de la p√°gina
        document.title = `‚è∞ ${tiempoTexto} - Restaurante Alleria`;
        
        if (tiempoRestante <= 0) {
          clearInterval(cronometroInterval);
          displayActual.textContent = "¬°Tiempo agotado!";
          displayActual.style.color = "#ef4444";
          document.title = "‚è∞ ¬°Tiempo agotado! - Restaurante Alleria";
          console.log('‚è∞ Cron√≥metro terminado');
          return;
        }
        
        tiempoRestante--;
      }
      
      // Limpiar intervalo anterior
      if (window.cronometroInterval) {
        clearInterval(window.cronometroInterval);
        console.log('üîÑ Intervalo anterior limpiado');
      }
      
      // Actualizar inmediatamente
      actualizarCronometro();
      
      // Crear nuevo intervalo y guardarlo globalmente
      window.cronometroInterval = setInterval(actualizarCronometro, 1000);
      console.log('‚úÖ Cron√≥metro iniciado con ID:', window.cronometroInterval);
      console.log('üïê === CRON√ìMETRO CONFIGURADO ===');
    }

    // Funci√≥n para obtener y actualizar el tiempo de espera promedio
    function actualizarTiempoEsperaPromedio() {
      fetch('/tiempo_espera_promedio')
        .then(response => response.json())
        .then(data => {
          const minutos = data.promedio_minutos;
          const elemento = document.getElementById("tiempo-promedio");
          
          if (minutos <= 5) {
            elemento.textContent = `${minutos} minutos ‚ö°`;
            elemento.style.color = "#22c55e"; // Verde
          } else if (minutos <= 15) {
            elemento.textContent = `${minutos} minutos ‚è∞`;
            elemento.style.color = "#f59e0b"; // Amarillo/Naranja
          } else {
            elemento.textContent = `${minutos} minutos ‚è≥`;
            elemento.style.color = "#ef4444"; // Rojo
          }
        })
        .catch(error => {
          console.error('Error obteniendo tiempo de espera:', error);
          document.getElementById("tiempo-promedio").textContent = "No disponible";
        });
    }

    socket.on("connect", () => {
      console.log('üîå Socket conectado exitosamente');
      isConnected = true;
      socket.emit("registrar_cliente", { id: id });
      // Obtener tiempo de espera promedio al conectarse
      actualizarTiempoEsperaPromedio();
    });

    socket.on("disconnect", (reason) => {
      console.log('‚ùå Socket desconectado:', reason);
      isConnected = false;
      
      // Si la desconexi√≥n no fue intencional, intentar reconectar
      if (reason !== 'io client disconnect') {
        console.log('üîÑ Intentando reconectar en 2 segundos...');
        setTimeout(() => {
          if (!socket.connected) {
            socket.connect();
          }
        }, 2000);
      }
    });

    socket.on("connect_error", (error) => {
      console.error('‚ùå Error de conexi√≥n del socket:', error);
      isConnected = false;
    });

    // Actualizar tiempo de espera cada 30 segundos
    setInterval(actualizarTiempoEsperaPromedio, 30000);

    // Sistema de heartbeat para mantener conexi√≥n activa
    let heartbeatInterval;
    
    function iniciarHeartbeat() {
      if (heartbeatInterval) {
        clearInterval(heartbeatInterval);
      }
      
      heartbeatInterval = setInterval(() => {
        if (socket.connected && document.visibilityState === 'visible') {
          console.log('üíì Enviando heartbeat...');
          socket.emit('heartbeat', { 
            cliente_id: id, 
            timestamp: Date.now(),
            page_visible: document.visibilityState === 'visible'
          });
        } else if (!socket.connected) {
          console.log('üíî Socket desconectado durante heartbeat, reconectando...');
          socket.connect();
        }
      }, 15000); // Cada 15 segundos
    }
    
    // Iniciar heartbeat cuando se conecte
    socket.on("connect", () => {
      iniciarHeartbeat();
    });
    
    // Detener heartbeat cuando se desconecte
    socket.on("disconnect", () => {
      if (heartbeatInterval) {
        clearInterval(heartbeatInterval);
      }
    });

    let isConnected = false;
    let lastKnownMesa = null;
    let notificationShown = false;
    
    socket.on("es_tu_turno", (data) => {
      console.log('üéâ === EVENTO ES_TU_TURNO RECIBIDO ===');
      console.log('üì¶ Data recibida:', data);
      console.log('üåê Ubicaci√≥n:', window.location.href);
      console.log('üì± Plataforma:', navigator.platform);
      console.log('üëÅÔ∏è Documento visible:', document.visibilityState);
      console.log('üîå Socket conectado:', socket.connected);
      
      // Evitar procesar el mismo evento m√∫ltiples veces
      if (lastKnownMesa === data.mesa && notificationShown) {
        console.log('‚ö†Ô∏è Evento duplicado ignorado para mesa', data.mesa);
        return;
      }
      
      lastKnownMesa = data.mesa;
      notificationShown = true;
      
      try {
        // Actualizar elementos de la interfaz
        const estadoElement = document.getElementById("estado");
        const actualmenteElement = document.getElementById("actualmente");
        const atendiendoElement = document.getElementById("atendiendo");
        const tuNumeroElement = document.getElementById("tu-numero");
        const bienvenidaElement = document.getElementById("bienvenida");
        const tiempoEsperaElement = document.getElementById("tiempo-espera-container");
        
        console.log('üîç Elementos encontrados:', {
          estado: !!estadoElement,
          actualmente: !!actualmenteElement,
          atendiendo: !!atendiendoElement,
          tuNumero: !!tuNumeroElement,
          bienvenida: !!bienvenidaElement,
          tiempoEspera: !!tiempoEsperaElement
        });
        
        if (estadoElement) {
          estadoElement.className = "font-bold text-6xl text-green-600";
          estadoElement.innerText = "¬°Es tu turno! Ve a la mesa " + data.mesa;
          console.log('‚úÖ Estado actualizado');
        }
        
        // Ocultar elementos no necesarios
        [actualmenteElement, atendiendoElement, tuNumeroElement, bienvenidaElement, tiempoEsperaElement].forEach((el, index) => {
          if (el) {
            el.style.display = "none";
            console.log(`‚úÖ Elemento ${index + 1} ocultado`);
          }
        });
        
        // Mostrar notificaci√≥n push con debugging
        console.log('üîî Iniciando proceso de notificaci√≥n...');
        mostrarNotificacionTurno(data.mesa);
        
        // Iniciar cron√≥metro con debugging
        console.log('‚è∞ Iniciando proceso de cron√≥metro...');
        iniciarCronometro();
        
        console.log('‚úÖ Proceso de turno completado exitosamente');
        
      } catch (error) {
        console.error('‚ùå Error procesando evento es_tu_turno:', error);
        console.error('üìã Stack trace:', error.stack);
      }
      
      console.log('üéâ === FIN EVENTO ES_TU_TURNO ===');
    });
    
    socket.on("actualizar_posicion",(data)=>{
      document.getElementById("atendiendo").innerText = Number(data.primero)-1;
    });

    // Actualizar tiempo de espera cuando hay cambios en la cola
    socket.on("actualizar_cola", () => {
      actualizarTiempoEsperaPromedio();
    });
  </script>
</body>
</html>
