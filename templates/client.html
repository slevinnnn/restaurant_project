<!DOCTYPE html>
<html>
<head><title>Cliente</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <link rel="stylesheet" href="/static/styles/output.css">
  <link href="https://fonts.googleapis.com/css2?family=Industry+Inc:wght@300;400;500;700&display=swap" rel="stylesheet">
  <style>
    @keyframes pulse {
      0%, 100% { 
        transform: scale(1); 
        opacity: 1; 
      }
      50% { 
        transform: scale(1.05); 
        opacity: 0.8; 
      }
    }
    
    @keyframes blink {
      0%, 50% { opacity: 1; }
      51%, 100% { opacity: 0.3; }
    }
    
    @keyframes slideDown {
      from { transform: translateX(-50%) translateY(-100%); }
      to { transform: translateX(-50%) translateY(0); }
    }
    
    .pulse-animation {
      animation: pulse 1s infinite;
    }
    
    .blink-animation {
      animation: blink 0.5s infinite;
    }
    
    /* Asegurar que el cronómetro sea visible */
    #cronometro-container {
      min-height: 60px !important;
      padding: 15px !important;
      background: linear-gradient(135deg, rgba(34, 197, 94, 0.1), rgba(59, 130, 246, 0.1)) !important;
      border: 2px solid rgba(34, 197, 94, 0.3) !important;
      border-radius: 12px !important;
      margin: 15px 0 !important;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1) !important;
    }
    
    #cronometro-display {
      font-family: 'Courier New', monospace !important;
      font-size: 2rem !important;
      font-weight: bold !important;
      text-align: center !important;
      display: block !important;
      visibility: visible !important;
      color: #22c55e !important;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.1) !important;
    }
    
    /* Cronómetro más grande para móviles con proporciones áureas */
    @media (max-width: 768px) {
      #cronometro-container {
  position: relative !important; /* deja fluir bajo el mensaje */
  top: auto !important;
  left: auto !important;
  transform: none !important;
  width: 92vw !important;
  height: auto !important;
  max-width: 480px !important;
  padding: 18px 16px !important;
  margin: 12px auto 40px auto !important; /* espacio bajo el mensaje */
  z-index: 5 !important;
  box-shadow: 0 12px 30px rgba(0,0,0,0.25) !important;
  border-radius: 18px !important;
  background: #ffffff !important;
  border: 2px solid #d9e2ec !important;
  display: flex !important;
  flex-direction: column !important;
  justify-content: center !important;
  align-items: center !important;
      }
      
      #cronometro-display {
  font-size: 3.6rem !important; /* reducido para no chocar */
  margin: 0.25rem 0 0.35rem 0 !important;
  line-height: 1 !important;
  font-weight: 800 !important;
  color: #1e3a8a !important;
  text-shadow: 1px 1px 3px rgba(0,0,0,0.08) !important;
  font-family: 'Courier New', 'SF Mono', monospace !important;
  letter-spacing: -1px !important;
      }
      
      .cronometro-title {
  font-size: 1.15rem !important;
  margin-bottom: 0.35rem !important;
  font-weight: 600 !important;
  color: #334155 !important;
  text-align: center !important;
      }
      
      .cronometro-message {
  font-size: 0.95rem !important;
  margin-top: 0.4rem !important;
  line-height: 1.25 !important;
  font-weight: 500 !important;
  color: #64748b !important;
  text-align: center !important;
  padding: 0 6px !important;
      }
    }
    
    /* Para móviles muy pequeños - ajustar para mantener proporciones */
    @media (max-width: 480px) {
      #cronometro-container {
  width: 94vw !important;
  height: auto !important;
  max-width: 440px !important;
  padding: 16px 14px !important;
  margin: 10px auto 34px auto !important;
      }
      
      #cronometro-display {
  font-size: 3.2rem !important;
  letter-spacing: -0.5px !important;
      }
      
      .cronometro-title {
  font-size: 1.05rem !important;
  margin-bottom: 0.3rem !important;
      }
      
      .cronometro-message {
  font-size: 0.85rem !important;
  margin-top: 0.3rem !important;
      }
    }
    
    /* Para móviles extra pequeños */
    @media (max-width: 320px) {
      #cronometro-container {
        width: 96vw !important;
        height: auto !important;
      }
      
      #cronometro-display {
        font-size: 2.9rem !important;
      }
      
      .cronometro-title {
        font-size: 0.95rem !important;
      }
      
      .cronometro-message {
        font-size: 0.8rem !important;
      }
    }

    /* Mensaje de turno separado y con espacio asegurado arriba */
    #estado.turno-activo-msg {
      margin-top: 6vh !important;
      margin-bottom: 4px !important;
      padding: 6px 8px !important;
      line-height: 1.25 !important;
      z-index: 10 !important;
      position: relative !important;
      text-align: center !important;
      display: block !important;
    }
    @media (max-width:768px){
      #estado.turno-activo-msg { font-size: 1.55rem !important; }
    }
    @media (max-width:480px){
      #estado.turno-activo-msg { font-size: 1.35rem !important; }
    }
    
    .cronometro-content {
      text-align: center !important;
    }
    
    .cronometro-title {
      font-size: 1.2rem !important;
      margin-bottom: 10px !important;
      color: #374151 !important;
    }
    
    .cronometro-message {
      font-size: 0.9rem !important;
      color: #6b7280 !important;
      margin-top: 10px !important;
    }
    
    /* Estilos para alerta de notificación */
    .notification-prompt {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #3b82f6;
      color: white;
      padding: 1rem 2rem;
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      z-index: 1000;
      animation: slideDown 0.3s ease-out;
    }
    
    /* Estilos para el botón de cancelar turno */
    .cancelar-turno-container {
      text-align: center;
      margin: 30px auto;
      padding: 20px;
      max-width: 300px;
    }
    
    .btn-cancelar-turno {
      background: linear-gradient(135deg, #ef4444, #dc2626);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
      width: 100%;
      max-width: 250px;
    }
    
    .btn-cancelar-turno:hover {
      background: linear-gradient(135deg, #dc2626, #b91c1c);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
    }
    
    .btn-cancelar-turno:active {
      transform: translateY(0);
      box-shadow: 0 2px 4px rgba(239, 68, 68, 0.3);
    }
    
    .cancelar-ayuda {
      font-size: 0.8rem;
      color: #6b7280;
      margin-top: 10px;
      line-height: 1.3;
    }
    
    /* Ocultar botón de cancelar cuando tiene mesa asignada */
    .tiene-mesa #cancelar-turno-container {
      display: none !important;
    }
      border-radius: 0.5rem;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      z-index: 1000;
      animation: slideDown 0.3s ease-out;
    }
    
    /* Forzar visibilidad del cronómetro */
    .cronometro-container:not(.hidden) {
      display: block !important;
      visibility: visible !important;
      opacity: 1 !important;
    }
    /* Asegurar que si tiene la clase hidden realmente no se muestre (refuerzo) */
    #cronometro-container.hidden {
      display: none !important;
      visibility: hidden !important;
      opacity: 0 !important;
    }
    
    /* Ajuste específico para dispositivos ~360x720 (Android comunes) */
    @media (max-width: 400px) and (min-height: 640px) {
      #cronometro-container {
        width: 92vw !important;
        /* altura mínima 30% pantalla */
        min-height: 30vh !important;
        height: auto !important;
        padding: 28px 18px !important;
        border-width: 3px !important;
      }
      #cronometro-display {
        font-size: 5.2rem !important;
        letter-spacing: -1px !important;
      }
      .cronometro-title { font-size: 1.25rem !important; }
      .cronometro-message { font-size: 1.05rem !important; }
    }

    /* Si la altura disponible es muy baja (teclado abierto / landscape) */
    @media (max-width: 400px) and (max-height: 540px) {
      #cronometro-container {
        position: fixed !important;
        top: 8vh !important;
        transform: translate(-50%, 0) !important;
        min-height: 32vh !important;
        width: 94vw !important;
      }
      #cronometro-display { font-size: 4.4rem !important; }
    }

    /* Forzar que siempre tenga >30% altura cuando esté visible */
    #cronometro-container:not(.hidden) {
      min-height: 30vh !important;
    }

    body.turno-activo #cronometro-container:not(.hidden){
      margin-top: 12px !important;
    }

    .turno-wrapper { display:flex; flex-direction:column; align-items:center; gap:1.2rem; width:100%; }
    .turno-mensaje { text-align:center; font-weight:700; font-size:2rem; line-height:1.15; }
    .turno-mesa { display:block; margin-top:0.35rem; font-size:1.15rem; font-weight:600; }
    @media (max-width:768px){
      .turno-mensaje { font-size:1.75rem; }
      .turno-mesa { font-size:1.1rem; }
    }
    /* Estado cuando se activa el turno: empujar cronómetro más abajo si no cabe */
    @media (max-width:768px){
      body.turno-activo #cronometro-container:not(.hidden){
        position:static !important; /* dejar que fluya debajo del texto */
        transform:none !important;
        width:100% !important;
        height:auto !important;
        margin-top:0.5rem !important;
      }
    }

    /* ---------------- Ajustes específicos para pantallas angostas (~360px) ---------------- */
    @media (max-width: 400px) {
      main { padding-top: 14vh !important; }
      .container-card { padding: 0.85rem 0.9rem !important; }
      .msj-bienvenida, .msj-actualmente, .msj-tu-numero, .msj-estado {
        font-size: 0.95rem !important;
        line-height: 1.3 !important; /* fix readability */
        white-space: normal !important;
        overflow-wrap: anywhere !important;
        word-break: break-word !important;
        margin-bottom: 0.55rem !important;
      }
      .msj-bienvenida { font-weight: 600 !important; }
      .msj-tu-numero strong, .msj-actualmente strong { font-size: 1.05rem !important; }
      /* Evitar que el cronómetro reserve espacio antes de mostrarse */
      #cronometro-container.hidden { min-height: 0 !important; margin:0 !important; padding:0 !important; border:0 !important; }
    }
    /* Corrección de typo en line-height (override) */
    @media (max-width: 400px) {
      .msj-bienvenida, .msj-actualmente, .msj-tu-numero, .msj-estado { line-height: 1.3 !important; }
    }
  </style>
</head>
<body>
  <!-- Header con logo -->
  <header class="top-header">
    <img class="logo-header" src="{{ url_for('static', filename='images/logo-alleria.png') }}" alt="logo-alleria" />
    <div></div> <!-- Espacio vacío para mantener el logo a la izquierda -->
  </header>

  <main style="padding-top: 20vh;">
    <div class="container-card">
      <p class="msj-bienvenida" id="bienvenida">Bienvenid@ {% if nombre %}{{ nombre }}{% endif %}</p>
      <p class="msj-actualmente" id="actualmente">Actualmente atendiendo al número: <strong id="atendiendo"></strong></p>
      <p class="msj-tu-numero" id="tu-numero">Tu número en la fila es: <strong>{{ numero }}</strong></p>
      
  <p class="msj-estado" id="estado" style="text-align:center;">Esperando tu turno...</p>
    </div>
    
    <!-- Botón para activar notificaciones (oculto por defecto) -->
    <div id="notification-prompt" class="notification-prompt hidden">
      <p class="notification-message">📱 Activa las notificaciones para saber cuando sea tu turno</p>
      <button onclick="solicitarPermisoNotificaciones()" class="notification-button">
        🔔 Activar Notificaciones
      </button>
    </div>
    
    <!-- Cronómetro de 10 minutos (oculto inicialmente) -->
    <div id="cronometro-container" class="cronometro-container hidden">
      <div class="cronometro-content">
        <h3 class="cronometro-title">⏰ Tiempo para llegar</h3>
        <div class="cronometro-display" id="cronometro-display">10:00</div>
        <p class="cronometro-message">¡Tienes 10 minutos para llegar a tu mesa!</p>
      </div>
    </div>
    
    <br>
    <div class="tiempo-espera-promedio" id="tiempo-espera-container">
      <p class="msj-tiempo-espera" id="tiempo-espera" onclick="toggleInfoPopover()" style="cursor: pointer;">
        ⏱️ Tiempo de espera estimado: <strong id="tiempo-promedio">Calculando...</strong>
        <span style="font-size: 0.8em; color: #6b7280; margin-left: 8px;">ℹ️</span>
      </p>
      
      <!-- Popover informativo -->
      <div id="info-popover" class="popover-info hidden">
        <div class="popover-content">
          <p><strong>ℹ️ Información sobre el tiempo de espera:</strong></p>
          <p>El tiempo de espera puede variar y este es solo una estimación. El tiempo se calcula en base al tiempo de espera de los últimos 6 comensales en la fila.</p>
          <button onclick="toggleInfoPopover()" class="popover-close">Entendido</button>
        </div>
      </div>
    </div>
    
    <!-- Botón para cancelar turno (solo visible mientras espera) -->
    <div id="cancelar-turno-container" class="cancelar-turno-container">
      <button id="btn-cancelar-turno" onclick="confirmarCancelacion()" class="btn-cancelar-turno">
        ❌ Cancelar mi turno
      </button>
      <p class="cancelar-ayuda">Si tienes algún inconveniente, puedes cancelar tu lugar en la fila</p>
    </div>
  </main>

  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
  <script>
  const id = {{ numero|tojson }};
  const mesaAsignadaInicial = {{ mesa_asignada|tojson }};
  const mesaAsignadaAtInicial = {{ mesa_asignada_at|tojson }};
  const socket = io();
  let cronometroInterval = null;
  let cronometroAsignacion = null; // Date del momento de asignación para cálculo absoluto

    // ==================== SISTEMA DE NOTIFICACIONES PUSH ====================
    
    // Verificar soporte para notificaciones
    if ('serviceWorker' in navigator && 'PushManager' in window) {
      console.log('El navegador soporta notificaciones push');
    } else {
      console.log('El navegador NO soporta notificaciones push');
    }

    // Registrar Service Worker
    async function registrarServiceWorker() {
      try {
        const registration = await navigator.serviceWorker.register('/static/sw.js');
        console.log('Service Worker registrado:', registration);
        return registration;
      } catch (error) {
        console.error('Error registrando Service Worker:', error);
        return null;
      }
    }

    // Solicitar permisos de notificación
    async function solicitarPermisoNotificaciones() {
      try {
        const permission = await Notification.requestPermission();
        console.log('Permiso de notificaciones:', permission);
        
        if (permission === 'granted') {
          mostrarNotificacionBienvenida();
          // Ocultar el botón de solicitud de permisos
          document.getElementById('notification-prompt').classList.add('hidden');
          return true;
        } else {
          console.log('Permisos de notificación denegados');
          // Mostrar el botón para volver a solicitar permisos
          document.getElementById('notification-prompt').classList.remove('hidden');
          return false;
        }
      } catch (error) {
        console.error('Error solicitando permisos:', error);
        return false;
      }
    }

    // Mostrar notificación de bienvenida
    function mostrarNotificacionBienvenida() {
      if (Notification.permission === 'granted') {
        new Notification('🍽️ Restaurante Alleria', {
          body: 'Te notificaremos cuando sea tu turno. ¡Mantén las notificaciones activadas!',
          icon: '/static/images/logo-alleria.png',
          badge: '/static/images/logo-alleria.png'
        });
      }
    }

    // Mostrar notificación cuando sea el turno
    function mostrarNotificacionTurno(mesa) {
      console.log('🔔 === INICIO NOTIFICACIÓN TURNO ===');
      console.log('📱 Mesa asignada:', mesa);
      console.log('🔔 Permission:', Notification.permission);
      console.log('👁️ Visibility:', document.visibilityState);
      console.log('🌐 Online:', navigator.onLine);
      
      // Método 1: Notificación web estándar
      if (Notification.permission === 'granted') {
        try {
          const notificacion = new Notification('🎉 ¡Es tu turno!', {
            body: `Tu mesa ${mesa} está lista. Tienes 10 minutos para llegar.`,
            icon: '/static/images/logo-alleria.png',
            badge: '/static/images/logo-alleria.png',
            vibrate: [500, 200, 500, 200, 500, 200, 500], // Vibración más intensa y larga
            requireInteraction: true, // Mantiene la notificación hasta que el usuario interactúe
            tag: 'turno-mesa', // Evita notificaciones duplicadas
            renotify: true,
            silent: false, // Asegurar que no sea silenciosa
            data: { mesa: mesa, timestamp: Date.now() }
          });

          // Cerrar automáticamente después de 60 segundos
          setTimeout(() => {
            notificacion.close();
          }, 60000);

          // Manejar clic en la notificación
          notificacion.onclick = function() {
            window.focus();
            notificacion.close();
          };
          
          console.log('✅ Notificación web creada exitosamente');
        } catch (error) {
          console.error('❌ Error creando notificación web:', error);
        }
      } else {
        console.log('❌ Permisos de notificación no concedidos');
      }
      
      // Método 2: Service Worker (para notificaciones en segundo plano)
      if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
        try {
          navigator.serviceWorker.controller.postMessage({
            type: 'SHOW_NOTIFICATION',
            title: '🎉 ¡Es tu turno!',
            body: `Tu mesa ${mesa} está lista. Tienes 10 minutos para llegar.`,
            mesa: mesa
          });
          console.log('✅ Mensaje enviado al Service Worker');
        } catch (error) {
          console.error('❌ Error enviando mensaje al SW:', error);
        }
      }
      
      // Método 3: Alerta visual en la página (siempre funciona)
      mostrarAlertaVisual(mesa);
      
      // Método 4: Intentar despertar la página con vibración y sonido
      intentarDespertarDispositivo();
      
      // Método 5: Crear alerta visual superpuesta
      crearAlertaSuperpuesta(mesa);
      
      console.log('🔔 === FIN NOTIFICACIÓN TURNO ===');
    }
    
    // Nueva función: Alerta visual que siempre funciona
    function mostrarAlertaVisual(mesa) {
      // Cambiar el título de la página (se ve en la pestaña)
      document.title = `🎉 ¡Es tu turno! Mesa ${mesa}`;
      
      // Cambiar favicon para que parpadee
      let faviconLink = document.querySelector('link[rel="icon"]');
      if (!faviconLink) {
        faviconLink = document.createElement('link');
        faviconLink.rel = 'icon';
        document.head.appendChild(faviconLink);
      }
      
      // Alternar favicon cada 500ms durante 10 segundos
      let faviconToggle = 0;
      const faviconInterval = setInterval(() => {
        faviconLink.href = faviconToggle % 2 === 0 ? 
          '/static/images/logo-alleria.png' : 
          'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y=".9em" font-size="90">🎉</text></svg>';
        faviconToggle++;
      }, 500);
      
      // Parar el parpadeo después de 10 segundos
      setTimeout(() => {
        clearInterval(faviconInterval);
        faviconLink.href = '/static/images/logo-alleria.png';
        document.title = 'Cliente - Restaurante Alleria';
      }, 10000);
      
      console.log('✅ Alerta visual activada');
    }
    
    // Nueva función: Intentar despertar dispositivo
    function intentarDespertarDispositivo() {
      // Vibración si está disponible
      if (navigator.vibrate) {
        navigator.vibrate([500, 200, 500, 200, 500]);
        console.log('📳 Vibración activada');
      }
      
      // Reproducir sonido de notificación
      try {
        const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmUUBj2Z2u/JSSUK');
        audio.play().catch(e => console.log('❌ No se pudo reproducir sonido:', e));
        console.log('🔊 Intentando reproducir sonido');
      } catch (e) {
        console.log('❌ Error con audio:', e);
      }
      
      // Intentar forzar enfoque en la ventana
      if (window.focus) {
        window.focus();
      }
      
      // Intentar Wake Lock si está disponible
      if ('wakeLock' in navigator) {
        navigator.wakeLock.request('screen')
          .then(() => console.log('🔋 Wake Lock activado temporalmente'))
          .catch(e => console.log('❌ Wake Lock no disponible:', e));
      }
    }
    
    // Nueva función: Crear alerta visual superpuesta
    function crearAlertaSuperpuesta(mesa) {
      // Remover alerta anterior si existe
      const alertaAnterior = document.getElementById('alerta-turno');
      if (alertaAnterior) {
        alertaAnterior.remove();
      }
      
      // Crear overlay de alerta
      const overlay = document.createElement('div');
      overlay.id = 'alerta-turno';
      overlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.9);
        z-index: 10000;
        display: flex;
        align-items: center;
        justify-content: center;
        animation: pulse 1s infinite;
      `;
      
      // Crear contenido de la alerta
      overlay.innerHTML = `
        <div style="
          background: white;
          padding: 2rem;
          border-radius: 1rem;
          text-align: center;
          max-width: 90%;
          box-shadow: 0 20px 50px rgba(0,0,0,0.5);
          border: 3px solid #22c55e;
        ">
          <div style="font-size: 4rem; margin-bottom: 1rem;">🎉</div>
          <h2 style="font-size: 2rem; color: #22c55e; margin-bottom: 1rem; font-weight: bold;">
            ¡ES TU TURNO!
          </h2>
          <p style="font-size: 1.2rem; margin-bottom: 1rem; color: #333;">
            Tu mesa <strong>${mesa}</strong> está lista
          </p>
          <p style="color: #666; margin-bottom: 2rem;">
            Tienes 10 minutos para llegar
          </p>
          <button onclick="document.getElementById('alerta-turno').remove()" 
                  style="
                    background: #22c55e;
                    color: white;
                    padding: 1rem 2rem;
                    border: none;
                    border-radius: 0.5rem;
                    font-size: 1.1rem;
                    cursor: pointer;
                    font-weight: bold;
                  ">
            ¡Entendido!
          </button>
        </div>
      `;
      
      // Agregar al documento
      document.body.appendChild(overlay);
      
      // Auto-remover después de 30 segundos
      setTimeout(() => {
        if (document.getElementById('alerta-turno')) {
          document.getElementById('alerta-turno').remove();
        }
      }, 30000);
      
      console.log('✅ Alerta superpuesta creada');
    }

    // Inicializar notificaciones al cargar la página
    window.addEventListener('load', async () => {
      if ('serviceWorker' in navigator && 'Notification' in window) {
        await registrarServiceWorker();
        
        // Solicitar permisos automáticamente después de 2 segundos
        setTimeout(async () => {
          if (Notification.permission === 'default') {
            await solicitarPermisoNotificaciones();
          }
        }, 2000);
      }
      
      // Intentar mantener la pantalla activa (Wake Lock API)
      if ('wakeLock' in navigator) {
        try {
          const wakeLock = await navigator.wakeLock.request('screen');
          console.log('🔋 Wake Lock activado - pantalla se mantendrá activa');
          
          // Manejar cuando el usuario cambia de pestaña
          document.addEventListener('visibilitychange', async () => {
            if (wakeLock !== null && document.visibilityState === 'visible') {
              const newWakeLock = await navigator.wakeLock.request('screen');
              console.log('🔋 Wake Lock reactivado');
            }
          });
        } catch (err) {
          console.log('❌ No se pudo activar Wake Lock:', err);
        }
      }
      
      // Registrar eventos para mantener conexión activa y detectar cambios de pestaña
      let lastVisibilityCheck = Date.now();
      let wasHidden = false;
      
      document.addEventListener('visibilitychange', () => {
        const now = Date.now();
        const timeSinceLastCheck = now - lastVisibilityCheck;
        
        console.log('👁️ Cambio de visibilidad detectado:', {
          estado: document.visibilityState,
          tiempoOculto: wasHidden ? timeSinceLastCheck : 0,
          socketConectado: socket.connected
        });
        
        if (document.visibilityState === 'visible') {
          console.log('✅ Página ahora visible - verificando estado...');
          
          // Si estuvo oculta por más de 1 segundo, forzar reconexión
          if (wasHidden && timeSinceLastCheck > 1000) {
            console.log('🔄 Reconectando después de estar oculta...');
            
            // Forzar reconexión del socket
            if (socket.connected) {
              socket.disconnect();
            }
            socket.connect();
            
            // Re-registrar cliente después de un momento
            setTimeout(() => {
              console.log('📝 Re-registrando cliente después de reconexión...');
              socket.emit("registrar_cliente", { id: id });
              
              // Verificar estado actual del cliente
              fetch(`/verificar_estado_cliente/${id}`)
                .then(response => response.json())
                .then(data => {
                  console.log('📊 Estado actual del cliente:', data);
                  
                  // Si ya tiene mesa asignada, mostrar notificación
                  if (data.mesa_asignada && !notificationShown) {
                    console.log('🎉 Cliente ya tenía mesa asignada:', data.mesa_asignada);
                    lastKnownMesa = data.mesa_asignada;
                    notificationShown = true;
                    
                    mostrarNotificacionTurno(data.mesa_asignada);
                    iniciarCronometro(data.mesa_asignada_at);
                    
                    // Actualizar interfaz
                    const estadoEl = document.getElementById("estado");
                    estadoEl.className = "font-bold text-green-600 turno-activo-msg";
                    estadoEl.innerHTML = `¡Es tu turno{% if nombre %} {{ nombre }}{% endif %}!<br><span style="font-weight:600;">Ve a la mesa <span style="color:#1e3a8a;">${data.mesa_asignada}</span></span>`;
                    document.getElementById("actualmente").style.display = "none";
                    document.getElementById("atendiendo").style.display = "none";
                    document.getElementById("tu-numero").style.display = "none";
                    document.getElementById("bienvenida").style.display = "none";
                    document.getElementById("tiempo-espera-container").style.display = "none";
                  }
                })
                .catch(error => {
                  console.error('❌ Error verificando estado del cliente:', error);
                });
            }, 1000);
          } else if (!socket.connected) {
            console.log('🔌 Socket desconectado, reconectando...');
            socket.connect();
          }
          
          wasHidden = false;
        } else {
          console.log('👻 Página ahora oculta');
          wasHidden = true;
        }
        
        lastVisibilityCheck = now;
      });
      
      // También escuchar eventos de enfoque/desenfoque de la ventana
      window.addEventListener('focus', () => {
        console.log('🎯 Ventana enfocada - verificando conexión...');
        if (!socket.connected) {
          socket.connect();
        }
      });
      
      window.addEventListener('blur', () => {
        console.log('💭 Ventana desenfocada');
      });

      // Restaurar estado si ya había mesa asignada (evita re-creación tras refresh)
      try {
        if (mesaAsignadaInicial && mesaAsignadaAtInicial) {
          console.log('♻️ Restaurando estado de turno tras recarga:', mesaAsignadaInicial, mesaAsignadaAtInicial);
          // Actualizar interfaz a estado de turno activo
          const estadoEl = document.getElementById("estado");
          estadoEl.className = "font-bold text-green-600 turno-activo-msg";
          estadoEl.innerHTML = `¡Es tu turno{% if nombre %} {{ nombre }}{% endif %}!<br><span style="font-weight:600;">Ve a la mesa <span style="color:#1e3a8a;">${mesaAsignadaInicial}</span></span>`;
          document.getElementById("actualmente").style.display = "none";
          document.getElementById("atendiendo").style.display = "none";
          document.getElementById("tu-numero").style.display = "none";
          document.getElementById("bienvenida").style.display = "none";
          document.getElementById("tiempo-espera-container").style.display = "none";

          // Ocultar botón de cancelar turno cuando ya tiene mesa asignada
          const cancelarContainer = document.getElementById('cancelar-turno-container');
          if (cancelarContainer) {
            cancelarContainer.style.display = 'none';
          }
          
          // Agregar clase para indicar que tiene mesa
          document.body.classList.add('tiene-mesa');

          // Iniciar cronómetro desde timestamp absoluto proporcionado por el backend
          iniciarCronometro(mesaAsignadaAtInicial);
        }
      } catch (e) {
        console.error('Error restaurando estado tras refresh:', e);
      }
    });

    // ==================== FIN SISTEMA DE NOTIFICACIONES ====================

    // Función para mostrar/ocultar el popover
    function toggleInfoPopover() {
      const popover = document.getElementById("info-popover");
      popover.classList.toggle("hidden");
    }

    // Cerrar popover al hacer clic fuera de él
    document.addEventListener('click', function(event) {
      const popover = document.getElementById("info-popover");
      const tiempoEspera = document.getElementById("tiempo-espera");
      
      if (!popover.contains(event.target) && !tiempoEspera.contains(event.target)) {
        popover.classList.add("hidden");
      }
    });

    // ==================== CANCELAR TURNO ====================
    
    function confirmarCancelacion() {
      const confirmar = confirm(
        "¿Estás seguro de que quieres cancelar tu lugar en la fila?\n\n" +
        "Esta acción no se puede deshacer y tendrás que volver a hacer fila si cambias de opinión."
      );
      
      if (confirmar) {
        cancelarTurno();
      }
    }
    
    async function cancelarTurno() {
      try {
        // Deshabilitar el botón para evitar clics múltiples
        const btnCancelar = document.getElementById('btn-cancelar-turno');
        btnCancelar.disabled = true;
        btnCancelar.textContent = '⏳ Cancelando...';
        
        const response = await fetch(`/cancelar_turno/${id}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          }
        });
        
        const data = await response.json();
        
        if (data.success) {
          // Mostrar mensaje de confirmación
          alert('✅ Tu lugar en la fila ha sido cancelado exitosamente.\n\nGracias por visitarnos. ¡Esperamos verte pronto!');
          
          // Redirigir al landing page
          window.location.href = '/qr_landing';
        } else {
          // Mostrar error
          alert(`❌ Error al cancelar: ${data.error}`);
          
          // Restaurar el botón
          btnCancelar.disabled = false;
          btnCancelar.textContent = '❌ Cancelar mi turno';
        }
      } catch (error) {
        console.error('Error al cancelar turno:', error);
        alert('❌ Error de conexión. Por favor, intenta de nuevo.');
        
        // Restaurar el botón
        const btnCancelar = document.getElementById('btn-cancelar-turno');
        btnCancelar.disabled = false;
        btnCancelar.textContent = '❌ Cancelar mi turno';
      }
    }

    // ==================== FIN CANCELAR TURNO ====================

    // Cronómetro robusto (cálculo absoluto) similar a lógica de workers
    function iniciarCronometro(asignada_at = null){
      console.log('🕐 [CRONOMETRO] init con asignada_at=', asignada_at);
      if(!asignada_at){
        console.warn('⛔ [CRONOMETRO] sin timestamp, no se inicia');
        return;
      }
      const ts = new Date(asignada_at);
      if(isNaN(ts.getTime())){ console.error('❌ [CRONOMETRO] timestamp inválido'); return; }
      cronometroAsignacion = ts; // guardar referencia absoluta
      const cont = document.getElementById('cronometro-container');
      const disp = document.getElementById('cronometro-display');
      if(!cont || !disp){ console.error('❌ [CRONOMETRO] elementos no encontrados'); return; }
      cont.classList.remove('hidden');
      cont.style.display='block';
      cont.style.visibility='visible';
      // limpiar intervalo anterior
      if(window.cronometroInterval){ clearInterval(window.cronometroInterval); }
      const TOTAL = 600; // 10 min
      function tick(){
        if(!cronometroAsignacion){ clearInterval(window.cronometroInterval); return; }
        const ahora = new Date();
        const trans = Math.floor((ahora - cronometroAsignacion)/1000);
        const restante = Math.max(0, TOTAL - trans);
        const m = Math.floor(restante/60);
        const s = restante % 60;
        disp.textContent = `${m}:${s.toString().padStart(2,'0')}`;
        if(restante <= 120){
          disp.style.color = '#ef4444';
          disp.style.animation = 'pulse 1s infinite';
          disp.style.fontWeight = 'bold';
        } else if(restante <= 300){
          disp.style.color = '#f59e0b';
          disp.style.animation = '';
        } else {
          disp.style.color = '#22c55e';
          disp.style.animation = '';
        }
        if(restante % 5 === 0 || restante <= 10){
          document.title = `⏰ ${m}:${s.toString().padStart(2,'0')} - Restaurante Alleria`;
        }
        if(restante === 0){
          disp.textContent = '¡Tiempo agotado!';
          document.title = '⏰ ¡Tiempo agotado! - Restaurante Alleria';
          clearInterval(window.cronometroInterval);
        }
      }
      tick();
      window.cronometroInterval = setInterval(tick,1000);
      console.log('✅ [CRONOMETRO] iniciado');
    }

    // Función para obtener y actualizar el tiempo de espera promedio
    function actualizarTiempoEsperaPromedio() {
      fetch('/tiempo_espera_promedio')
        .then(response => response.json())
        .then(data => {
          const minutos = data.promedio_minutos;
          const elemento = document.getElementById("tiempo-promedio");
          
          if (minutos <= 5) {
            elemento.textContent = `${minutos} minutos ⚡`;
            elemento.style.color = "#22c55e"; // Verde
          } else if (minutos <= 15) {
            elemento.textContent = `${minutos} minutos ⏰`;
            elemento.style.color = "#f59e0b"; // Amarillo/Naranja
          } else {
            elemento.textContent = `${minutos} minutos ⏳`;
            elemento.style.color = "#ef4444"; // Rojo
          }
        })
        .catch(error => {
          console.error('Error obteniendo tiempo de espera:', error);
          document.getElementById("tiempo-promedio").textContent = "No disponible";
        });
    }

    socket.on("connect", () => {
      console.log('🔌 Socket conectado exitosamente');
      isConnected = true;
      socket.emit("registrar_cliente", { id: id });
      // Obtener tiempo de espera promedio al conectarse
      actualizarTiempoEsperaPromedio();
    });

    socket.on("disconnect", (reason) => {
      console.log('❌ Socket desconectado:', reason);
      isConnected = false;
      
      // Si la desconexión no fue intencional, intentar reconectar
      if (reason !== 'io client disconnect') {
        console.log('🔄 Intentando reconectar en 2 segundos...');
        setTimeout(() => {
          if (!socket.connected) {
            socket.connect();
          }
        }, 2000);
      }
    });

    socket.on("connect_error", (error) => {
      console.error('❌ Error de conexión del socket:', error);
      isConnected = false;
    });

    // Actualizar tiempo de espera cada 30 segundos
    setInterval(actualizarTiempoEsperaPromedio, 30000);

    // Sistema de heartbeat simplificado para mantener conexión activa
    let heartbeatInterval;
    
    function iniciarHeartbeat() {
      if (heartbeatInterval) {
        clearInterval(heartbeatInterval);
      }
      
      heartbeatInterval = setInterval(() => {
        if (socket.connected && document.visibilityState === 'visible') {
          console.log('💓 Enviando heartbeat...');
          socket.emit('heartbeat', { 
            cliente_id: id, 
            timestamp: Date.now(),
            page_visible: true
          });
        } else if (!socket.connected) {
          console.log('💔 Socket desconectado durante heartbeat, reconectando...');
          socket.connect();
        }
      }, 30000); // Cada 30 segundos (reducido de 15)
    }
    
    // Iniciar heartbeat cuando se conecte
    socket.on("connect", () => {
      iniciarHeartbeat();
    });
    
    // Detener heartbeat cuando se desconecte
    socket.on("disconnect", () => {
      if (heartbeatInterval) {
        clearInterval(heartbeatInterval);
      }
    });

    let isConnected = false;
    let lastKnownMesa = null;
    let notificationShown = false;
    
    socket.on("es_tu_turno", (data) => {
      console.log('🎉 === EVENTO ES_TU_TURNO RECIBIDO ===');
      console.log('📦 Data recibida:', data);
      console.log('🌐 Ubicación:', window.location.href);
      console.log('📱 Plataforma:', navigator.platform);
      console.log('👁️ Documento visible:', document.visibilityState);
      console.log('🔌 Socket conectado:', socket.connected);
      
      // Evitar procesar el mismo evento múltiples veces
      if (lastKnownMesa === data.mesa && notificationShown) {
        console.log('⚠️ Evento duplicado ignorado para mesa', data.mesa);
        return;
      }
      
      lastKnownMesa = data.mesa;
      notificationShown = true;
      
      try {
        // Actualizar elementos de la interfaz
        const estadoElement = document.getElementById("estado");
        const actualmenteElement = document.getElementById("actualmente");
        const atendiendoElement = document.getElementById("atendiendo");
        const tuNumeroElement = document.getElementById("tu-numero");
        const bienvenidaElement = document.getElementById("bienvenida");
        const tiempoEsperaElement = document.getElementById("tiempo-espera-container");
        
        console.log('🔍 Elementos encontrados:', {
          estado: !!estadoElement,
          actualmente: !!actualmenteElement,
          atendiendo: !!atendiendoElement,
          tuNumero: !!tuNumeroElement,
          bienvenida: !!bienvenidaElement,
          tiempoEspera: !!tiempoEsperaElement
        });
        
        if (estadoElement) {
          estadoElement.className = "font-bold text-green-600 turno-activo-msg";
          estadoElement.innerHTML = `¡Es tu turno{% if nombre %} {{ nombre }}{% endif %}!<br><span style="font-weight:600;">Ve a la mesa <span style=\"color:#1e3a8a;\">${data.mesa}</span></span>`;
          console.log('✅ Estado actualizado');
        }
        
        // Ocultar elementos no necesarios
        [actualmenteElement, atendiendoElement, tuNumeroElement, bienvenidaElement, tiempoEsperaElement].forEach((el, index) => {
          if (el) {
            el.style.display = "none";
            console.log(`✅ Elemento ${index + 1} ocultado`);
          }
        });
        
        // Ocultar botón de cancelar turno cuando se asigna mesa
        const cancelarContainer = document.getElementById('cancelar-turno-container');
        if (cancelarContainer) {
          cancelarContainer.style.display = 'none';
          console.log('✅ Botón de cancelar turno ocultado');
        }
        
        // Agregar clase para indicar que tiene mesa
        document.body.classList.add('tiene-mesa');
        
        // Mostrar notificación push con debugging
        console.log('🔔 Iniciando proceso de notificación...');
        mostrarNotificacionTurno(data.mesa);
        
        // Iniciar cronómetro con timestamp de asignación
        console.log('⏰ Iniciando proceso de cronómetro...');
        iniciarCronometro(data.asignada_at);
        
        console.log('✅ Proceso de turno completado exitosamente');
        
      } catch (error) {
        console.error('❌ Error procesando evento es_tu_turno:', error);
        console.error('📋 Stack trace:', error.stack);
      }
      
      console.log('🎉 === FIN EVENTO ES_TU_TURNO ===');
    });
    
    socket.on("actualizar_posicion",(data)=>{
      document.getElementById("atendiendo").innerText = Number(data.primero)-1;
    });

    // Actualizar tiempo de espera cuando hay cambios en la cola
    socket.on("actualizar_cola", () => {
      actualizarTiempoEsperaPromedio();
    });

    function mostrarTurnoEnPantalla(nombreCliente, mesa){
      const estado = document.getElementById('estado');
      if(!estado) return;
      document.body.classList.add('turno-activo');
      estado.innerHTML = `<span class="turno-mensaje">¡Es tu turno ${nombreCliente || ''}!<br><span class="turno-mesa">Ve a la mesa ${mesa}</span></span>`;
    }
  </script>
</body>
</html>
