{% extends "base.html" %}
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Clientes en Espera</title>
</head>
<body>
{% block content %}
  <div class="clientes-container">

    <div class="overflow-x-auto">
      <table class="clientes-table">
        <thead>
          <tr>
            <th class="text-xs sm:text-sm">ID</th>
            <th class="text-xs sm:text-sm">Nombre</th>
            <th class="text-xs sm:text-sm">Comensales</th>
            <th class="text-xs sm:text-sm">Llegada</th>
            <th class="text-xs sm:text-sm">Espera</th>
          </tr>
        </thead>
        <tbody id="clientes-lista">
          {% if not clientes %}
          <tr>
            <td colspan="3" class="px-6 py-4 text-center text-gray-500 font-medium">No hay clientes en espera</td>
          </tr>
          {% endif %}
          {% for c in clientes %}
          <tr>
            <td class="text-xs sm:text-sm whitespace-nowrap">#{{ c.id }}</td>
            <td class="text-xs sm:text-sm whitespace-nowrap">{{ c.nombre|truncate(10) }}</td>
            <td class="text-xs sm:text-sm text-center">{{ c.cantidad_comensales }}</td>
            <td class="text-xs sm:text-sm whitespace-nowrap">{{ c.joined_at.strftime('%H:%M') }}</td>
            <td class="text-xs sm:text-sm" id="wait-time-{{ c.id }}">
              <span class="waiting-time" data-joined="{{ c.joined_at.isoformat() }}">Calculando...</span>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
{% endblock %}
{% block scripts %}
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script>
      const socket = io();

      function formatTimeElapsed(seconds) {
        const hours = Math.floor(seconds / 3600);
        const minutes = Math.floor((seconds % 3600) / 60);
        const remainingSeconds = seconds % 60;

        if (hours > 0) {
          return `${hours}h ${minutes}m `;
        } else if (minutes > 0) {
          return `${minutes}m`;
        } else {
          return `${remainingSeconds}s`;
        }
      }

      function updateWaitingTimes() {
        document.querySelectorAll('.waiting-time').forEach(span => {
          const joinedTime = new Date(span.dataset.joined);
          const now = new Date();
          const secondsWaiting = Math.floor((now - joinedTime) / 1000);
          span.textContent = formatTimeElapsed(secondsWaiting);
        });
      }

      // Actualizar tiempos cada segundo
      setInterval(updateWaitingTimes, 1000);
      updateWaitingTimes(); // ActualizaciÃ³n inicial

      function actualizarListaClientes() {
        fetch('/clientes')
          .then(res => res.json())
          .then(data => {
            const tbody = document.querySelector('#clientes-lista');
            tbody.innerHTML = '';
            
            if (data.length === 0) {
              const tr = document.createElement('tr');
              tr.innerHTML = `
                <td colspan="3" class="px-6 py-4 text-center text-gray-500 font-medium">
                  No hay clientes en espera
                </td>
              `;
              tbody.appendChild(tr);
            } else {
              data.forEach(c => {
                console.log(c.joined_at);
                console.log(Date.parse(c.joined_at));
                const joinedDate = new Date(c.joined_at);
                const tr = document.createElement('tr');
                tr.className = 'border-b border-gray-200 hover:bg-gray-50';
                tr.innerHTML = `
                  <td class="text-xs sm:text-sm whitespace-nowrap">#${c.id}</td>
                  <td class="text-xs sm:text-sm whitespace-nowrap">${(c.nombre || 'Sin nombre').substring(0, 10)}</td>
                  <td class="text-xs sm:text-sm text-center">${c.cantidad_comensales || '-'}</td>
                  <td class="text-xs sm:text-sm whitespace-nowrap">${joinedDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</td>
                  <td class="text-xs sm:text-sm" id="wait-time-${c.id}">
                    <span class="waiting-time" data-joined="${c.joined_at}">Calculando...</span>
                  </td>
                `;
                tbody.appendChild(tr);
              });
              updateWaitingTimes();
            }
          });
      }

      // Escuchar eventos para actualizar la lista de clientes
      socket.on('actualizar_lista_clientes', actualizarListaClientes);
      socket.on('actualizar_cola', actualizarListaClientes);
    </script>
{% endblock %}
</body>
</html>