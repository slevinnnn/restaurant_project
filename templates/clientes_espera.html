{% extends "base.html" %}
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Clientes en Espera</title>
</head>
<body>
{% block content %}
  <div class="clientes-container">

    <!-- Tiempo de espera promedio -->
    <div id="promedio-espera" class="mb-4 p-3 rounded-lg border border-blue-200 bg-blue-50 text-blue-800 flex items-center gap-2">
      <span class="text-lg">‚è±Ô∏è</span>
      <div>
        <div class="font-semibold text-sm sm:text-base">Tiempo de espera promedio</div>
        <div class="text-sm sm:text-base"><span id="promedio-espera-valor">Calculando...</span></div>
      </div>
    </div>

    <div class="overflow-x-auto">
      <table class="clientes-table">
        <thead>
          <tr>
            <th class="text-xs sm:text-sm">ID</th>
            <th class="text-xs sm:text-sm">Nombre</th>
            <th class="text-xs sm:text-sm">Comensales</th>
            <th class="text-xs sm:text-sm">Acciones</th>
            <th class="text-xs sm:text-sm">Tel√©fono</th>
            <th class="text-xs sm:text-sm">Llegada</th>
            <th class="text-xs sm:text-sm">Espera</th>
          </tr>
        </thead>
        <tbody id="clientes-lista">
          {% if not clientes %}
          <tr>
            <td colspan="8" class="px-6 py-4 text-center text-gray-500 font-medium">
              <div class="text-center py-8">
                <p class="text-lg">üéâ No hay clientes en espera</p>
                <p class="text-sm">Todos los clientes han sido atendidos</p>
              </div>
            </td>
          </tr>
          {% endif %}
          {% for c in clientes %}
          <tr>
            <td class="text-xs sm:text-sm whitespace-nowrap">#{{ c.id }}</td>
            <td class="text-xs sm:text-sm whitespace-nowrap cursor-pointer" onclick="mostrarPopoverCliente({{ c.id }}, '{{ c.nombre }}', '{{ c.telefono }}', {{ c.cantidad_comensales }})">
              {{ c.nombre|truncate(15) }}
              {% if c.en_camino %}
                <span title="En camino" class="ml-1">üö∂‚Äç‚ôÇÔ∏è</span>
              {% endif %}
            </td>
            <td class="text-xs sm:text-sm text-center">{{ c.cantidad_comensales }}</td>
            <td class="text-xs sm:text-sm">
              {% if loop.index <= 3 %}
                <!-- Solo los primeros 3 clientes pueden ser asignados -->
                <button onclick="iniciarAsignacionManual({{ c.id }}, '{{ c.nombre }}', {{ c.cantidad_comensales }})" 
                        class="bg-green-500 hover:bg-green-600 text-white px-2 py-1 rounded text-xs">
                  üè† Asignar
                </button>
              {% else %}
                <!-- Otros clientes muestran su posici√≥n en la fila -->
                <span class="bg-gray-300 text-gray-600 px-2 py-1 rounded text-xs">
                  #{{ loop.index }} en fila
                </span>
              {% endif %}
            </td>
            <td class="text-xs sm:text-sm whitespace-nowrap">
              {% if c.telefono %}
                <button onclick="llamarCliente('{{ c.telefono }}')" class="text-blue-600 hover:text-blue-800" title="Llamar">
                  üìû {{ c.telefono[-8:] }}
                </button>
              {% else %}
                <span class="text-gray-400">Sin tel√©fono</span>
              {% endif %}
            </td>
            <td class="text-xs sm:text-sm whitespace-nowrap">{{ c.joined_at.strftime('%H:%M') }}</td>
            <td class="text-xs sm:text-sm" id="wait-time-{{ c.id }}">
              <span class="waiting-time" data-joined="{{ c.joined_at.isoformat() }}">Calculando...</span>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- Modal para asignaci√≥n manual -->
  <div id="modal-asignacion" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
    <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
      <h3 class="text-lg font-bold mb-4">Asignar Cliente a Mesas</h3>
      <div id="info-cliente-modal" class="mb-4 p-3 bg-blue-50 rounded">
        <!-- Info del cliente se llenar√° din√°micamente -->
      </div>
      
      <div class="mb-4">
        <h4 class="font-semibold mb-2">Selecciona las mesas:</h4>
        <div id="selector-mesas" class="grid grid-cols-4 gap-2">
          <!-- Mesas disponibles se llenar√°n din√°micamente -->
        </div>
        <div id="capacidad-seleccionada" class="mt-2 text-sm text-gray-600">
          Capacidad seleccionada: <span id="capacidad-total">0</span> personas
        </div>
      </div>
      
      <div class="flex gap-2 justify-end">
        <button onclick="cerrarModalAsignacion()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded">
          Cancelar
        </button>
        <button onclick="confirmarAsignacion()" id="btn-confirmar" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded" disabled>
          Asignar
        </button>
      </div>
    </div>
  </div>
{% endblock %}
{% block scripts %}
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script>
      const socket = io();
      // === Promedio de espera (igual que ve el cliente) ===
      function cargarPromedioEspera() {
        fetch('/tiempo_espera_promedio')
          .then(r => r.json())
          .then(data => {
            const el = document.getElementById('promedio-espera-valor');
            if (!el) return;
            const seg = Number(data.promedio_segundos || 0);
            const min = Math.round(seg / 60);
            if (min <= 1) {
              // Mostrar en segundos si es <= 60s para mayor precisi√≥n
              el.textContent = seg < 60 ? `${seg}s` : `${min} min`;
            } else {
              el.textContent = `${min} min`;
            }
          })
          .catch(() => {
            const el = document.getElementById('promedio-espera-valor');
            if (el) el.textContent = '‚Äî';
          });
      }

      // Cargar al inicio y refrescar cada 30s
      cargarPromedioEspera();
      setInterval(cargarPromedioEspera, 30000);


      // Variables para gesti√≥n de cola
      let clienteSeleccionado = null;
      let mesasSeleccionadas = [];

      function formatTimeElapsed(seconds) {
        const hours = Math.floor(seconds / 3600);
        const minutes = Math.floor((seconds % 3600) / 60);
        const remainingSeconds = seconds % 60;

        if (hours > 0) {
          return `${hours}h ${minutes}m `;
        } else if (minutes > 0) {
          return `${minutes}m`;
        } else {
          return `${remainingSeconds}s`;
        }
      }

      function updateWaitingTimes() {
        document.querySelectorAll('.waiting-time').forEach(span => {
          const joinedTime = new Date(span.dataset.joined);
          const now = new Date();
          const secondsWaiting = Math.floor((now - joinedTime) / 1000);
          span.textContent = formatTimeElapsed(secondsWaiting);
        });
      }

      // Actualizar tiempos cada segundo
      setInterval(updateWaitingTimes, 1000);
      updateWaitingTimes(); // Actualizaci√≥n inicial

      // Funci√≥n para llamar al cliente
      function llamarCliente(telefono) {
        if (telefono) {
          window.open(`tel:${telefono}`, '_self');
        }
      }

      // Funci√≥n para mostrar popover con informaci√≥n del cliente
      function mostrarPopoverCliente(clienteId, nombre, telefono, comensales) {
        const mensaje = `Cliente: ${nombre}\nTel√©fono: ${telefono || 'Sin tel√©fono'}\nComensales: ${comensales}`;
        if (confirm(`${mensaje}\n\n¬øDeseas llamar a este cliente?`)) {
          llamarCliente(telefono);
        }
      }

      // Funci√≥n para iniciar asignaci√≥n manual
      function iniciarAsignacionManual(clienteId, clienteNombre, cantidadComensales) {
        clienteSeleccionado = {
          id: clienteId,
          nombre: clienteNombre,
          comensales: cantidadComensales
        };
        
        // Mostrar informaci√≥n del cliente
        document.getElementById('info-cliente-modal').innerHTML = `
          <strong>${clienteNombre}</strong><br>
          <span class="text-sm">üë• ${cantidadComensales} comensales</span>
        `;
        
        // Cargar mesas disponibles
        cargarMesasDisponibles();
        
        // Mostrar modal
        document.getElementById('modal-asignacion').classList.remove('hidden');
      }
      
      function cargarMesasDisponibles() {
        fetch('/trabajador')
          .then(response => response.text())
          .then(html => {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const mesas = doc.querySelectorAll('.mesa');
            
            const selectorMesas = document.getElementById('selector-mesas');
            selectorMesas.innerHTML = '';
            
            mesas.forEach(mesa => {
              const mesaId = mesa.dataset.mesaId;
              const estado = mesa.dataset.estado;
              const capacidad = mesa.dataset.capacidad;
              
              if (estado === 'libre' || estado === 'reservada') {
                const botonMesa = document.createElement('button');
                botonMesa.className = 'mesa-selector p-2 border rounded text-xs hover:bg-blue-100';
                botonMesa.innerHTML = `Mesa ${mesaId}<br><span class="text-xs">üë• ${capacidad}p</span>`;
                botonMesa.dataset.mesaId = mesaId;
                botonMesa.dataset.capacidad = capacidad;
                botonMesa.onclick = () => toggleMesaSeleccion(mesaId, capacidad, botonMesa);
                
                selectorMesas.appendChild(botonMesa);
              }
            });
          });
      }
      
      function toggleMesaSeleccion(mesaId, capacidad, botonElement) {
        const index = mesasSeleccionadas.findIndex(m => m.id === mesaId);
        
        if (index === -1) {
          // Agregar mesa
          mesasSeleccionadas.push({ id: mesaId, capacidad: parseInt(capacidad) });
          botonElement.classList.add('bg-blue-500', 'text-white');
        } else {
          // Quitar mesa
          mesasSeleccionadas.splice(index, 1);
          botonElement.classList.remove('bg-blue-500', 'text-white');
        }
        
        // Actualizar capacidad total
        const capacidadTotal = mesasSeleccionadas.reduce((sum, mesa) => sum + mesa.capacidad, 0);
        document.getElementById('capacidad-total').textContent = capacidadTotal;
        
        // Habilitar/deshabilitar bot√≥n de confirmar
        const btnConfirmar = document.getElementById('btn-confirmar');
        if (capacidadTotal >= clienteSeleccionado.comensales && mesasSeleccionadas.length > 0) {
          btnConfirmar.disabled = false;
          btnConfirmar.classList.remove('opacity-50');
        } else {
          btnConfirmar.disabled = true;
          btnConfirmar.classList.add('opacity-50');
        }
      }
      
      function confirmarAsignacion() {
        if (!clienteSeleccionado || mesasSeleccionadas.length === 0) {
          return;
        }
        
        const mesasIds = mesasSeleccionadas.map(m => m.id);
        
        fetch('/asignar_cliente_a_mesas', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            cliente_id: clienteSeleccionado.id,
            mesas_ids: mesasIds
          })
        })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            alert(`Cliente ${data.cliente_nombre} asignado exitosamente a las mesas: ${data.mesas_totales.join(', ')}`);
            cerrarModalAsignacion();
            actualizarListaClientes(); // Actualizar la lista sin recargar
          } else {
            alert(`Error: ${data.error}`);
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('Error al asignar cliente');
        });
      }
      
      function cerrarModalAsignacion() {
        document.getElementById('modal-asignacion').classList.add('hidden');
        clienteSeleccionado = null;
        mesasSeleccionadas = [];
        
        // Limpiar selecciones
        document.querySelectorAll('.mesa-selector').forEach(btn => {
          btn.classList.remove('bg-blue-500', 'text-white');
        });
        document.getElementById('capacidad-total').textContent = '0';
      }

      function actualizarListaClientes() {
        fetch('/clientes')
          .then(res => res.json())
          .then(data => {
            // Actualizar tabla
            const tbody = document.querySelector('#clientes-lista');
            tbody.innerHTML = '';
            
            if (data.length === 0) {
              const tr = document.createElement('tr');
              tr.innerHTML = `
                <td colspan="8" class="px-6 py-4 text-center text-gray-500 font-medium">
                  <div class="text-center py-8">
                    <p class="text-lg">üéâ No hay clientes en espera</p>
                    <p class="text-sm">Todos los clientes han sido atendidos</p>
                  </div>
                </td>
              `;
              tbody.appendChild(tr);
            } else {
              data.forEach((c, index) => {
                const joinedDate = new Date(c.joined_at);
                
                // Permitir asignar manualmente a los primeros 3 clientes en la fila
                const isTopThree = index < 3;
                const actionCell = isTopThree
                  ? `<button onclick="iniciarAsignacionManual(${c.id}, '${c.nombre}', ${c.cantidad_comensales})" 
                            class="bg-green-500 hover:bg-green-600 text-white px-2 py-1 rounded text-xs">
                      üè† Asignar
                    </button>`
                  : `<span class="bg-gray-300 text-gray-600 px-2 py-1 rounded text-xs">
                      #${index + 1} en fila
                    </span>`;
                
                // Celda de tel√©fono
                const telefonoCell = c.telefono 
                  ? `<button onclick="llamarCliente('${c.telefono}')" class="text-blue-600 hover:text-blue-800" title="Llamar">
                      üìû ${c.telefono.slice(-8)}
                    </button>`
                  : `<span class="text-gray-400">Sin tel√©fono</span>`;

                const tr = document.createElement('tr');
                tr.className = 'border-b border-gray-200 hover:bg-gray-50';
                tr.innerHTML = `
                  <td class="text-xs sm:text-sm whitespace-nowrap">#${c.id}</td>
                  <td class="text-xs sm:text-sm whitespace-nowrap cursor-pointer" onclick="mostrarPopoverCliente(${c.id}, '${c.nombre}', '${c.telefono || ''}', ${c.cantidad_comensales})">${(c.nombre || 'Sin nombre').substring(0, 15)}${c.en_camino ? ' <span title="En camino" class="ml-1">üö∂‚Äç‚ôÇÔ∏è</span>' : ''}</td>
                  <td class="text-xs sm:text-sm text-center">${c.cantidad_comensales || '-'}</td>
                  <td class="text-xs sm:text-sm">${actionCell}</td>
                  <td class="text-xs sm:text-sm whitespace-nowrap">${telefonoCell}</td>
                  <td class="text-xs sm:text-sm whitespace-nowrap">${joinedDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</td>
                  <td class="text-xs sm:text-sm" id="wait-time-${c.id}">
                    <span class="waiting-time" data-joined="${c.joined_at}">Calculando...</span>
                  </td>
                `;
                tbody.appendChild(tr);
              });
            }
            
            // Reiniciar temporizadores para mostrar tiempo de espera
            updateWaitingTimes();
          })
          .catch(error => {
            console.error('Error al actualizar lista de clientes:', error);
          });
      }

      // Escuchar eventos para actualizar la lista de clientes
      socket.on('actualizar_lista_clientes', actualizarListaClientes);
      socket.on('actualizar_cola', actualizarListaClientes);
      // Tambi√©n refrescar el promedio cuando cambia la cola
      socket.on('actualizar_cola', cargarPromedioEspera);
    </script>
{% endblock %}
</body>
</html>